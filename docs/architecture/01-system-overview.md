# 智策股析 - 系统架构总览

## 项目概述

**智策股析** 是一个面向个人投资者的多用户Web应用，通过集成先进的大语言模型（LLM）能力，为用户提供每日、深入、自动化的港股及美股分析报告。

## 核心特性

- **无密码认证**：通过邮箱验证码实现快速登录注册
- **个性化分析**：用户可自定义关注最多20支股票
- **多模型支持**：可扩展的LLM架构（Gemini、Qwen、ChatGPT等）
- **异步处理**：Celery任务队列保证系统响应速度
- **试用付费模式**：新用户免费试用，后续订阅或按次付费

## 整体架构层次

```
┌─────────────────────────────────────────────────────────────┐
│                        用户层                                │
│  个人投资者 │ 管理员 │ 邮件客户端                           │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                       前端层                                 │
│  Web前端(React/Vue) │ 管理员后台                            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                      API层                                   │
│  Flask REST API │ 身份认证中间件                            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    业务逻辑层                                │
│  用户服务│股票池服务│分析服务│报告服务│支付服务│邮件服务│管理服务 │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   异步任务层                                 │
│  Celery Worker │ Redis Broker │ 定时任务调度器              │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                  LLM集成层                                   │
│  LLM Factory │ Gemini Provider │ Qwen Provider │ OpenAI Provider │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                   数据存储层                                 │
│  PostgreSQL/SQLite │ 文件系统(JSON) │ Redis Cache            │
└─────────────────────────────────────────────────────────────┘
┌─────────────────────────────────────────────────────────────┐
│                    外部服务                                  │
│  金融数据API │ 邮件服务 │ 支付网关 │ LLM APIs                │
└─────────────────────────────────────────────────────────────┘
```

## 关键设计原则

### 1. 异步优先
- 所有耗时操作（LLM调用、数据获取、邮件发送）都通过异步任务队列处理
- 前端API响应快速，任务状态可追踪

### 2. 可扩展架构
- LLM集成采用策略模式，支持多种模型动态切换
- 模块化设计，便于功能扩展

### 3. 混合存储
- 结构化数据存储在数据库
- 分析报告以JSON文件形式存储，便于导出和备份

### 4. 权限分层
- 试用、免费、付费用户的功能分级
- 管理员与普通用户权限隔离

### 5. 监控可观测
- 完整的任务状态跟踪
- 失败重试机制
- 系统指标监控

## 技术栈选择

### 后端
- **Framework**: Flask (轻量级，易扩展)
- **Task Queue**: Celery + Redis
- **Database**: SQLite(开发) / PostgreSQL(生产)
- **Cache**: Redis

### 前端
- **Framework**: React/Vue (现代化SPA)
- **Build Tool**: Next.js/Nuxt.js
- **UI Library**: 现代化组件库

### 基础设施
- **Load Balancer**: Nginx
- **Container**: Docker
- **Monitoring**: Prometheus + Grafana
- **Logging**: ELK Stack

### 外部服务
- **Email**: SendGrid/Mailgun
- **Payment**: Stripe/Paddle
- **LLM**: OpenAI/Gemini/Qwen
- **Finance Data**: Alpha Vantage/Finnhub

## 开发里程碑

### 第一阶段: MVP核心功能验证
- 无密码邮箱验证码登录系统
- 股票池和用户关注列表功能
- 单次试用逻辑
- 异步分析任务基础架构
- 基本报告渲染页面

### 第二阶段: 付费模式与后台完善
- 支付网关集成
- 订阅和按次付费逻辑
- 完整管理员后台
- 任务状态跟踪和失败重试

### 第三阶段: 体验优化与功能扩展
- 邮件订阅系统
- 报告导出功能
- 多LLM模型集成
- UI/UX优化

### 第四阶段: 部署与迭代
- 生产环境部署
- 压力测试
- 用户反馈迭代

---

*此文档记录了智策股析项目的整体架构设计，为后续详细设计和开发提供指导。*
