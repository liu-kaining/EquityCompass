# 智策股析 - 子系统设计详解

## 1. 用户认证系统

### 1.1 系统概述
实现无密码的邮箱验证码登录机制，简化用户体验，统一注册和登录流程。

### 1.2 核心组件

#### 前端组件
- **登录/注册页面**: 统一入口，只需输入邮箱
- **验证码输入界面**: 6位数字验证码输入
- **会话状态管理**: JWT Token本地存储

#### 后端服务
- **认证服务**: 处理邮箱验证和用户管理
- **邮件服务**: 发送验证码邮件
- **会话管理**: JWT Token生成和验证
- **验证码生成器**: 6位随机数字生成
- **验证码验证器**: 验证码校验和过期检查

#### 数据存储
- **用户表**: 存储用户基本信息
- **验证码缓存**: Redis存储，10分钟TTL
- **会话存储**: JWT Token无状态验证

### 1.3 关键流程
1. 用户输入邮箱 → 系统检查是否存在 → 不存在则自动创建
2. 生成6位验证码 → 存入Redis → 发送邮件
3. 用户输入验证码 → 验证通过 → 生成JWT → 登录成功

### 1.4 安全措施
- 验证码10分钟自动过期
- 同一邮箱限制发送频率（1分钟内最多1次）
- JWT Token包含用户ID和过期时间
- 密码哈希存储（管理员账户）

---

## 2. 股票池管理系统

### 2.1 系统概述
管理内置股票池和用户自定义股票，支持用户创建个人关注列表。

### 2.2 核心组件

#### 前端组件
- **股票列表页面**: 展示可选股票
- **关注列表管理**: 用户个人关注列表（最多20支）
- **自定义股票添加**: 支持用户添加新股票
- **股票搜索**: 按名称、代码、行业搜索

#### 后端服务
- **股票池服务**: 管理内置股票数据
- **关注列表服务**: 用户关注列表CRUD
- **股票验证服务**: 验证用户添加的股票信息

#### 数据结构
```json
{
  "code": "AAPL",
  "name": "苹果公司", 
  "market": "US",
  "exchange": "NASDAQ",
  "industry": "Technology",
  "stock_type": "BUILT_IN"
}
```

### 2.3 内置股票池
- **美股市值TOP 100**: 管理员维护
- **港股市值TOP 100**: 管理员维护
- 包含公司名称、股票代码、交易所、行业分类

### 2.4 用户自定义股票
- 用户可添加内置池之外的股票
- 需提供：市场类型、公司名称、股票代码
- 系统进行去重校验

---

## 3. AI分析引擎系统

### 3.1 系统概述
核心分析引擎，负责调用LLM模型生成股票分析报告，支持多模型和异步处理。

### 3.2 任务调度层

#### 定时调度器
- 每日凌晨4点自动触发
- 扫描所有用户关注列表
- 生成去重的股票分析清单

#### 任务分发器  
- 为每支股票创建独立分析任务
- 提交到Celery队列
- 记录任务初始状态

### 3.3 分析执行层

#### 分析Worker
- 从队列获取任务
- 更新任务状态为PROCESSING
- 构建分析请求
- 调用LLM服务
- 处理分析结果

#### Prompt管理器
- 从数据库加载Prompt模板
- 支持变量替换：`${股票代码}`、`${公司名称}`等
- 支持多种模板：技术分析、基本面分析、综合分析

#### LLM路由器
- 根据配置选择LLM模型
- 负载均衡和故障转移
- 统一调用接口

### 3.4 LLM Provider层（策略模式）

#### BaseLLMProvider（抽象基类）
```python
class BaseLLMProvider:
    def generate_analysis(self, prompt: str) -> str:
        raise NotImplementedError
```

#### 具体Provider实现
- **GeminiProvider**: Google Gemini API集成
- **QwenProvider**: 阿里云通义千问API集成  
- **OpenAIProvider**: OpenAI ChatGPT API集成

### 3.5 结果处理层

#### 结果处理器
- 验证LLM返回结果格式
- 提取分析内容和摘要
- 错误处理和重试逻辑

#### 报告生成器
- 构建标准JSON报告格式
- 添加元数据（分析日期、模型版本等）
- Markdown格式内容处理

#### 文件写入器
- 按日期组织文件目录结构
- 原子性写入操作
- 文件权限和备份

### 3.6 状态管理与重试

#### 任务状态
- **PENDING**: 等待处理
- **PROCESSING**: 正在处理  
- **SUCCESS**: 成功完成
- **FAILED**: 最终失败

#### 重试机制
- 最多重试3次
- 指数退避策略：1s, 2s, 4s
- 记录失败原因

---

## 4. 报告管理系统

### 4.1 系统概述
负责报告的查询、展示、筛选和导出功能。

### 4.2 前端界面
- **报告列表页**: 展示用户关注股票的最新报告
- **报告详情页**: 完整报告内容展示，支持Markdown渲染
- **筛选界面**: 按日期、公司、行业筛选
- **导出界面**: 单个/批量导出功能

### 4.3 查询服务

#### 报告服务
- 基础CRUD操作
- 权限验证（用户只能看自己的报告）
- 缓存优化

#### 搜索引擎
- 全文搜索支持
- 多维度索引
- 结果排序和分页

#### 筛选引擎
- **按日期筛选**: 选择特定日期范围
- **按公司筛选**: 搜索公司名称或股票代码
- **按行业筛选**: 行业分类标签

### 4.4 导出服务

#### 导出格式
- **Markdown导出**: 原始格式导出
- **PDF导出**: 美化后的PDF文件
- **ZIP打包**: 批量导出打包

#### 导出流程
1. 用户选择报告和格式
2. 后台异步生成文件
3. 提供下载链接
4. 定期清理临时文件

---

## 5. 订阅付费系统

### 5.1 系统概述
管理用户计划、权限控制和支付处理。

### 5.2 用户计划管理

#### 计划类型
- **试用计划**: 新用户1次免费完整分析
- **免费计划**: 每日最多分析1支股票
- **订阅计划**: 月付/年付无限制
- **按次付费**: 购买分析次数包

#### 权限控制
- **权限网关**: 所有分析请求前置检查
- **额度管理**: 实时扣减和补充
- **功能门控**: 不同计划的功能限制

### 5.3 支付处理

#### 支付服务
- 集成Stripe/Paddle支付网关
- 支持订阅和一次性付费
- 处理支付成功/失败回调

#### 订阅管理
- 自动续费处理
- 订阅升级/降级
- 退款和取消处理

#### 账单管理
- 生成用户账单
- 支付历史记录
- 发票生成和发送

### 5.4 前端界面
- **定价页面**: 清晰的计划对比
- **账单管理页面**: 用户账单历史
- **支付流程**: 无缝支付体验

---

## 6. 邮件订阅系统

### 6.1 系统概述
为订阅用户发送每日分析报告摘要邮件。

### 6.2 核心功能
- **订阅开关**: 用户可控制是否接收邮件
- **邮件模板**: 专业的HTML邮件模板
- **摘要生成**: 从完整报告提取关键信息
- **链接跳转**: 引导用户回到网站查看详情

### 6.3 发送流程
1. 每日分析任务完成后触发
2. 获取所有订阅用户列表
3. 为每个用户生成个性化邮件内容
4. 异步发送邮件
5. 记录发送状态

### 6.4 邮件内容结构
- **标题**: 【智策股析】您关注的股票本日分析报告已生成 (YYYY-MM-DD)
- **摘要**: 每支关注股票的核心观点
- **CTA按钮**: "查看完整报告"链接

---

## 7. 管理员后台系统

### 7.1 系统概述
为管理员提供全面的系统管理功能。

### 7.2 核心功能

#### 用户管理
- 查看所有注册用户
- 用户禁用/启用操作
- 用户计划调整
- 用户使用统计

#### 股票池管理
- 内置股票池的增删改查
- 批量导入股票数据
- 股票信息验证

#### Prompt管理
- 创建和编辑Prompt模板
- 版本控制和回滚
- 设置默认使用模板
- A/B测试支持

#### 任务监控
- 实时任务状态监控
- 失败任务告警
- 系统性能指标
- 日志查看和分析

### 7.3 权限控制
- 独立的管理员登录系统
- 角色分级（超级管理员/普通管理员）
- 操作日志记录
- 敏感操作二次确认

---

*此文档详细描述了智策股析项目的各个子系统设计，为具体实现提供技术指导。*
