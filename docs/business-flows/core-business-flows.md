# 智策股析 - 核心业务流程

## 流程概述

本文档详细描述智策股析系统的核心业务流程，包括用户认证、分析任务执行、订阅付费等关键业务场景的完整流程设计。

---

## 1. 用户注册登录流程

### 1.1 流程概述
实现无密码的邮箱验证码登录，统一新用户注册和老用户登录的体验。

### 1.2 详细流程

#### 参与者
- **用户**: 个人投资者
- **前端应用**: Web界面
- **认证服务**: 后端认证逻辑
- **邮件服务**: 验证码发送
- **数据库**: 用户信息存储
- **Redis缓存**: 验证码临时存储

#### 流程步骤

```
1. 用户访问登录页面
   ↓
2. 输入邮箱地址，点击"登录/注册"
   ↓
3. 前端验证邮箱格式，发送请求到后端
   ↓
4. 认证服务检查邮箱是否存在
   ├─ 不存在：自动创建新用户记录
   └─ 存在：继续流程
   ↓
5. 生成6位随机数字验证码
   ↓
6. 将验证码存入Redis (TTL: 10分钟)
   ↓
7. 调用邮件服务发送验证码
   ↓
8. 用户收到邮件，输入验证码
   ↓
9. 前端提交验证码到后端验证
   ↓
10. 验证码校验
    ├─ 正确：生成JWT Token，返回用户信息
    └─ 错误：返回错误信息，可重新发送
    ↓
11. 前端存储Token，跳转到主页面
```

### 1.3 异常处理

#### 邮件发送失败
```
邮件服务异常
   ↓
记录错误日志
   ↓
返回用户友好错误信息
   ↓
允许用户重试发送
```

#### 验证码过期
```
用户输入过期验证码
   ↓
提示"验证码已过期"
   ↓
提供"重新发送"按钮
   ↓
清理Redis中的过期记录
```

#### 频繁请求保护
```
检查同一邮箱发送频率
   ↓
1分钟内最多发送1次
   ↓
超出限制时返回"请稍后再试"
   ↓
记录可疑活动日志
```

---

## 2. 每日分析任务执行流程

### 2.1 流程概述
系统每日自动执行股票分析任务，为用户生成个性化的分析报告。

### 2.2 详细流程

#### 参与者
- **定时调度器**: Cron/Celery Beat
- **任务分发器**: 任务创建和分配
- **Celery队列**: 异步任务队列
- **分析Worker**: 执行分析的工作进程
- **LLM服务**: 大语言模型API
- **文件系统**: 报告存储
- **数据库**: 任务状态管理
- **邮件服务**: 报告推送

#### 主流程

```
每日凌晨4点 (美股收盘后)
   ↓
1. 定时调度器触发每日分析任务
   ↓
2. 任务分发器获取所有用户关注列表
   ↓
3. 合并所有关注股票，生成去重清单
   ↓
4. 为每支股票创建独立分析任务
   ├─ 创建任务记录 (状态: PENDING)
   ├─ 分配唯一任务ID
   └─ 提交到Celery队列
   ↓
5. Celery Worker从队列获取任务
   ↓
6. 更新任务状态为PROCESSING
   ↓
7. 获取当前激活的Prompt模板
   ↓
8. 调用金融数据API获取股票信息
   ↓
9. 构建LLM分析请求
   ├─ 替换Prompt变量 (股票代码、公司名等)
   ├─ 选择LLM模型 (Gemini/Qwen/OpenAI)
   └─ 发送分析请求
   ↓
10. LLM返回分析结果
    ├─ 成功：继续处理
    └─ 失败：进入重试流程
    ↓
11. 处理和验证分析结果
    ├─ 提取核心内容
    ├─ 生成报告摘要
    └─ 格式化为标准JSON
    ↓
12. 保存报告到文件系统
    ├─ 按日期创建目录
    ├─ 以股票代码命名文件
    └─ 原子性写入操作
    ↓
13. 更新数据库记录
    ├─ 任务状态: SUCCESS
    ├─ 完成时间戳
    └─ 报告索引记录
    ↓
14. 所有股票分析完成后，触发邮件推送
```

#### 重试机制流程

```
LLM API调用失败
   ↓
记录失败原因和时间戳
   ↓
检查当前重试次数
   ├─ < 3次：进入重试队列
   └─ >= 3次：标记最终失败
   ↓
指数退避策略等待
   ├─ 第1次重试：等待1秒
   ├─ 第2次重试：等待2秒
   └─ 第3次重试：等待4秒
   ↓
重新尝试分析任务
   ├─ 成功：正常完成流程
   └─ 失败：继续重试或最终失败
   ↓
最终失败时发送告警通知
```

### 2.3 邮件推送流程

```
所有分析任务完成
   ↓
查询开启邮件订阅的用户
   ↓
为每个用户生成个性化邮件内容
   ├─ 获取用户关注列表
   ├─ 匹配对应的分析报告
   ├─ 提取报告摘要信息
   └─ 生成邮件HTML内容
   ↓
发送每日分析摘要邮件
   ├─ 标题：【智策股析】您关注的股票本日分析报告已生成
   ├─ 内容：各股票核心观点摘要
   └─ CTA：查看完整报告按钮
   ↓
记录邮件发送状态
   ├─ 成功：更新最后发送时间
   └─ 失败：记录失败日志，稍后重试
```

---

## 3. 用户订阅付费流程

### 3.1 流程概述
管理用户从试用到付费的完整生命周期，支持订阅和按次付费两种模式。

### 3.2 新用户试用流程

#### 参与者
- **新用户**: 刚注册的用户
- **前端应用**: 用户界面
- **用户服务**: 用户状态管理
- **分析服务**: 分析权限控制
- **数据库**: 用户计划存储

#### 流程步骤

```
用户完成邮箱验证注册
   ↓
1. 系统自动为用户创建试用计划
   ├─ 计划类型：TRIAL
   ├─ 分析额度：1次
   ├─ 有效期：注册后7天
   └─ 状态：激活
   ↓
2. 引导用户设置关注列表
   ├─ 从内置股票池选择
   ├─ 最多选择20支股票
   └─ 可添加自定义股票
   ↓
3. 用户点击"开始分析"
   ↓
4. 系统检查用户权限
   ├─ 验证试用额度 (1次)
   ├─ 检查计划有效期
   └─ 权限验证通过
   ↓
5. 触发一次性完整分析任务
   ├─ 为所有关注股票创建分析任务
   ├─ 使用最优质的LLM模型
   └─ 生成完整详细报告
   ↓
6. 扣减试用额度 (1 → 0)
   ↓
7. 分析完成后展示结果
   ├─ 显示所有股票分析报告
   ├─ 支持查看详情和导出
   └─ 突出展示产品价值
   ↓
8. 引导用户选择付费计划
   ├─ 展示试用额度已用完
   ├─ 推荐合适的付费计划
   └─ 提供升级优惠
```

### 3.3 付费订阅流程

#### 参与者
- **用户**: 需要升级的用户
- **前端应用**: 付费界面
- **支付服务**: 支付处理
- **支付网关**: Stripe/Paddle
- **数据库**: 交易和订阅记录

#### 流程步骤

```
用户选择付费计划
   ↓
1. 展示定价页面
   ├─ 月度订阅：$29.99/月
   ├─ 年度订阅：$299.99/年 (优惠17%)
   └─ 按次付费：$2.99/次分析
   ↓
2. 用户选择订阅计划
   ↓
3. 前端发送支付会话创建请求
   ↓
4. 支付服务调用Stripe/Paddle API
   ├─ 创建支付会话
   ├─ 设置成功/取消回调URL
   └─ 返回支付页面URL
   ↓
5. 跳转到第三方支付页面
   ├─ 用户填写支付信息
   ├─ 确认订阅条款
   └─ 完成支付操作
   ↓
6. 支付网关处理支付
   ├─ 验证支付信息
   ├─ 执行扣款操作
   └─ 返回支付结果
   ↓
7. 支付成功后回调Webhook
   ↓
8. 支付服务处理回调
   ├─ 验证回调签名
   ├─ 解析支付结果
   └─ 更新用户状态
   ↓
9. 更新用户订阅状态
   ├─ 计划类型：SUBSCRIPTION
   ├─ 分析额度：无限制 (-1)
   ├─ 有效期：根据订阅周期设置
   └─ 状态：激活
   ↓
10. 记录支付交易
    ├─ 交易ID
    ├─ 支付金额
    ├─ 支付时间
    └─ 支付状态
    ↓
11. 发送确认邮件
    ├─ 订阅成功通知
    ├─ 发票信息
    └─ 服务使用指南
    ↓
12. 用户重定向到成功页面
    ├─ 显示订阅激活信息
    ├─ 引导开始使用服务
    └─ 提供客服联系方式
```

### 3.4 按次付费流程

```
用户选择按次付费
   ↓
1. 选择次数包
   ├─ 10次分析包：$19.99
   ├─ 50次分析包：$79.99
   └─ 100次分析包：$149.99
   ↓
2. 完成一次性支付
   ↓
3. 系统增加用户分析额度
   ├─ 更新remaining_quota字段
   ├─ 记录购买记录
   └─ 发送确认邮件
   ↓
4. 每次分析时扣减额度
   ├─ 分析前检查额度
   ├─ 分析完成后扣减1次
   └─ 额度耗尽时提醒续费
```

### 3.5 支付失败处理

```
支付失败
   ↓
1. 记录失败原因
   ├─ 银行卡被拒
   ├─ 余额不足
   ├─ 网络超时
   └─ 其他异常
   ↓
2. 用户重定向到失败页面
   ├─ 显示失败原因
   ├─ 提供重试按钮
   └─ 客服联系方式
   ↓
3. 发送失败通知邮件
   ├─ 友好的失败说明
   ├─ 重试链接
   └─ 替代支付方式
   ↓
4. 保持用户当前计划状态
   ├─ 不降级用户权限
   ├─ 给予24小时宽限期
   └─ 提供人工客服支持
```

---

## 4. 报告查询与导出流程

### 4.1 报告查询流程

#### 参与者
- **用户**: 查看报告的用户
- **前端应用**: 报告展示界面
- **报告服务**: 报告查询逻辑
- **文件系统**: 报告存储
- **缓存系统**: 性能优化

#### 流程步骤

```
用户访问报告页面
   ↓
1. 加载报告列表
   ├─ 获取用户关注列表
   ├─ 查询最新报告索引
   └─ 按日期倒序排列
   ↓
2. 应用筛选条件 (可选)
   ├─ 按日期范围筛选
   ├─ 按公司名称筛选
   └─ 按行业类型筛选
   ↓
3. 分页加载报告数据
   ├─ 每页显示20条记录
   ├─ 支持无限滚动加载
   └─ 优先从缓存读取
   ↓
4. 用户点击查看详情
   ↓
5. 检查权限
   ├─ 验证用户身份
   ├─ 确认报告归属
   └─ 检查访问权限
   ↓
6. 从文件系统读取完整报告
   ├─ 根据日期和股票代码定位文件
   ├─ 解析JSON格式报告
   └─ 提取Markdown内容
   ↓
7. 渲染报告详情页面
   ├─ Markdown内容转HTML
   ├─ 添加样式和排版
   └─ 支持打印和分享
   ↓
8. 缓存报告内容
   ├─ 存入Redis缓存
   ├─ 设置24小时过期
   └─ 提高后续访问速度
```

### 4.2 报告导出流程

#### 单个报告导出

```
用户点击"导出"按钮
   ↓
1. 选择导出格式
   ├─ Markdown (.md)
   ├─ PDF (.pdf)
   └─ Word (.docx) [未来支持]
   ↓
2. 创建导出任务
   ├─ 生成唯一任务ID
   ├─ 状态：PROCESSING
   └─ 提交到异步队列
   ↓
3. 导出Worker处理任务
   ├─ 读取原始报告内容
   ├─ 根据格式进行转换
   └─ 生成目标格式文件
   ↓
4. 格式特定处理
   ├─ Markdown：直接复制原始内容
   ├─ PDF：使用wkhtmltopdf转换
   └─ 添加封面和页脚信息
   ↓
5. 保存到临时目录
   ├─ 生成安全的文件名
   ├─ 设置访问权限
   └─ 记录下载信息
   ↓
6. 返回下载链接
   ├─ 带签名的临时URL
   ├─ 24小时有效期
   └─ 支持断点续传
   ↓
7. 用户下载文件
   ↓
8. 定期清理临时文件
   ├─ 每小时检查过期文件
   ├─ 自动删除过期导出
   └─ 记录清理日志
```

#### 批量报告导出

```
用户选择多个报告
   ↓
1. 勾选要导出的报告
   ├─ 支持全选功能
   ├─ 最多50个报告
   └─ 显示选中数量
   ↓
2. 点击"批量导出"
   ↓
3. 选择导出选项
   ├─ 导出格式：PDF合集/ZIP打包
   ├─ 文件命名规则
   └─ 是否包含目录
   ↓
4. 创建批量导出任务
   ├─ 任务状态：PROCESSING
   ├─ 进度追踪：0/N
   └─ 估计完成时间
   ↓
5. 异步处理批量导出
   ├─ 逐个处理报告文件
   ├─ 实时更新进度
   └─ 处理错误和重试
   ↓
6. 打包所有文件
   ├─ 创建ZIP压缩包
   ├─ 添加README说明
   └─ 生成文件清单
   ↓
7. 完成导出任务
   ├─ 更新任务状态：SUCCESS
   ├─ 生成下载链接
   └─ 发送完成通知
   ↓
8. 用户下载打包文件
```

---

## 5. 系统监控与告警流程

### 5.1 实时监控流程

#### 参与者
- **监控系统**: Prometheus + Grafana
- **应用服务**: 各微服务
- **告警管理**: AlertManager
- **通知渠道**: 邮件/Slack/短信

#### 流程步骤

```
应用服务运行
   ↓
1. 指标数据收集
   ├─ CPU/内存使用率
   ├─ 请求响应时间
   ├─ 错误率统计
   ├─ 数据库连接数
   ├─ 任务队列长度
   └─ 自定义业务指标
   ↓
2. Prometheus定期拉取指标
   ├─ 每15秒采集一次
   ├─ 存储时序数据
   └─ 保留30天历史
   ↓
3. 实时告警检查
   ├─ 评估告警规则
   ├─ 触发条件判断
   └─ 告警状态管理
   ↓
4. 告警触发时
   ├─ 生成告警事件
   ├─ 确定告警级别
   └─ 发送到AlertManager
   ↓
5. AlertManager处理告警
   ├─ 告警分组和去重
   ├─ 确定接收人员
   └─ 选择通知渠道
   ↓
6. 发送告警通知
   ├─ 高优先级：电话+短信
   ├─ 中优先级：邮件+Slack
   └─ 低优先级：仅Slack
   ↓
7. 运维人员响应
   ├─ 确认告警信息
   ├─ 评估影响范围
   └─ 制定处理方案
   ↓
8. 问题解决后
   ├─ 告警自动恢复
   ├─ 发送恢复通知
   └─ 记录处理过程
```

### 5.2 关键告警规则

#### 系统级告警
```yaml
# CPU使用率告警
- alert: HighCPUUsage
  expr: cpu_usage_percent > 80
  for: 5m
  severity: warning
  message: "CPU使用率超过80%，持续5分钟"

# 内存使用率告警  
- alert: HighMemoryUsage
  expr: memory_usage_percent > 85
  for: 3m
  severity: critical
  message: "内存使用率超过85%，持续3分钟"

# 磁盘空间告警
- alert: DiskSpaceLow
  expr: disk_free_percent < 10
  for: 1m
  severity: critical
  message: "磁盘剩余空间不足10%"
```

#### 应用级告警
```yaml
# API响应时间告警
- alert: SlowAPIResponse
  expr: api_response_time_p95 > 2000
  for: 2m
  severity: warning
  message: "API 95%响应时间超过2秒"

# 错误率告警
- alert: HighErrorRate
  expr: error_rate_5m > 5
  for: 1m
  severity: critical
  message: "5分钟错误率超过5%"

# 任务队列积压告警
- alert: TaskQueueBacklog
  expr: celery_queue_length > 100
  for: 5m
  severity: warning
  message: "任务队列积压超过100个任务"
```

#### 业务级告警
```yaml
# 分析任务失败率告警
- alert: AnalysisTaskFailureRate
  expr: analysis_failure_rate_1h > 10
  for: 5m
  severity: critical
  message: "1小时内分析任务失败率超过10%"

# 新用户注册异常
- alert: UserRegistrationDrop
  expr: new_user_count_1h < 5
  for: 30m
  severity: warning
  message: "1小时内新用户注册数少于5个"

# 支付成功率下降
- alert: PaymentSuccessRateDrop
  expr: payment_success_rate_1h < 95
  for: 10m
  severity: critical
  message: "1小时内支付成功率低于95%"
```

---

## 6. 故障处理与恢复流程

### 6.1 故障分级

#### P0 - 严重故障
- 整个系统不可用
- 数据丢失风险
- 影响所有用户

#### P1 - 高优先级故障  
- 核心功能不可用
- 影响大部分用户
- 数据一致性问题

#### P2 - 中优先级故障
- 部分功能异常
- 影响少数用户
- 性能显著下降

#### P3 - 低优先级故障
- 轻微功能问题
- 不影响核心业务
- 可延后处理

### 6.2 故障响应流程

```
故障告警触发
   ↓
1. 自动识别故障级别
   ├─ 基于告警规则判断
   ├─ 评估影响范围
   └─ 确定响应优先级
   ↓
2. 通知相关人员
   ├─ P0/P1：立即电话通知
   ├─ P2：5分钟内邮件通知
   └─ P3：下个工作日处理
   ↓
3. 故障响应小组集结
   ├─ 技术负责人
   ├─ 运维工程师
   ├─ 开发工程师
   └─ 产品负责人 (P0/P1)
   ↓
4. 快速诊断
   ├─ 查看监控指标
   ├─ 检查系统日志
   ├─ 分析错误模式
   └─ 确定根本原因
   ↓
5. 紧急修复
   ├─ 实施临时解决方案
   ├─ 恢复服务可用性
   └─ 确认修复效果
   ↓
6. 服务恢复验证
   ├─ 功能测试
   ├─ 性能测试
   └─ 用户体验验证
   ↓
7. 根本原因修复
   ├─ 制定长期解决方案
   ├─ 代码修复和测试
   └─ 计划正式发布
   ↓
8. 故障复盘
   ├─ 分析故障原因
   ├─ 评估响应效果
   ├─ 制定改进措施
   └─ 更新应急预案
```

### 6.3 数据备份与恢复

#### 备份策略
```
数据库备份
├─ 每日增量备份 (凌晨2点)
├─ 每周全量备份 (周日凌晨)
├─ 备份保留30天
└─ 异地存储3份副本

文件备份  
├─ 报告文件每日同步
├─ 重要配置文件备份
├─ 代码仓库镜像备份
└─ 媒体文件CDN备份
```

#### 恢复流程
```
数据丢失事件发生
   ↓
1. 评估数据丢失范围
   ├─ 确定丢失时间点
   ├─ 评估影响用户数
   └─ 确定恢复目标
   ↓
2. 选择恢复策略
   ├─ 全量恢复 (数据库完全损坏)
   ├─ 增量恢复 (部分数据丢失)
   └─ 时间点恢复 (误操作)
   ↓
3. 执行数据恢复
   ├─ 停止受影响服务
   ├─ 从备份恢复数据
   ├─ 验证数据完整性
   └─ 重建索引和缓存
   ↓
4. 服务重启验证
   ├─ 逐步重启服务
   ├─ 功能完整性测试
   └─ 性能基准测试
   ↓
5. 用户通知
   ├─ 发布服务恢复公告
   ├─ 说明影响和补偿
   └─ 提供客服支持
```

---

*此文档详细描述了智策股析系统的所有核心业务流程，为开发团队提供完整的业务逻辑参考。*
