{% extends "base.html" %}

{% block title %}æŠ¥å‘Šç»Ÿè®¡ - EquityCompass{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">ğŸ“Š æŠ¥å‘Šç»Ÿè®¡</h1>
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-danger" onclick="showClearAllModal()">
                        <i class="fas fa-trash me-1"></i>ä¸€é”®æ¸…ç©º
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">æ€»æŠ¥å‘Šæ•°</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-reports">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">æ€»æµè§ˆæ¬¡æ•°</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-views">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-eye fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">æ€»ä¸‹è½½æ¬¡æ•°</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800" id="total-downloads">-</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-download fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾è¡¨åŒºåŸŸ -->
    <div class="row">
        <div class="col-xl-8 col-lg-7">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-dark">æ¯æ—¥ç»Ÿè®¡è¶‹åŠ¿</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow animated--fade-in" aria-labelledby="dropdownMenuLink">
                            <div class="dropdown-header">æ—¶é—´èŒƒå›´:</div>
                            <a class="dropdown-item" href="#" onclick="loadDailyStats(7)">æœ€è¿‘7å¤©</a>
                            <a class="dropdown-item" href="#" onclick="loadDailyStats(30)">æœ€è¿‘30å¤©</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="dailyStatsChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-4 col-lg-5">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-dark">çƒ­é—¨æŠ¥å‘Š</h6>
                </div>
                <div class="card-body">
                    <div id="popular-reports-list">
                        <div class="text-center text-muted">
                            <i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- æ¸…ç©ºç»Ÿè®¡ç¡®è®¤å¼¹çª— -->
<div class="modal fade" id="clearAllModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-trash-alt me-2"></i>ç¡®è®¤æ¸…ç©ºç»Ÿè®¡
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                </div>
                <h6 class="mb-3">æ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡æ•°æ®å—ï¼Ÿ</h6>
                <div class="alert alert-danger mt-3 mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>è­¦å‘Šï¼š</strong>æ¸…ç©ºåæ‰€æœ‰ç»Ÿè®¡æ•°æ®å°†æ— æ³•æ¢å¤ï¼åŒ…æ‹¬ï¼š
                    <ul class="mb-0 mt-2 text-start">
                        <li>æ‰€æœ‰æŠ¥å‘Šçš„æµè§ˆæ¬¡æ•°</li>
                        <li>æ‰€æœ‰æŠ¥å‘Šçš„ä¸‹è½½æ¬¡æ•°</li>
                        <li>æ‰€æœ‰å†å²ç»Ÿè®¡æ•°æ®</li>
                    </ul>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-danger" id="confirmClearAll">
                    <i class="fas fa-trash me-1"></i>ç¡®è®¤æ¸…ç©º
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let dailyStatsChart = null;

// é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨åŠ è½½å…¨å±€ç»Ÿè®¡
document.addEventListener('DOMContentLoaded', function() {
    loadGlobalStats();
    loadDailyStats(7);
    loadPopularReports();
    
    // ç»‘å®šæ¸…ç©ºç¡®è®¤æŒ‰é’®äº‹ä»¶
    document.getElementById('confirmClearAll').addEventListener('click', function() {
        clearAllStatistics();
    });
});

// åŠ è½½å…¨å±€ç»Ÿè®¡
function loadGlobalStats() {
    fetch('/api/report-statistics/global-stats?days=30')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('total-reports').textContent = data.data.total_reports;
                document.getElementById('total-views').textContent = data.data.total_views;
                document.getElementById('total-downloads').textContent = data.data.total_downloads;
            }
        })
        .catch(error => {
            console.error('åŠ è½½å…¨å±€ç»Ÿè®¡å¤±è´¥:', error);
            showAlert('åŠ è½½å…¨å±€ç»Ÿè®¡å¤±è´¥', 'danger');
        });
}


// åŠ è½½æ¯æ—¥ç»Ÿè®¡
function loadDailyStats(days = 7) {
    fetch(`/api/report-statistics/daily-stats?days=${days}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                updateDailyStatsChart(data.data);
            }
        })
        .catch(error => {
            console.error('åŠ è½½æ¯æ—¥ç»Ÿè®¡å¤±è´¥:', error);
            showAlert('åŠ è½½æ¯æ—¥ç»Ÿè®¡å¤±è´¥', 'danger');
        });
}

// æ›´æ–°æ¯æ—¥ç»Ÿè®¡å›¾è¡¨
function updateDailyStatsChart(data) {
    const ctx = document.getElementById('dailyStatsChart').getContext('2d');
    
    // é”€æ¯ç°æœ‰å›¾è¡¨
    if (dailyStatsChart) {
        dailyStatsChart.destroy();
    }
    
    const labels = data.map(item => item.date);
    const viewsData = data.map(item => item.views);
    const downloadsData = data.map(item => item.downloads);
    
    dailyStatsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: 'æµè§ˆæ¬¡æ•°',
                data: viewsData,
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: 'ä¸‹è½½æ¬¡æ•°',
                data: downloadsData,
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

// åŠ è½½çƒ­é—¨æŠ¥å‘Š
function loadPopularReports() {
    fetch('/api/report-statistics/popular?limit=5&days=30')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const container = document.getElementById('popular-reports-list');
                if (data.data.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted">æš‚æ— çƒ­é—¨æŠ¥å‘Š</div>';
                    return;
                }
                
                let html = '';
                data.data.forEach((report, index) => {
                    html += `
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <div class="font-weight-bold">${report.stock.name} (${report.stock.code})</div>
                                <small class="text-muted">${report.analysis_date}</small>
                            </div>
                            <div class="text-right">
                                <div class="text-primary">${report.view_count} æ¬¡æµè§ˆ</div>
                                <small class="text-muted">${report.download_count} æ¬¡ä¸‹è½½</small>
                            </div>
                        </div>
                        ${index < data.data.length - 1 ? '<hr>' : ''}
                    `;
                });
                container.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('åŠ è½½çƒ­é—¨æŠ¥å‘Šå¤±è´¥:', error);
            showAlert('åŠ è½½çƒ­é—¨æŠ¥å‘Šå¤±è´¥', 'danger');
        });
}

// æ˜¾ç¤ºæ¸…ç©ºç¡®è®¤å¼¹çª—
function showClearAllModal() {
    $('#clearAllModal').modal('show');
}

// æ¸…ç©ºæ‰€æœ‰ç»Ÿè®¡æ•°æ®
function clearAllStatistics() {
    const $btn = $('#confirmClearAll');
    const originalText = $btn.html();
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    $btn.html('<i class="fas fa-spinner fa-spin me-1"></i>æ¸…ç©ºä¸­...');
    $btn.prop('disabled', true);
    
    // å‘é€æ¸…ç©ºè¯·æ±‚
    fetch('/api/report-statistics/clear-all', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('æ‰€æœ‰ç»Ÿè®¡æ•°æ®å·²æ¸…ç©º', 'success');
            $('#clearAllModal').modal('hide');
            // é‡æ–°åŠ è½½ç»Ÿè®¡æ•°æ®
            loadGlobalStats();
            loadDailyStats(7);
            loadPopularReports();
        } else {
            showAlert(data.message || 'æ¸…ç©ºç»Ÿè®¡æ•°æ®å¤±è´¥', 'danger');
        }
    })
    .catch(error => {
        console.error('æ¸…ç©ºç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
        showAlert('æ¸…ç©ºç»Ÿè®¡æ•°æ®å¤±è´¥: ' + error, 'danger');
    })
    .finally(() => {
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        $btn.html(originalText);
        $btn.prop('disabled', false);
    });
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
