{% extends "base.html" %}

{% block title %}报告详情 - 智策股析{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">仪表板</a></li>
                <li class="breadcrumb-item"><a href="{{ url_for('reports.index') }}">分析报告</a></li>
                <li class="breadcrumb-item active" aria-current="page">报告详情</li>
            </ol>
        </nav>
    </div>
</div>

<!-- 报告头部信息 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h1 class="gradient-text mb-2">{{ report.stock_code }} - {{ report.stock_name }}</h1>
                        <p class="text-muted mb-0">
                            分析时间：{{ report.analysis_date }} | 
                            分析模型：{{ report.provider }} | 
                            市场：{{ report.market }}
                        </p>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="d-flex gap-3 justify-content-end">
                            {% if session.user_id %}
                                <button class="btn btn-outline-primary report-action-btn" onclick="downloadReport()">
                                    <i class="fas fa-download me-2"></i>导出PDF
                                </button>
                                <a href="{{ url_for('analysis.index') }}?stock={{ report.stock_code }}" class="btn btn-primary report-action-btn">
                                    <i class="fas fa-redo me-2"></i>重新分析
                                </a>
                                {% if session.is_admin %}
                                <button class="btn btn-danger report-action-btn" onclick="confirmDeleteReport()">
                                    <i class="fas fa-trash me-2"></i>删除报告
                                </button>
                                {% endif %}
                            {% else %}
                                <div class="alert alert-info mb-0" role="alert">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>访客模式</strong> - 
                                    <a href="{{ url_for('auth.login') }}" class="alert-link">登录</a>
                                    后可导出和分析
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析内容 -->
<div class="row">
    <div class="col-lg-8">
        <div class="card glass-effect mb-4">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="fas fa-chart-line text-primary me-2"></i>AI分析报告
                </h5>
                
                <div class="markdown-content" id="markdownContent">
                    {{ report.content | safe }}
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- 报告元数据 - 浮动跟随 -->
        <div class="sticky-sidebar">
            <div class="card glass-effect mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>报告信息
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row mb-2">
                        <div class="col-6"><strong>股票代码：</strong></div>
                        <div class="col-6">{{ report.stock_code }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>公司名称：</strong></div>
                        <div class="col-6">{{ report.stock_name }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>分析日期：</strong></div>
                        <div class="col-6">{{ report.analysis_date }}</div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>AI模型：</strong></div>
                        <div class="col-6">
                            <span class="badge bg-primary">{{ report.provider }}</span>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>市场：</strong></div>
                        <div class="col-6">
                            {% if report.market == 'US' %}
                                <span class="badge bg-primary">美股</span>
                            {% else %}
                                <span class="badge bg-success">港股</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if report.metadata %}
                    <div class="row mb-2">
                        <div class="col-6"><strong>生成时间：</strong></div>
                        <div class="col-6">{{ report.metadata.timestamp or 'N/A' }}</div>
                    </div>
                    {% if report.metadata.tokens_used %}
                    <div class="row mb-2">
                        <div class="col-6"><strong>Token使用：</strong></div>
                        <div class="col-6">{{ report.metadata.tokens_used }}</div>
                    </div>
                    {% endif %}
                    {% if report.metadata.response_time %}
                    <div class="row mb-2">
                        <div class="col-6"><strong>响应时间：</strong></div>
                        <div class="col-6">{{ "%.2f"|format(report.metadata.response_time) }}秒</div>
                    </div>
                    {% endif %}
                    {% endif %}
                    
                    <!-- 报告统计信息 -->
                    <hr class="my-3">
                    <div class="row mb-2">
                        <div class="col-6"><strong>浏览次数：</strong></div>
                        <div class="col-6">
                            <span id="view-count">-</span>
                            <i class="fas fa-eye text-primary ms-1"></i>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>下载次数：</strong></div>
                        <div class="col-6">
                            <span id="download-count">-</span>
                            <i class="fas fa-download text-success ms-1"></i>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>分享次数：</strong></div>
                        <div class="col-6">
                            <span id="share-count">-</span>
                            <i class="fas fa-share-alt text-info ms-1"></i>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6"><strong>收藏次数：</strong></div>
                        <div class="col-6">
                            <span id="favorite-count">-</span>
                            <i class="fas fa-heart text-danger ms-1"></i>
                        </div>
                    </div>
                    
                    <!-- 操作按钮 -->
                    <div class="mt-3">
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="recordShare()" title="分享报告">
                                <i class="fas fa-share-alt"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="recordFavorite()" title="收藏报告">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 历史报告 -->
            <div class="card glass-effect">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>历史报告
                    </h6>
                </div>
                <div class="card-body">
                    {% if historical_reports %}
                        <div class="list-group list-group-flush">
                            {% for hist_report in historical_reports %}
                            <div class="list-group-item bg-transparent border-0 px-0">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="flex-grow-1">
                                        <div class="d-flex align-items-center mb-1">
                                            <span class="badge bg-primary me-2">{{ hist_report.provider }}</span>
                                            <span class="badge bg-info">{{ hist_report.analysis_type == 'fundamental' and '基本面分析' or '技术面分析' }}</span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar me-1"></i>{{ hist_report.analysis_date }}
                                        </small>
                                    </div>
                                    <a href="{{ url_for('reports.detail', stock_code=hist_report.stock_code, report_id=hist_report.id) }}" 
                                       class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-eye me-1"></i>查看
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="mt-3">
                            <a href="{{ url_for('reports.index') }}?stock={{ report.stock_code }}" class="btn btn-sm btn-outline-primary w-100">
                                <i class="fas fa-search me-1"></i>查看所有报告
                            </a>
                        </div>
                    {% else %}
                        <p class="text-muted small">暂无历史报告</p>
                        <a href="{{ url_for('reports.index') }}?stock={{ report.stock_code }}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-search me-1"></i>查看所有报告
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.markdown-content {
    line-height: 1.8;
    color: #2c3e50;
    font-size: 15px;
    text-indent: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    background: transparent;
    padding: 2rem;
    border-radius: 8px;
    /* 确保内容完整显示 */
    min-height: auto;
    max-height: none;
    overflow: visible;
}

/* 去除Markdown内容开头的多余空格 */
.markdown-content > *:first-child {
    margin-top: 0;
    padding-top: 0;
}

.markdown-content > p:first-child {
    text-indent: 0;
    margin-left: 0;
    padding-left: 0;
}

.markdown-content h1, .markdown-content h2, .markdown-content h3, 
.markdown-content h4, .markdown-content h5, .markdown-content h6 {
    margin-top: 2.5rem;
    margin-bottom: 1.5rem;
    color: #1a202c;
    font-weight: 700;
    line-height: 1.3;
    letter-spacing: -0.025em;
}

.markdown-content h1 { 
    font-size: 2.2rem; 
    border-bottom: 3px solid #3182ce;
    padding-bottom: 0.8rem;
    margin-top: 0;
    color: #1a202c;
}
.markdown-content h2 { 
    font-size: 1.8rem; 
    border-bottom: 2px solid #e2e8f0;
    padding-bottom: 0.5rem;
    color: #2d3748;
}
.markdown-content h3 { 
    font-size: 1.5rem; 
    color: #4a5568;
    border-left: 4px solid #3182ce;
    padding-left: 1rem;
}
.markdown-content h4 { 
    font-size: 1.3rem; 
    color: #718096;
}
.markdown-content h5 { 
    font-size: 1.1rem; 
    color: #a0aec0;
}
.markdown-content h6 { 
    font-size: 1rem; 
    color: #cbd5e0;
}

.markdown-content p {
    margin-bottom: 1.5rem;
    text-align: justify;
    line-height: 1.8;
    color: #2d3748;
}

.markdown-content ul, .markdown-content ol {
    margin-bottom: 1.5rem;
    padding-left: 2.5rem;
}

.markdown-content li {
    margin-bottom: 0.8rem;
    line-height: 1.7;
    color: #2d3748;
}

.markdown-content ul li {
    position: relative;
}

.markdown-content ul li::before {
    content: "•";
    color: #3182ce;
    font-weight: bold;
    position: absolute;
    left: -1.5rem;
}

.markdown-content ol {
    counter-reset: item;
}

.markdown-content ol li {
    counter-increment: item;
    position: relative;
}

.markdown-content ol li::before {
    content: counter(item) ".";
    color: #3182ce;
    font-weight: bold;
    position: absolute;
    left: -2rem;
}

.markdown-content strong {
    font-weight: 700;
    color: #1a202c;
}

.markdown-content em {
    font-style: italic;
    color: #4a5568;
}

.markdown-content code {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', Consolas, 'Courier New', monospace;
    font-size: 0.9em;
    font-weight: 500;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.markdown-content pre {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: 8px;
    overflow-x: auto;
    margin: 2rem 0;
    border: none;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.markdown-content pre code {
    background: none;
    padding: 0;
    border: none;
    color: white;
    box-shadow: none;
}

.markdown-content blockquote {
    border-left: 5px solid #3182ce;
    padding: 1.5rem 2rem;
    margin: 2rem 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 0 8px 8px 0;
    font-style: italic;
    font-size: 1.1em;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.markdown-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
}

.markdown-content th, .markdown-content td {
    border: 1px solid #e2e8f0;
    padding: 1rem;
    text-align: left;
    vertical-align: top;
}

.markdown-content th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: 600;
    font-size: 0.95em;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.markdown-content tr:nth-child(even) {
    background-color: #f7fafc;
}

.markdown-content tr:hover {
    background-color: #edf2f7;
    transition: background-color 0.2s ease;
}

/* 特殊样式 */
.markdown-content .highlight {
    background: linear-gradient(120deg, #a8edea 0%, #fed6e3 100%);
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-weight: 600;
}

.markdown-content .warning {
    background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
    color: #92400e;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 5px solid #f59e0b;
    margin: 1.5rem 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.markdown-content .success {
    background: linear-gradient(135deg, #d4edda 0%, #c3fae8 100%);
    color: #155724;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 5px solid #38a169;
    margin: 1.5rem 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.markdown-content .info {
    background: linear-gradient(135deg, #d1ecf1 0%, #bee3f8 100%);
    color: #0c5460;
    padding: 1.5rem;
    border-radius: 8px;
    border-left: 5px solid #3182ce;
    margin: 1.5rem 0;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* 报告开头介绍段落的特殊样式 */
.markdown-content > p:first-of-type {
    background: transparent !important;
    color: #2c3e50 !important;
    padding: 0 !important;
    border-radius: 0 !important;
    font-size: 1em !important;
    font-weight: normal !important;
    line-height: 1.8 !important;
    margin: 1rem 0 !important;
    box-shadow: none !important;
    border-left: none !important;
    position: static !important;
    overflow: visible !important;
}

.markdown-content > p:first-of-type::before {
    content: none;
}

.markdown-content > p:first-of-type::after {
    content: none;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* 浮动跟随的侧边栏 */
.sticky-sidebar {
    position: sticky;
    top: 2rem;
    max-height: calc(100vh - 4rem);
    overflow-y: auto;
    z-index: 100;
}

/* 侧边栏滚动条样式 */
.sticky-sidebar::-webkit-scrollbar {
    width: 6px;
}

.sticky-sidebar::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 3px;
}

.sticky-sidebar::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 3px;
}

.sticky-sidebar::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
}

/* 确保侧边栏卡片有合适的间距 */
.sticky-sidebar .card {
    margin-bottom: 1.5rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

/* 确保报告内容卡片完整显示 */
.card.glass-effect {
    min-height: auto !important;
    max-height: none !important;
    overflow: visible !important;
    background: transparent !important;
}

.card-body {
    min-height: auto !important;
    max-height: none !important;
    overflow: visible !important;
    background: transparent !important;
}

.sticky-sidebar .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* 响应式设计 */
@media (max-width: 768px) {
    .markdown-content {
        padding: 1rem;
        font-size: 14px;
    }
    
    .markdown-content h1 { font-size: 1.8rem; }
    .markdown-content h2 { font-size: 1.5rem; }
    .markdown-content h3 { font-size: 1.3rem; }
    
    .markdown-content table {
        font-size: 0.9em;
    }
    
    .markdown-content th, .markdown-content td {
        padding: 0.5rem;
    }

    .markdown-content > p:first-of-type {
        padding: 1rem 1.5rem;
        font-size: 1em;
        margin: 1.5rem 0;
    }
    
    .markdown-content > p:first-of-type::before {
        font-size: 1.5rem;
        top: 0.8rem;
        right: 1rem;
    }
}

/* 响应式设计 */
@media (max-width: 991.98px) {
    .sticky-sidebar {
        position: static;
        max-height: none;
        overflow-y: visible;
    }
    
    .sticky-sidebar .card {
        margin-bottom: 1rem;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- Marked.js for Markdown parsing -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
// 配置marked.js
marked.setOptions({
    breaks: true,  // 支持换行
    gfm: true,     // 支持GitHub风格的Markdown
    sanitize: false, // 允许HTML标签
    headerIds: false, // 不生成标题ID
    mangle: false, // 不转义内容
    highlight: function(code, lang) {
        // 代码高亮功能
        if (lang && hljs.getLanguage(lang)) {
            try {
                return hljs.highlight(code, { language: lang }).value;
            } catch (err) {}
        }
        return code;
    }
});

// 使用默认渲染器，不自定义

// 解析Markdown内容
document.addEventListener('DOMContentLoaded', function() {
    // 记录页面浏览
    recordView();
    
    // 加载报告统计信息
    loadReportStatistics();
    
    const markdownContent = document.getElementById('markdownContent');
    if (markdownContent) {
        let markdownText = markdownContent.innerHTML;
        
        console.log('原始Markdown内容:', markdownText.substring(0, 200) + '...');
        
        // 清理开头的多余空格和换行
        markdownText = markdownText.trim();
        
        // 去除开头的多余空格
        markdownText = markdownText.replace(/^\s+/, '');
        
        // 处理可能的HTML实体
        markdownText = markdownText.replace(/&amp;/g, '&')
                                   .replace(/&lt;/g, '<')
                                   .replace(/&gt;/g, '>')
                                   .replace(/&quot;/g, '"')
                                   .replace(/&#39;/g, "'");
        
        // 处理Qwen特有的格式问题
        console.log('开始处理Markdown格式...');
        
        // 1. 处理标题中的粗体格式 - 移除标题中的粗体标记
        markdownText = markdownText.replace(/^# \*\*(.*?)\*\*/gm, '# $1');
        markdownText = markdownText.replace(/^## \*\*(.*?)\*\*/gm, '## $1');
        markdownText = markdownText.replace(/^### \*\*(.*?)\*\*/gm, '### $1');
        markdownText = markdownText.replace(/^#### \*\*(.*?)\*\*/gm, '#### $1');
        markdownText = markdownText.replace(/^##### \*\*(.*?)\*\*/gm, '##### $1');
        markdownText = markdownText.replace(/^###### \*\*(.*?)\*\*/gm, '###### $1');
        
        console.log('Markdown格式处理完成');
        
        console.log('清理后的Markdown内容:', markdownText.substring(0, 200) + '...');
        console.log('Markdown内容总长度:', markdownText.length);
        
        try {
            const htmlContent = marked.parse(markdownText);
            console.log('解析后的HTML内容:', htmlContent.substring(0, 200) + '...');
            console.log('HTML内容总长度:', htmlContent.length);
            markdownContent.innerHTML = htmlContent;
            
            // 检查内容是否完整显示
            setTimeout(() => {
                console.log('最终显示的内容高度:', markdownContent.scrollHeight);
                console.log('容器高度:', markdownContent.clientHeight);
                console.log('是否有滚动条:', markdownContent.scrollHeight > markdownContent.clientHeight);
            }, 100);
        } catch (error) {
            console.error('Markdown解析错误:', error);
            // 如果解析失败，显示原始内容
            markdownContent.innerHTML = '<pre>' + markdownText + '</pre>';
        }
    }
});

function downloadReport() {
    // 显示加载提示
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>生成中...';
    button.disabled = true;
    
    // 记录下载统计
    recordDownload();
    
    // 构建PDF下载URL
    const url = `{{ url_for('reports.export_pdf', stock_code=report.stock_code) }}?report_id={{ report.id }}`;
    
    // 创建下载链接
    const link = document.createElement('a');
    link.href = url;
    link.style.display = 'none';
    document.body.appendChild(link);
    
    // 触发下载
    link.click();
    document.body.removeChild(link);
    
    // 恢复按钮状态
    setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

function confirmDeleteReport() {
    // 二次确认对话框
    if (confirm('⚠️ 确定要删除这份报告吗？\n\n此操作不可撤销，报告将被永久删除。')) {
        deleteReport();
    }
}

function deleteReport() {
    const stockCode = '{{ report.stock_code }}';
    const reportId = '{{ report.id }}';
    
    // 显示删除中状态
    const deleteBtn = event.target;
    const originalText = deleteBtn.innerHTML;
    deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>删除中...';
    deleteBtn.disabled = true;
    
    // 发送删除请求
    fetch(`/reports/${stockCode}/delete`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_id: reportId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 删除成功，显示成功消息并跳转
            alert('✅ 报告删除成功！');
            window.location.href = '{{ url_for("reports.index") }}';
        } else {
            // 删除失败，显示错误消息
            alert('❌ 删除失败：' + (data.error || '未知错误'));
            deleteBtn.innerHTML = originalText;
            deleteBtn.disabled = false;
        }
    })
    .catch(error => {
        console.error('删除报告时出错:', error);
        alert('❌ 删除失败：网络错误，请稍后重试');
        deleteBtn.innerHTML = originalText;
        deleteBtn.disabled = false;
    });
}

// 记录下载
function recordDownload() {
    const reportId = '{{ report.id }}';
    
    fetch('/api/report-statistics/record-download', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_id: reportId,
            format: 'PDF',
            file_size: 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新显示
            const downloadCount = document.getElementById('download-count');
            const currentCount = parseInt(downloadCount.textContent) || 0;
            downloadCount.textContent = currentCount + 1;
            
            console.log('下载记录成功');
        }
    })
    .catch(error => {
        console.error('记录下载失败:', error);
    });
}

// 记录页面浏览
function recordView() {
    const reportId = '{{ report.id }}';
    const viewDuration = 0; // 初始浏览时长
    
    fetch('/api/report-statistics/record-view', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_id: reportId,
            view_duration: viewDuration
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('浏览记录成功');
        }
    })
    .catch(error => {
        console.error('记录浏览失败:', error);
    });
}

// 加载报告统计信息
function loadReportStatistics() {
    const reportId = '{{ report.id }}';
    
    fetch(`/api/report-statistics/report/${reportId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.data) {
                document.getElementById('view-count').textContent = data.data.view_count || 0;
                document.getElementById('download-count').textContent = data.data.download_count || 0;
                document.getElementById('share-count').textContent = data.data.share_count || 0;
                document.getElementById('favorite-count').textContent = data.data.favorite_count || 0;
            }
        })
        .catch(error => {
            console.error('加载统计信息失败:', error);
        });
}

// 记录分享
function recordShare() {
    const reportId = '{{ report.id }}';
    
    fetch('/api/report-statistics/record-share', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_id: reportId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新显示
            const shareCount = document.getElementById('share-count');
            const currentCount = parseInt(shareCount.textContent) || 0;
            shareCount.textContent = currentCount + 1;
            
            // 显示成功提示
            showToast('分享记录成功！', 'success');
        }
    })
    .catch(error => {
        console.error('记录分享失败:', error);
        showToast('分享记录失败', 'error');
    });
}

// 记录收藏
function recordFavorite() {
    const reportId = '{{ report.id }}';
    
    fetch('/api/report-statistics/record-favorite', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            report_id: reportId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 更新显示
            const favoriteCount = document.getElementById('favorite-count');
            const currentCount = parseInt(favoriteCount.textContent) || 0;
            favoriteCount.textContent = currentCount + 1;
            
            // 显示成功提示
            showToast('收藏记录成功！', 'success');
        }
    })
    .catch(error => {
        console.error('记录收藏失败:', error);
        showToast('收藏记录失败', 'error');
    });
}

// 显示提示信息
function showToast(message, type = 'info') {
    const toastDiv = document.createElement('div');
    toastDiv.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : 'danger'} border-0`;
    toastDiv.setAttribute('role', 'alert');
    toastDiv.setAttribute('aria-live', 'assertive');
    toastDiv.setAttribute('aria-atomic', 'true');
    
    toastDiv.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${message}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    `;
    
    // 添加到页面
    const container = document.querySelector('.container-fluid');
    container.appendChild(toastDiv);
    
    // 显示toast
    const toast = new bootstrap.Toast(toastDiv);
    toast.show();
    
    // 自动移除
    setTimeout(() => {
        toastDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
