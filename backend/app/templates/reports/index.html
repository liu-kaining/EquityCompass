{% extends "base.html" %}

{% block title %}åˆ†ææŠ¥å‘Š - æ™ºç­–è‚¡æ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="gradient-text mb-4">
            <i class="fas fa-file-text me-3"></i>åˆ†ææŠ¥å‘Š
        </h1>
        <p class="text-muted mb-4">æŸ¥çœ‹AIç”Ÿæˆçš„è‚¡ç¥¨åˆ†ææŠ¥å‘Š</p>
    </div>
</div>

<!-- ç­›é€‰å™¨ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect filter-card">
            <div class="card-body">
                <h6 class="card-title mb-3">
                    <i class="fas fa-filter me-2 text-primary"></i>ç­›é€‰æ¡ä»¶
                </h6>
                <form id="filterForm" method="GET">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-chart-line me-2"></i>è‚¡ç¥¨ç­›é€‰
                            </label>
                            <div class="custom-select filter-select">
                                <select class="form-select" name="stock" id="stockFilter">
                                    <option value="">ğŸ“Š å…¨éƒ¨è‚¡ç¥¨</option>
                                    {% for stock in available_stocks %}
                                    <option value="{{ stock.code }}" {% if request.args.get('stock') == stock.code %}selected{% endif %}>
                                        {{ stock.code }} - {{ stock.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-calendar me-2"></i>æ—¥æœŸç­›é€‰
                            </label>
                            <div class="custom-select filter-select">
                                <select class="form-select" name="date" id="dateFilter">
                                    <option value="">ğŸ“… å…¨éƒ¨æ—¥æœŸ</option>
                                    <option value="today" {% if request.args.get('date') == 'today' %}selected{% endif %}>ğŸ“† ä»Šå¤©</option>
                                    <option value="week" {% if request.args.get('date') == 'week' %}selected{% endif %}>ğŸ“… æœ¬å‘¨</option>
                                    <option value="month" {% if request.args.get('date') == 'month' %}selected{% endif %}>ğŸ“Š æœ¬æœˆ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-chart-line me-2"></i>åˆ†æç±»å‹
                            </label>
                            <div class="custom-select filter-select">
                                <select class="form-select" name="analysis_type" id="analysisTypeFilter">
                                    <option value="">ğŸ“Š å…¨éƒ¨ç±»å‹</option>
                                    <option value="fundamental" {% if request.args.get('analysis_type') == 'fundamental' %}selected{% endif %}>
                                        ğŸ“ˆ åŸºæœ¬é¢åˆ†æ
                                    </option>
                                    <option value="technical" {% if request.args.get('analysis_type') == 'technical' %}selected{% endif %}>
                                        ğŸ“‰ æŠ€æœ¯é¢åˆ†æ
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-robot me-2"></i>æ¨¡å‹ç­›é€‰
                            </label>
                            <div class="custom-select filter-select">
                                <select class="form-select" name="model" id="modelFilter">
                                    <option value="">ğŸ¤– å…¨éƒ¨æ¨¡å‹</option>
                                    <option value="deepseek" {% if request.args.get('model') == 'deepseek' %}selected{% endif %}>
                                        ğŸš€ DeepSeek
                                    </option>
                                    <option value="qwen" {% if request.args.get('model') == 'qwen' %}selected{% endif %}>
                                        ğŸŒŸ Qwen
                                    </option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div class="d-flex">
                                <button type="submit" class="btn btn-primary w-100">
                                    <i class="fas fa-search me-2"></i>ç­›é€‰
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æŠ¥å‘Šåˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h5 class="card-title mb-1">
                            <i class="fas fa-file-text me-2 text-primary"></i>æŠ¥å‘Šåˆ—è¡¨
                        </h5>
                        <p class="text-muted mb-0 small">å…± {{ reports|length }} ä»½åˆ†ææŠ¥å‘Š</p>
                    </div>
                            <div class="d-flex gap-3">
            {% if session.user_id %}
                <button class="btn btn-outline-primary report-action-btn" id="batchExportBtn" onclick="toggleBatchMode()">
                    <i class="fas fa-download me-2"></i>æ‰¹é‡å¯¼å‡º
                </button>
                <button class="btn btn-success report-action-btn" id="confirmExportBtn" onclick="confirmBatchExport()" style="display: none;">
                    <i class="fas fa-check me-2"></i>ç¡®è®¤å¯¼å‡º
                </button>
                <button class="btn btn-secondary report-action-btn" id="cancelBatchBtn" onclick="cancelBatchMode()" style="display: none;">
                    <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </button>
                <a href="{{ url_for('analysis.index') }}" class="btn btn-primary report-action-btn">
                    <i class="fas fa-plus me-2"></i>æ–°å»ºåˆ†æ
                </a>
            {% else %}
                <div class="alert alert-info mb-0" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>è®¿å®¢æ¨¡å¼</strong> - æ‚¨å¯ä»¥æŸ¥çœ‹æŠ¥å‘Šï¼Œä½†éœ€è¦
                    <a href="{{ url_for('auth.login') }}" class="alert-link">ç™»å½•</a>
                    æ‰èƒ½è¿›è¡ŒAIåˆ†æå’Œå¯¼å‡ºåŠŸèƒ½
                </div>
            {% endif %}
        </div>
                </div>
                
                {% if reports %}
                    <div class="row">
                        {% for report in reports %}
                        <div class="col-lg-6 col-xl-4 mb-4">
                            <div class="card report-card glass-effect h-100" data-report-id="{{ report.id }}">
                                <div class="card-body d-flex flex-column">
                                    <!-- å¤šé€‰å¤é€‰æ¡† -->
                                    <div class="report-checkbox" style="display: none;">
                                        <div class="form-check">
                                            <input class="form-check-input report-select-checkbox" type="checkbox" 
                                                   value="{{ report.id }}" 
                                                   data-stock-code="{{ report.stock_code }}"
                                                   data-report-id="{{ report.report_id }}"
                                                   id="report_{{ report.id }}">
                                            <label class="form-check-label" for="report_{{ report.id }}">
                                                é€‰æ‹©æ­¤æŠ¥å‘Š
                                            </label>
                                        </div>
                                    </div>
                                    <!-- å¡ç‰‡å¤´éƒ¨ -->
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title mb-1 fw-bold text-primary">{{ report.stock_code }}</h5>
                                            <p class="text-dark mb-0 fw-medium">{{ report.stock_name }}</p>
                                            {% if report.is_watched %}
                                            <span class="badge bg-success mt-1">
                                                <i class="fas fa-bookmark me-1"></i>å·²å…³æ³¨
                                            </span>
                                            {% endif %}
                                        </div>
                                        <div class="text-end">
                                            <span class="badge bg-primary fs-6 fw-semibold">{{ report.ai_provider }}</span>
                                            <br>
                                            <span class="badge bg-info fs-6 mt-1">
                                                {% if report.analysis_type == 'fundamental' %}
                                                    åŸºæœ¬é¢åˆ†æ
                                                {% elif report.analysis_type == 'technical' %}
                                                    æŠ€æœ¯é¢åˆ†æ
                                                {% else %}
                                                    {{ report.analysis_type }}
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                    
                                    <!-- æŠ¥å‘Šå†…å®¹é¢„è§ˆ -->
                                    <div class="flex-grow-1 mb-3">
                                        <div class="report-preview">
                                            {{ report.content[:150] | replace('###', '') | replace('**', '') | replace('---', '') | replace('\n', ' ') }}...
                                        </div>
                                    </div>
                                    
                                    <!-- å¡ç‰‡åº•éƒ¨ -->
                                    <div class="d-flex justify-content-between align-items-center mt-auto">
                                        <small class="text-muted">
                                            <i class="fas fa-clock me-1"></i>
                                            <span class="fw-medium">{{ report.created_at if report.created_at else report.analysis_date }}</span>
                                        </small>
                                        <a href="{{ url_for('reports.detail', stock_code=report.stock_code, report_id=report.report_id) }}" 
                                           class="btn btn-primary btn-sm">
                                            <i class="fas fa-eye me-1"></i>æŸ¥çœ‹è¯¦æƒ…
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    
                    <!-- åˆ†é¡µç»„ä»¶ -->
                    {% if pagination and pagination.pages > 1 %}
                    <div class="pagination-container mt-4">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="pagination-info">
                                <small>
                                    å…± {{ pagination.total }} ä»½æŠ¥å‘Š Â· ç¬¬ {{ pagination.page }} é¡µï¼Œå…± {{ pagination.pages }} é¡µ
                                </small>
                            </div>
                            <nav aria-label="æŠ¥å‘Šåˆ†é¡µ">
                                <ul class="pagination pagination-sm mb-0">
                                    {% if pagination.has_prev %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('reports.index', page=pagination.prev_page, stock=request.args.get('stock', ''), date=request.args.get('date', ''), analysis_type=request.args.get('analysis_type', ''), model=request.args.get('model', '')) }}">
                                            <i class="fas fa-chevron-left"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                    
                                    {% for p in range(max(1, pagination.page - 2), min(pagination.pages + 1, pagination.page + 3)) %}
                                    <li class="page-item {% if p == pagination.page %}active{% endif %}">
                                        <a class="page-link" href="{{ url_for('reports.index', page=p, stock=request.args.get('stock', ''), date=request.args.get('date', ''), analysis_type=request.args.get('analysis_type', ''), model=request.args.get('model', '')) }}">
                                            {{ p }}
                                        </a>
                                    </li>
                                    {% endfor %}
                                    
                                    {% if pagination.has_next %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('reports.index', page=pagination.next_page, stock=request.args.get('stock', ''), date=request.args.get('date', ''), analysis_type=request.args.get('analysis_type', ''), model=request.args.get('model', '')) }}">
                                            <i class="fas fa-chevron-right"></i>
                                        </a>
                                    </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        </div>
                    </div>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">æš‚æ— åˆ†ææŠ¥å‘Š</h5>
                        <p class="text-muted">æ‚¨è¿˜æ²¡æœ‰ç”Ÿæˆä»»ä½•åˆ†ææŠ¥å‘Š</p>
                        <a href="{{ url_for('analysis.index') }}" class="btn btn-primary">
                            <i class="fas fa-plus me-2"></i>å¼€å§‹åˆ†æ
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script>
let batchMode = false;

function toggleBatchMode() {
    batchMode = !batchMode;
    const checkboxes = document.querySelectorAll('.report-checkbox');
    const batchBtn = document.getElementById('batchExportBtn');
    const confirmBtn = document.getElementById('confirmExportBtn');
    const cancelBtn = document.getElementById('cancelBatchBtn');
    
    if (batchMode) {
        // è¿›å…¥å¤šé€‰æ¨¡å¼
        checkboxes.forEach(cb => cb.style.display = 'block');
        batchBtn.style.display = 'none';
        confirmBtn.style.display = 'inline-block';
        cancelBtn.style.display = 'inline-block';
        
        // æ·»åŠ é€‰ä¸­æ•ˆæœ
        document.querySelectorAll('.report-card').forEach(card => {
            card.style.border = '2px solid transparent';
            card.style.transition = 'all 0.3s ease';
        });
        
        // ç›‘å¬å¤é€‰æ¡†å˜åŒ–
        document.querySelectorAll('.report-select-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const card = this.closest('.report-card');
                if (this.checked) {
                    card.style.border = '2px solid #4f46e5';
                    card.style.transform = 'scale(1.02)';
                } else {
                    card.style.border = '2px solid transparent';
                    card.style.transform = 'scale(1)';
                }
            });
        });
    }
}

function cancelBatchMode() {
    batchMode = false;
    const checkboxes = document.querySelectorAll('.report-checkbox');
    const batchBtn = document.getElementById('batchExportBtn');
    const confirmBtn = document.getElementById('confirmExportBtn');
    const cancelBtn = document.getElementById('cancelBatchBtn');
    
    // é€€å‡ºå¤šé€‰æ¨¡å¼
    checkboxes.forEach(cb => cb.style.display = 'none');
    batchBtn.style.display = 'inline-block';
    confirmBtn.style.display = 'none';
    cancelBtn.style.display = 'none';
    
    // æ¸…é™¤é€‰ä¸­çŠ¶æ€
    document.querySelectorAll('.report-select-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // æ¸…é™¤é€‰ä¸­æ•ˆæœ
    document.querySelectorAll('.report-card').forEach(card => {
        card.style.border = '2px solid transparent';
        card.style.transform = 'scale(1)';
    });
}

function confirmBatchExport() {
    const selectedReports = document.querySelectorAll('.report-select-checkbox:checked');
    
    if (selectedReports.length === 0) {
        showToast('warning', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªæŠ¥å‘Šè¿›è¡Œå¯¼å‡º');
        return;
    }
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    const confirmBtn = document.getElementById('confirmExportBtn');
    const originalText = confirmBtn.innerHTML;
    confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ç”Ÿæˆä¸­...';
    confirmBtn.disabled = true;
    
    // æ”¶é›†é€‰ä¸­çš„æŠ¥å‘Šä¿¡æ¯
    const reportData = Array.from(selectedReports).map(checkbox => ({
        stock_code: checkbox.getAttribute('data-stock-code'),
        report_id: checkbox.getAttribute('data-report-id')
    }));
    
    // å‘é€æ‰¹é‡å¯¼å‡ºè¯·æ±‚
    fetch('/reports/batch-export', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ reports: reportData })
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('å¯¼å‡ºå¤±è´¥');
    })
    .then(blob => {
        // åˆ›å»ºä¸‹è½½é“¾æ¥
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `åˆ†ææŠ¥å‘Š_${new Date().toISOString().slice(0, 10)}.zip`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // é€€å‡ºå¤šé€‰æ¨¡å¼
        cancelBatchMode();
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    })
    .catch(error => {
        console.error('å¯¼å‡ºé”™è¯¯:', error);
        showToast('error', 'å¯¼å‡ºå¤±è´¥ï¼Œè¯·é‡è¯•');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        confirmBtn.innerHTML = originalText;
        confirmBtn.disabled = false;
    });
}
</script>
{% endblock %}
