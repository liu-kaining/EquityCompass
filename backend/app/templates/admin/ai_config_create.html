{% extends "base.html" %}

{% block title %}åˆ›å»ºAIé…ç½® - EquityCompass{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">ä»ªè¡¨æ¿</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('ai_config.index') }}">AIé…ç½®ç®¡ç†</a></li>
                    <li class="breadcrumb-item active" aria-current="page">åˆ›å»ºé…ç½®</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">ğŸ¤– åˆ›å»ºAIé…ç½®</h1>
                <a href="{{ url_for('ai_config.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›åˆ—è¡¨
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-plus me-2"></i>é…ç½®ä¿¡æ¯
                    </h5>
                </div>
                <div class="card-body">
                    <form id="createConfigForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="providerName" class="form-label">
                                        <i class="fas fa-cogs me-2"></i>æä¾›å•†åç§° *
                                    </label>
                                    <select class="form-select" id="providerName" name="provider_name" required>
                                        <option value="">è¯·é€‰æ‹©æä¾›å•†</option>
                                        {% for provider, template in templates.items() %}
                                        <option value="{{ provider }}" data-template='{{ template | tojson }}'>
                                            {{ template.display_name }}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <div class="form-text">é€‰æ‹©AIæ¨¡å‹æä¾›å•†</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="displayName" class="form-label">
                                        <i class="fas fa-tag me-2"></i>æ˜¾ç¤ºåç§° *
                                    </label>
                                    <input type="text" class="form-control" id="displayName" name="display_name" required>
                                    <div class="form-text">é…ç½®çš„æ˜¾ç¤ºåç§°</div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="apiKey" class="form-label">
                                        <i class="fas fa-key me-2"></i>APIå¯†é’¥ *
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="apiKey" name="api_key" required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility('apiKey')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">æä¾›å•†çš„APIå¯†é’¥</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="modelName" class="form-label">
                                        <i class="fas fa-brain me-2"></i>æ¨¡å‹åç§° *
                                    </label>
                                    <input type="text" class="form-control" id="modelName" name="model_name" required>
                                    <div class="form-text">ä½¿ç”¨çš„AIæ¨¡å‹åç§°</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group mb-3">
                            <label for="apiUrl" class="form-label">
                                <i class="fas fa-link me-2"></i>APIåœ°å€
                            </label>
                            <input type="url" class="form-control" id="apiUrl" name="api_url">
                            <div class="form-text">APIæ¥å£åœ°å€ï¼ˆå¯é€‰ï¼Œä½¿ç”¨é»˜è®¤åœ°å€ï¼‰</div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="maxTokens" class="form-label">
                                        <i class="fas fa-hashtag me-2"></i>æœ€å¤§Tokenæ•°
                                    </label>
                                    <input type="number" class="form-control" id="maxTokens" name="max_tokens" value="15000" min="1" max="100000">
                                    <div class="form-text">å•æ¬¡è¯·æ±‚çš„æœ€å¤§tokenæ•°é‡</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group mb-3">
                                    <label for="temperature" class="form-label">
                                        <i class="fas fa-thermometer-half me-2"></i>æ¸©åº¦å‚æ•°
                                    </label>
                                    <input type="number" class="form-control" id="temperature" name="temperature" value="0.7" min="0" max="2" step="0.1">
                                    <div class="form-text">æ§åˆ¶è¾“å‡ºçš„éšæœºæ€§ï¼ˆ0-2ï¼‰</div>
                                </div>
                            </div>
                        </div>

                        <!-- é«˜çº§é…ç½® -->
                        <div class="card mt-4">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>é«˜çº§é…ç½®
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableDeepThinking" name="enable_deep_thinking">
                                            <label class="form-check-label" for="enableDeepThinking">
                                                å¯ç”¨æ·±åº¦æ€è€ƒ
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="enableWebSearch" name="enable_web_search">
                                            <label class="form-check-label" for="enableWebSearch">
                                                å¯ç”¨å…¨ç½‘æœç´¢
                                            </label>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label for="thinkingSteps" class="form-label">æ€è€ƒæ­¥æ•°</label>
                                            <input type="number" class="form-control" id="thinkingSteps" name="thinking_steps" value="3" min="1" max="10">
                                            <div class="form-text">æ·±åº¦æ€è€ƒçš„æ­¥æ•°</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="isActive" name="is_active" checked>
                                    <label class="form-check-label" for="isActive">
                                        ç«‹å³æ¿€æ´»
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="isDefault" name="is_default">
                                    <label class="form-check-label" for="isDefault">
                                        è®¾ä¸ºé»˜è®¤é…ç½®
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2 mt-4">
                            <a href="{{ url_for('ai_config.index') }}" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>å–æ¶ˆ
                            </a>
                            <button type="button" class="btn btn-warning" onclick="testConfig()">
                                <i class="fas fa-vial me-1"></i>æµ‹è¯•è¿æ¥
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>åˆ›å»ºé…ç½®
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>é…ç½®è¯´æ˜
                    </h6>
                </div>
                <div class="card-body">
                    <h6>æ”¯æŒçš„æä¾›å•†ï¼š</h6>
                    <ul class="list-unstyled">
                        <li><strong>Qwen:</strong> é˜¿é‡Œäº‘é€šä¹‰åƒé—®ï¼Œæ”¯æŒæ·±åº¦æ€è€ƒå’Œå…¨ç½‘æœç´¢</li>
                        <li><strong>DeepSeek:</strong> DeepSeekæ¨ç†æ¨¡å‹ï¼Œæ“…é•¿é€»è¾‘æ¨ç†</li>
                        <li><strong>Gemini:</strong> Google Geminiï¼Œå¤šæ¨¡æ€AIæ¨¡å‹</li>
                        <li><strong>OpenAI:</strong> ChatGPTç³»åˆ—æ¨¡å‹</li>
                    </ul>
                    
                    <h6 class="mt-3">é…ç½®å»ºè®®ï¼š</h6>
                    <ul class="list-unstyled">
                        <li>â€¢ å»ºè®®è®¾ç½®åˆç†çš„Tokené™åˆ¶</li>
                        <li>â€¢ æ¸©åº¦å‚æ•°0.7é€‚åˆå¤§å¤šæ•°åœºæ™¯</li>
                        <li>â€¢ æ·±åº¦æ€è€ƒåŠŸèƒ½ä¼šæ¶ˆè€—æ›´å¤šToken</li>
                        <li>â€¢ å…¨ç½‘æœç´¢åŠŸèƒ½éœ€è¦ç½‘ç»œè¿æ¥</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// é¡µé¢åŠ è½½å®Œæˆåç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    // ç»‘å®šè¡¨å•æäº¤äº‹ä»¶
    document.getElementById('createConfigForm').addEventListener('submit', function(e) {
        e.preventDefault();
        createConfig();
    });
    
    // ç»‘å®šæä¾›å•†é€‰æ‹©äº‹ä»¶
    document.getElementById('providerName').addEventListener('change', function() {
        loadProviderTemplate();
    });
});

// åŠ è½½æä¾›å•†æ¨¡æ¿
function loadProviderTemplate() {
    const select = document.getElementById('providerName');
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption.value) {
        const template = JSON.parse(selectedOption.dataset.template);
        
        // å¡«å……æ¨¡æ¿æ•°æ®
        document.getElementById('displayName').value = template.display_name;
        document.getElementById('modelName').value = template.model_name;
        document.getElementById('apiUrl').value = template.api_url || '';
        
        // å¡«å……é«˜çº§é…ç½®
        if (template.advanced_config) {
            const config = template.advanced_config;
            document.getElementById('maxTokens').value = config.max_tokens || 15000;
            document.getElementById('temperature').value = config.temperature || 0.7;
            document.getElementById('enableDeepThinking').checked = config.enable_deep_thinking || false;
            document.getElementById('enableWebSearch').checked = config.enable_web_search || false;
            document.getElementById('thinkingSteps').value = config.thinking_steps || 3;
        }
    }
}

// åˆ‡æ¢APIå¯†é’¥æ˜¾ç¤º
function toggleApiKeyVisibility(inputId) {
    const input = document.getElementById(inputId);
    const button = input.nextElementSibling;
    const icon = button.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

// æµ‹è¯•é…ç½®
function testConfig() {
    const formData = new FormData(document.getElementById('createConfigForm'));
    const configData = Object.fromEntries(formData.entries());
    
    // æ„å»ºé«˜çº§é…ç½®
    const advancedConfig = {
        max_tokens: parseInt(configData.max_tokens),
        temperature: parseFloat(configData.temperature),
        enable_deep_thinking: configData.enable_deep_thinking === 'on',
        enable_web_search: configData.enable_web_search === 'on',
        thinking_steps: parseInt(configData.thinking_steps)
    };
    
    const testData = {
        provider_name: configData.provider_name,
        api_key: configData.api_key,
        model_name: configData.model_name,
        api_url: configData.api_url,
        advanced_config: advancedConfig
    };
    
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>æµ‹è¯•ä¸­...';
    button.disabled = true;
    
    // è¿™é‡Œå¯ä»¥è°ƒç”¨æµ‹è¯•APIï¼Œæš‚æ—¶æ¨¡æ‹Ÿ
    setTimeout(() => {
        showAlert('é…ç½®æµ‹è¯•æˆåŠŸï¼', 'success');
        button.innerHTML = originalText;
        button.disabled = false;
    }, 2000);
}

// åˆ›å»ºé…ç½®
function createConfig() {
    const formData = new FormData(document.getElementById('createConfigForm'));
    const configData = Object.fromEntries(formData.entries());
    
    // æ„å»ºé«˜çº§é…ç½®
    const advancedConfig = {
        max_tokens: parseInt(configData.max_tokens),
        temperature: parseFloat(configData.temperature),
        enable_deep_thinking: configData.enable_deep_thinking === 'on',
        enable_web_search: configData.enable_web_search === 'on',
        thinking_steps: parseInt(configData.thinking_steps)
    };
    
    const requestData = {
        provider_name: configData.provider_name,
        display_name: configData.display_name,
        api_key: configData.api_key,
        model_name: configData.model_name,
        api_url: configData.api_url,
        advanced_config: advancedConfig,
        is_active: configData.is_active === 'on',
        is_default: configData.is_default === 'on'
    };
    
    const submitButton = document.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>åˆ›å»ºä¸­...';
    submitButton.disabled = true;
    
    fetch('/api/ai-config/configs', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('é…ç½®åˆ›å»ºæˆåŠŸï¼', 'success');
            setTimeout(() => {
                window.location.href = '/admin/ai-configs';
            }, 1500);
        } else {
            showAlert('åˆ›å»ºå¤±è´¥: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('åˆ›å»ºé…ç½®å¤±è´¥:', error);
        showAlert('åˆ›å»ºé…ç½®å¤±è´¥', 'danger');
    })
    .finally(() => {
        submitButton.innerHTML = originalText;
        submitButton.disabled = false;
    });
}

// æ˜¾ç¤ºæç¤ºä¿¡æ¯
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
            <span aria-hidden="true">&times;</span>
        </button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}
</script>
{% endblock %}
