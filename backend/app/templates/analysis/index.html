{% extends "base.html" %}

{% block title %}AI分析 - 智策股析{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-robot me-2"></i>AI智能分析
            </h1>
            <p class="text-muted mb-4">使用先进的大语言模型为您提供专业的股票分析报告</p>
        </div>
    </div>

    <!-- 分析选项 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>分析设置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="analysisType" class="form-label">分析类型</label>
                                <select class="form-select" id="analysisType">
                                    <option value="default">综合分析</option>
                                    <option value="fundamental">基本面分析</option>
                                    <option value="technical">技术面分析</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="aiProvider" class="form-label">AI模型</label>
                                <select class="form-select" id="aiProvider">
                                    <option value="gemini">Gemini (推荐)</option>
                                    <option value="chatgpt">ChatGPT</option>
                                    <option value="qwen">Qwen</option>
                                    <option value="deepseek">DeepSeek</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">快速操作</label>
                                <div class="d-grid">
                                    <button id="batchAnalyzeBtn" class="btn btn-primary">
                                        <i class="fas fa-magic me-2"></i>批量分析所有
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 关注列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>关注股票列表
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="watchlistCount">{{ watchlist|length }}</span>
                        <span class="text-muted ms-2">支股票</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if watchlist %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>股票代码</th>
                                        <th>公司名称</th>
                                        <th>市场</th>
                                        <th>行业</th>
                                        <th>关注时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist %}
                                    <tr>
                                        <td>
                                            <code class="text-primary">{{ item.stock.code }}</code>
                                        </td>
                                        <td>{{ item.stock.name }}</td>
                                        <td>
                                            {% if item.stock.market == 'US' %}
                                                <span class="badge bg-primary">美股</span>
                                            {% else %}
                                                <span class="badge bg-success">港股</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.stock.industry or '未知' }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.added_at }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary analyze-btn" 
                                                        data-stock-code="{{ item.stock.code }}"
                                                        data-stock-name="{{ item.stock.name }}">
                                                    <i class="fas fa-chart-line me-1"></i>分析
                                                </button>
                                                <a href="{{ url_for('reports.index') }}?stock={{ item.stock.code }}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-file-alt me-1"></i>报告
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 操作说明 -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>操作说明</h6>
                                <ul class="mb-0">
                                    <li><strong>单股分析：</strong>点击每行右侧的"分析"按钮，对单个股票进行AI分析</li>
                                    <li><strong>批量分析：</strong>点击上方的"批量分析所有"按钮，一次性分析所有关注的股票</li>
                                    <li><strong>查看报告：</strong>点击"报告"按钮查看该股票的历史分析报告</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">您还没有关注任何股票</h5>
                            <p class="text-muted">请先添加股票到关注列表，然后进行AI分析</p>
                            <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>添加股票
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析进度 -->
<div id="analysisProgress" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>分析进度
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center">准备开始分析...</div>
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- 分析结果模态框 -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>分析结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" id="viewFullReport" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>查看完整报告
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.progress {
    height: 25px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 15px;
}

.progress-bar {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 15px;
}

.analysis-result-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.analysis-result-success {
    background: rgba(40, 167, 69, 0.1);
    border-left-color: #28a745;
}

.analysis-result-error {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
}

.analysis-result-pending {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let analysisQueue = [];
    let currentAnalysisIndex = 0;
    let analysisResults = [];
    
    // 单个股票分析
    $('.analyze-btn').click(function() {
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const stockName = btn.data('stock-name');
        const analysisType = $('#analysisType').val();
        
        // 禁用按钮
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>分析中...');
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stockCode,
                analysis_type: analysisType
            }),
            success: function(response) {
                if (response.success) {
                    showToast('success', `${stockCode} 分析完成！`);
                    
                    // 显示分析结果
                    showAnalysisResult(stockCode, stockName, response.data);
                } else {
                    showToast('error', `${stockCode} 分析失败: ${response.message}`);
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', `${stockCode} 分析失败: ${response?.message || '网络错误'}`);
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-chart-line me-1"></i>分析');
            }
        });
    });
    
    // 批量分析
    $('#batchAnalyzeBtn').click(function() {
        const btn = $(this);
        const analysisType = $('#analysisType').val();
        
        if ($('.analyze-btn').length === 0) {
            showToast('error', '请先添加股票到关注列表');
            return;
        }
        
        if (confirmAction) {
            confirmAction(
                '批量分析',
                `确定要分析所有关注的股票吗？\n分析类型：${getAnalysisTypeName(analysisType)}\n预计需要几分钟时间。`,
                function() {
                    startBatchAnalysis(analysisType);
                }
            );
        } else {
            if (confirm(`确定要分析所有关注的股票吗？\n分析类型：${getAnalysisTypeName(analysisType)}\n预计需要几分钟时间。`)) {
                startBatchAnalysis(analysisType);
            }
        }
    });
    
    function startBatchAnalysis(analysisType) {
        const btn = $('#batchAnalyzeBtn');
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>分析中...');
        
        // 准备分析队列
        analysisQueue = [];
        $('.analyze-btn').each(function() {
            analysisQueue.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        currentAnalysisIndex = 0;
        analysisResults = [];
        
        // 显示进度
        $('#analysisProgress').show();
        updateProgress();
        
        // 开始分析
        processNextAnalysis(analysisType);
    }
    
    function processNextAnalysis(analysisType) {
        if (currentAnalysisIndex >= analysisQueue.length) {
            // 分析完成
            completeBatchAnalysis();
            return;
        }
        
        const stock = analysisQueue[currentAnalysisIndex];
        updateProgressText(`正在分析 ${stock.code} (${stock.name})...`);
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stock.code,
                analysis_type: analysisType
            }),
            success: function(response) {
                const result = {
                    stock: stock,
                    success: response.success,
                    data: response.data,
                    error: response.message
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                const result = {
                    stock: stock,
                    success: false,
                    error: response?.message || '网络错误'
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            }
        });
    }
    
    function updateProgress() {
        const progress = (currentAnalysisIndex / analysisQueue.length) * 100;
        $('#progressBar').css('width', progress + '%');
        $('#progressBar').text(Math.round(progress) + '%');
    }
    
    function updateProgressText(text) {
        $('#progressText').text(text);
        updateProgress();
    }
    
    function updateAnalysisResults() {
        const resultsContainer = $('#analysisResults');
        resultsContainer.empty();
        
        analysisResults.forEach(function(result, index) {
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            const statusText = result.success ? '成功' : '失败';
            
            const resultHtml = `
                <div class="analysis-result-item analysis-result-${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${statusIcon} me-2"></i>
                            <strong>${result.stock.code}</strong> - ${result.stock.name}
                        </div>
                        <span class="badge bg-${result.success ? 'success' : 'danger'}">${statusText}</span>
                    </div>
                    ${result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                </div>
            `;
            resultsContainer.append(resultHtml);
        });
    }
    
    function completeBatchAnalysis() {
        const successCount = analysisResults.filter(r => r.success).length;
        const totalCount = analysisResults.length;
        
        updateProgressText(`分析完成！成功 ${successCount}/${totalCount}`);
        $('#progressBar').removeClass('progress-bar-animated');
        
        // 重新启用按钮
        $('#batchAnalyzeBtn').prop('disabled', false);
        $('#batchAnalyzeBtn').html('<i class="fas fa-magic me-2"></i>批量分析所有');
        
        // 显示完成消息
        showToast('success', `批量分析完成！成功 ${successCount}/${totalCount} 支股票`);
        
        // 3秒后隐藏进度
        setTimeout(function() {
            $('#analysisProgress').fadeOut();
        }, 3000);
    }
    
    function showAnalysisResult(stockCode, stockName, reportData) {
        // 显示分析结果模态框
        const content = `
            <h4>${stockName} (${stockCode}) 分析报告</h4>
            <div class="mb-3">
                <span class="badge bg-primary">${reportData.provider || 'AI'}</span>
                <span class="badge bg-secondary">${reportData.analysis_date}</span>
            </div>
            <div class="analysis-preview">
                ${reportData.content.substring(0, 500)}...
            </div>
        `;
        
        $('#analysisResultContent').html(content);
        $('#viewFullReport').attr('href', `/reports/${stockCode}`);
        
        const modal = new bootstrap.Modal(document.getElementById('analysisResultModal'));
        modal.show();
    }
    
    function getAnalysisTypeName(type) {
        const types = {
            'default': '综合分析',
            'fundamental': '基本面分析',
            'technical': '技术面分析'
        };
        return types[type] || '综合分析';
    }
    
    // 显示Toast消息
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // 自动消失
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
