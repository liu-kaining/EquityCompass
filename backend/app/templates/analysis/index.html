{% extends "base.html" %}

{% block title %}AIåˆ†æ - æ™ºç­–è‚¡æ{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-robot me-2"></i>AIæ™ºèƒ½åˆ†æ
            </h1>
            <p class="text-muted mb-4">ä½¿ç”¨å…ˆè¿›çš„å¤§è¯­è¨€æ¨¡å‹ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è‚¡ç¥¨åˆ†ææŠ¥å‘Š</p>
        </div>
    </div>

    <!-- ä½¿ç”¨é‡æ˜¾ç¤º -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm" id="usageCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-chart-bar me-2"></i>ä»Šæ—¥åˆ†ææ¬¡æ•°
                            </h6>
                            <span class="h5 mb-0" id="usageDisplay">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="text-end">
                            <div class="progress" style="width: 120px; height: 8px;">
                                <div class="progress-bar" id="usageProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block" id="usageHint">æ¯æ—¥é™é¢ï¼š10æ¬¡</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†æé€‰é¡¹ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>åˆ†æè®¾ç½®
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="analysisType" class="form-label">
                                    <i class="fas fa-chart-line me-2"></i>åˆ†æç±»å‹
                                </label>
                                <select class="form-select" id="analysisType">
                                    <option value="fundamental">ğŸ“Š åŸºæœ¬é¢åˆ†æ</option>
                                    <option value="technical">ğŸ“ˆ æŠ€æœ¯é¢åˆ†æ</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="aiProvider" class="form-label">
                                    <i class="fas fa-robot me-2"></i>AIæ¨¡å‹
                                </label>
                                <div class="custom-select-wrapper">
                                    <select class="form-select custom-select" id="aiProvider">
                                        <option value="gemini" data-icon="ğŸ¤–">
                                            <i class="fas fa-robot"></i> Gemini (æ¨è)
                                        </option>
                                        <option value="qwen" data-icon="ğŸŒŸ">
                                            <i class="fas fa-star"></i> Qwen
                                        </option>
                                        <option value="deepseek" data-icon="ğŸš€">
                                            <i class="fas fa-rocket"></i> DeepSeek
                                        </option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">å¿«é€Ÿæ“ä½œ</label>
                                <div class="d-grid gap-2">
                                    <button id="batchAnalyzeBtn" class="btn btn-primary">
                                        <i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰
                                    </button>
                                    <a href="{{ url_for('analysis.tasks') }}" class="btn btn-outline-info">
                                        <i class="fas fa-tasks me-2"></i>æŸ¥çœ‹ä»»åŠ¡
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³æ³¨åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>å…³æ³¨è‚¡ç¥¨åˆ—è¡¨
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="watchlistCount">{{ watchlist|length }}</span>
                        <span class="text-muted ms-2">æ”¯è‚¡ç¥¨</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if watchlist %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è‚¡ç¥¨ä»£ç </th>
                                        <th>å…¬å¸åç§°</th>
                                        <th>å¸‚åœº</th>
                                        <th>è¡Œä¸š</th>
                                        <th>å…³æ³¨æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist %}
                                    <tr>
                                        <td>
                                            <code class="text-primary">{{ item.stock.code }}</code>
                                        </td>
                                        <td>{{ item.stock.name }}</td>
                                        <td>
                                            {% if item.stock.market == 'US' %}
                                                <span class="badge bg-primary">ç¾è‚¡</span>
                                            {% else %}
                                                <span class="badge bg-success">æ¸¯è‚¡</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.stock.industry or 'æœªçŸ¥' }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.added_at }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary analyze-btn" 
                                                        data-stock-code="{{ item.stock.code }}"
                                                        data-stock-name="{{ item.stock.name }}">
                                                    <i class="fas fa-chart-line me-1"></i>åˆ†æ
                                                </button>
                                                <a href="{{ url_for('reports.index') }}?stock={{ item.stock.code }}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-file-alt me-1"></i>æŠ¥å‘Š
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- æ“ä½œè¯´æ˜ -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>æ“ä½œè¯´æ˜</h6>
                                <ul class="mb-0">
                                    <li><strong>å•è‚¡åˆ†æï¼š</strong>ç‚¹å‡»æ¯è¡Œå³ä¾§çš„"åˆ†æ"æŒ‰é’®ï¼Œå¯¹å•ä¸ªè‚¡ç¥¨è¿›è¡ŒAIåˆ†æ</li>
                                    <li><strong>æ‰¹é‡åˆ†æï¼š</strong>ç‚¹å‡»ä¸Šæ–¹çš„"æ‰¹é‡åˆ†ææ‰€æœ‰"æŒ‰é’®ï¼Œä¸€æ¬¡æ€§åˆ†ææ‰€æœ‰å…³æ³¨çš„è‚¡ç¥¨</li>
                                    <li><strong>æŸ¥çœ‹æŠ¥å‘Šï¼š</strong>ç‚¹å‡»"æŠ¥å‘Š"æŒ‰é’®æŸ¥çœ‹è¯¥è‚¡ç¥¨çš„å†å²åˆ†ææŠ¥å‘Š</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">æ‚¨è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•è‚¡ç¥¨</h5>
                            <p class="text-muted">è¯·å…ˆæ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨ï¼Œç„¶åè¿›è¡ŒAIåˆ†æ</p>
                            <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>æ·»åŠ è‚¡ç¥¨
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æè¿›åº¦ -->
<div id="analysisProgress" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>åˆ†æè¿›åº¦
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center">å‡†å¤‡å¼€å§‹åˆ†æ...</div>
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>åˆ†æç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <a href="#" id="viewFullReport" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤åˆ†æå¼¹çª— -->
<div class="modal fade" id="confirmAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>ç¡®è®¤åˆ†æ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h6 id="confirmStockInfo">ç¡®è®¤åˆ†æ AAPL - è‹¹æœå…¬å¸ï¼Ÿ</h6>
                    <p class="text-muted">åˆ†æä¸€æ¬¡å°†æ¶ˆè€—æ‚¨ä»Šæ—¥çš„1æ¬¡åˆ†æé¢åº¦</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>å‰©ä½™æ¬¡æ•°ï¼š</strong><span id="confirmRemaining">9æ¬¡</span>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" id="confirmAnalysisBtn">
                    <i class="fas fa-check me-2"></i>ç¡®è®¤åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡å®Œæˆå¼¹çª— -->
<div class="modal fade" id="taskCompletedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-check-circle text-success me-2"></i>ä»»åŠ¡æäº¤æˆåŠŸ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                    <h6 class="text-success">æ‰¹é‡åˆ†æä»»åŠ¡å·²æˆåŠŸæäº¤ï¼</h6>
                    <p class="text-muted">æ‚¨çš„åˆ†æä»»åŠ¡æ­£åœ¨åå°è¿è¡Œï¼Œå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ã€‚</p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>æç¤ºï¼š</strong>æ‚¨å¯ä»¥éšæ—¶åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹è¿›åº¦å’Œç»“æœã€‚
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ç»§ç»­åˆ†æ
                </button>
                <a href="/reports/" class="btn btn-primary">
                    <i class="fas fa-chart-line me-2"></i>æŸ¥çœ‹æŠ¥å‘Š
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.progress {
    height: 25px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 15px;
}

.progress-bar {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 15px;
}

.analysis-result-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.analysis-result-success {
    background: rgba(40, 167, 69, 0.1);
    border-left-color: #28a745;
}

.analysis-result-error {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
}

.analysis-result-pending {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let analysisQueue = [];
    let currentAnalysisIndex = 0;
    let analysisResults = [];
    let currentUsageData = null;
    let pendingAnalysis = null;
    
    // é¡µé¢åŠ è½½æ—¶è·å–ä½¿ç”¨é‡
    loadUsageData();
    
    // è·å–ä½¿ç”¨é‡æ•°æ®
    function loadUsageData() {
        $.ajax({
            url: '/api/analysis/usage',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    currentUsageData = response.usage;
                    updateUsageDisplay(currentUsageData);
                }
            },
            error: function(xhr, status, error) {
                console.error('è·å–ä½¿ç”¨é‡å¤±è´¥:', error);
                $('#usageDisplay').text('è·å–å¤±è´¥');
            }
        });
    }
    
    // æ›´æ–°ä½¿ç”¨é‡æ˜¾ç¤º
    function updateUsageDisplay(usage) {
        const current = usage.current_count;
        const limit = usage.daily_limit;
        const remaining = usage.remaining;
        const percentage = (current / limit) * 100;
        
        $('#usageDisplay').text(`${current}/${limit}`);
        $('#usageProgress').css('width', `${Math.min(percentage, 100)}%`);
        
        if (usage.is_admin) {
            $('#usageHint').text('ç®¡ç†å‘˜æ— é™åˆ¶');
            $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
        } else {
            $('#usageHint').text(`æ¯æ—¥é™é¢ï¼š${limit}æ¬¡`);
            
            if (percentage >= 100) {
                $('#usageProgress').removeClass('bg-success bg-warning').addClass('bg-danger');
            } else if (percentage >= 80) {
                $('#usageProgress').removeClass('bg-success bg-danger').addClass('bg-warning');
            } else {
                $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
            }
        }
    }
    
    // å•ä¸ªè‚¡ç¥¨åˆ†æ
    $('.analyze-btn').click(function() {
        console.log('åˆ†ææŒ‰é’®è¢«ç‚¹å‡»');
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const stockName = btn.data('stock-name');
        
        // æ£€æŸ¥ä½¿ç”¨é‡é™åˆ¶
        if (currentUsageData && !currentUsageData.is_admin && !currentUsageData.can_analyze) {
            showToast('error', `ä»Šæ—¥åˆ†ææ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${currentUsageData.daily_limit}æ¬¡ï¼‰ï¼Œè¯·æ˜å¤©å†è¯•`);
            return;
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        showConfirmAnalysis(stockCode, stockName, btn);
    });
    
    // æ˜¾ç¤ºç¡®è®¤åˆ†æå¼¹çª—
    function showConfirmAnalysis(stockCode, stockName, btn) {
        pendingAnalysis = { stockCode, stockName, btn };
        
        $('#confirmStockInfo').text(`ç¡®è®¤åˆ†æ ${stockCode} - ${stockName}ï¼Ÿ`);
        
        if (currentUsageData && currentUsageData.is_admin) {
            $('#confirmRemaining').text('æ— é™åˆ¶');
        } else if (currentUsageData) {
            $('#confirmRemaining').text(`${currentUsageData.remaining}æ¬¡`);
        } else {
            $('#confirmRemaining').text('åŠ è½½ä¸­...');
        }
        
        $('#confirmAnalysisModal').modal('show');
    }
    
    // ç¡®è®¤åˆ†ææŒ‰é’®ç‚¹å‡»
    $('#confirmAnalysisBtn').click(function() {
        if (!pendingAnalysis) return;
        
        $('#confirmAnalysisModal').modal('hide');
        executeAnalysis(pendingAnalysis.stockCode, pendingAnalysis.stockName, pendingAnalysis.btn);
        pendingAnalysis = null;
    });
    
    // æ‰§è¡Œåˆ†æï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    function executeAnalysis(stockCode, stockName, btn) {
        const analysisType = $('#analysisType').val();
        const aiProvider = $('#aiProvider').val();
        
        console.log('è‚¡ç¥¨ä»£ç :', stockCode);
        console.log('è‚¡ç¥¨åç§°:', stockName);
        console.log('åˆ†æç±»å‹:', analysisType);
        console.log('AIæ¨¡å‹:', aiProvider);
        
        // ç¦ç”¨æŒ‰é’®
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>æäº¤ä¸­...');
        
        console.log('å‘é€åˆ†æè¯·æ±‚åˆ°:', '/api/analysis/analyze');
        
        // å‘é€åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stockCode,
                analysis_type: analysisType,
                ai_provider: aiProvider
            }),
            success: function(response) {
                console.log('åˆ†æè¯·æ±‚æˆåŠŸ:', response);
                if (response.success) {
                    showToast('success', `${stockCode} åˆ†æä»»åŠ¡å·²æäº¤ï¼è¯·ç¨åæŸ¥çœ‹ç»“æœã€‚`);
                    
                    // æ›´æ–°ä½¿ç”¨é‡
                    loadUsageData();
                    
                    // æ˜¾ç¤ºä»»åŠ¡æäº¤æˆåŠŸæç¤º
                    showTaskSubmittedModal(stockCode, response.data.task_id);
                } else {
                    showToast('error', `${stockCode} åˆ†æå¤±è´¥: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error('åˆ†æè¯·æ±‚å¤±è´¥:', xhr, status, error);
                const response = xhr.responseJSON;
                
                if (response && response.error === 'DAILY_LIMIT_REACHED') {
                    showToast('error', `ä»Šæ—¥åˆ†ææ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${response.data?.daily_limit || 10}æ¬¡ï¼‰ï¼Œè¯·æ˜å¤©å†è¯•`);
                    // æ›´æ–°ä½¿ç”¨é‡æ˜¾ç¤º
                    if (response.data) {
                        updateUsageDisplay(response.data);
                    }
                } else {
                    showToast('error', `${stockCode} åˆ†æå¤±è´¥: ${response?.message || 'ç½‘ç»œé”™è¯¯'}`);
                }
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-chart-line me-1"></i>åˆ†æ');
            }
        });
    }
    
    // æ˜¾ç¤ºä»»åŠ¡æäº¤æˆåŠŸå¼¹çª—
    function showTaskSubmittedModal(stockCode, taskId) {
        const modal = `
            <div class="modal fade" id="singleTaskSubmittedModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content glass-effect">
                        <div class="modal-header border-0 text-center">
                            <h5 class="modal-title w-100">
                                <i class="fas fa-check-circle text-success me-2"></i>ä»»åŠ¡æäº¤æˆåŠŸ
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                <h6 class="text-success">${stockCode} åˆ†æä»»åŠ¡å·²æˆåŠŸæäº¤ï¼</h6>
                                <p class="text-muted">æ‚¨çš„åˆ†æä»»åŠ¡æ­£åœ¨åå°è¿è¡Œï¼Œå®Œæˆåå¯ä»¥åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹ç»“æœã€‚</p>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>ä»»åŠ¡IDï¼š</strong>${taskId}
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>ç»§ç»­åˆ†æ
                            </button>
                            <a href="/reports/" class="btn btn-primary">
                                <i class="fas fa-chart-line me-2"></i>æŸ¥çœ‹æŠ¥å‘Š
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤ä¹‹å‰çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        $('#singleTaskSubmittedModal').remove();
        
        // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†åˆ°é¡µé¢
        $('body').append(modal);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const taskModal = new bootstrap.Modal(document.getElementById('singleTaskSubmittedModal'));
        taskModal.show();
        
        // æ¨¡æ€æ¡†å…³é—­åæ¸…ç†
        $('#singleTaskSubmittedModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }
    
    // æ‰¹é‡åˆ†æ
    $('#batchAnalyzeBtn').click(function() {
        const btn = $(this);
        const analysisType = $('#analysisType').val();
        
        if ($('.analyze-btn').length === 0) {
            showToast('error', 'è¯·å…ˆæ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨');
            return;
        }
        
        // æ”¶é›†è¦åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // æ„å»ºç¾è§‚çš„ç¡®è®¤ä¿¡æ¯
        const stockList = stocksToAnalyze.map(stock => `â€¢ ${stock.code} (${stock.name})`).join('\n');
        const estimatedTime = Math.ceil(stocksToAnalyze.length * 0.5); // æ¯åªè‚¡ç¥¨çº¦30ç§’
        const analysisTypeName = getAnalysisTypeName(analysisType);
        
        const confirmMessage = `ğŸ¯ æ‰¹é‡åˆ†æä»»åŠ¡ç¡®è®¤

ğŸ“Š åˆ†æç±»å‹ï¼š${analysisTypeName}
â±ï¸ é¢„è®¡æ—¶é—´ï¼šçº¦ ${estimatedTime} åˆ†é’Ÿ
ğŸ¤– AIæ¨¡å‹ï¼š${$('#aiProvider option:selected').text()}

ğŸ“‹ å¾…åˆ†æè‚¡ç¥¨ (${stocksToAnalyze.length} åª)ï¼š
${stockList}

ğŸ’¡ æç¤ºï¼šåˆ†æå°†åœ¨åå°å¼‚æ­¥è¿›è¡Œï¼Œæ‚¨å¯ä»¥ç¦»å¼€é¡µé¢åšå…¶ä»–äº‹æƒ…ã€‚åˆ†æå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹ç»“æœã€‚`;
        
        if (confirmAction) {
            confirmAction(
                'ğŸš€ æ‰¹é‡åˆ†æç¡®è®¤',
                confirmMessage,
                function() {
                    startBatchAnalysis(analysisType);
                }
            );
        } else {
            if (confirm(confirmMessage)) {
                startBatchAnalysis(analysisType);
            }
        }
    });
    
    function startBatchAnalysis(analysisType) {
        const btn = $('#batchAnalyzeBtn');
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä»»åŠ¡ä¸­...');
        
        // æ”¶é›†è¦åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // å‘é€å¼‚æ­¥æ‰¹é‡åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/batch-analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stocks: stocksToAnalyze,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val()
            }),
            success: function(response) {
                if (response.success) {
                    showToast('success', `æ‰¹é‡åˆ†æä»»åŠ¡å·²æäº¤ï¼ä»»åŠ¡ID: ${response.task_id}\nåˆ†æå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ã€‚`);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
                    
                    // å¯ä»¥é€‰æ‹©è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
                    setTimeout(function() {
                        // æ˜¾ç¤ºç¾è§‚çš„ä»»åŠ¡å®Œæˆå¼¹çª—
                        const taskCompletedModal = new bootstrap.Modal(document.getElementById('taskCompletedModal'));
                        taskCompletedModal.show();
                    }, 1000);
                } else {
                    showToast('error', response.message || 'æäº¤æ‰¹é‡åˆ†æä»»åŠ¡å¤±è´¥');
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
            }
        });
    }
    
    function processNextAnalysis(analysisType) {
        if (currentAnalysisIndex >= analysisQueue.length) {
            // åˆ†æå®Œæˆ
            completeBatchAnalysis();
            return;
        }
        
        const stock = analysisQueue[currentAnalysisIndex];
        updateProgressText(`æ­£åœ¨åˆ†æ ${stock.code} (${stock.name})...`);
        
        // å‘é€åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stock.code,
                analysis_type: analysisType
            }),
            success: function(response) {
                const result = {
                    stock: stock,
                    success: response.success,
                    data: response.data,
                    error: response.message
                };
                analysisResults.push(result);
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                updateAnalysisResults();
                
                // ç»§ç»­ä¸‹ä¸€ä¸ª
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                const result = {
                    stock: stock,
                    success: false,
                    error: response?.message || 'ç½‘ç»œé”™è¯¯'
                };
                analysisResults.push(result);
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                updateAnalysisResults();
                
                // ç»§ç»­ä¸‹ä¸€ä¸ª
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            }
        });
    }
    
    function updateProgress() {
        const progress = (currentAnalysisIndex / analysisQueue.length) * 100;
        $('#progressBar').css('width', progress + '%');
        $('#progressBar').text(Math.round(progress) + '%');
    }
    
    function updateProgressText(text) {
        $('#progressText').text(text);
        updateProgress();
    }
    
    function updateAnalysisResults() {
        const resultsContainer = $('#analysisResults');
        resultsContainer.empty();
        
        analysisResults.forEach(function(result, index) {
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            const statusText = result.success ? 'æˆåŠŸ' : 'å¤±è´¥';
            
            const resultHtml = `
                <div class="analysis-result-item analysis-result-${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${statusIcon} me-2"></i>
                            <strong>${result.stock.code}</strong> - ${result.stock.name}
                        </div>
                        <span class="badge bg-${result.success ? 'success' : 'danger'}">${statusText}</span>
                    </div>
                    ${result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                </div>
            `;
            resultsContainer.append(resultHtml);
        });
    }
    
    function completeBatchAnalysis() {
        const successCount = analysisResults.filter(r => r.success).length;
        const totalCount = analysisResults.length;
        
        updateProgressText(`åˆ†æå®Œæˆï¼æˆåŠŸ ${successCount}/${totalCount}`);
        $('#progressBar').removeClass('progress-bar-animated');
        
        // é‡æ–°å¯ç”¨æŒ‰é’®
        $('#batchAnalyzeBtn').prop('disabled', false);
        $('#batchAnalyzeBtn').html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
        
        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        showToast('success', `æ‰¹é‡åˆ†æå®Œæˆï¼æˆåŠŸ ${successCount}/${totalCount} æ”¯è‚¡ç¥¨`);
        
        // 3ç§’åéšè—è¿›åº¦
        setTimeout(function() {
            $('#analysisProgress').fadeOut();
        }, 3000);
    }
    
    function showAnalysisResult(stockCode, stockName, reportData) {
        // æ˜¾ç¤ºåˆ†æç»“æœæ¨¡æ€æ¡†
        const content = `
            <div class="analysis-result-header mb-3">
                <h4 class="mb-2">${stockName} (${stockCode}) åˆ†ææŠ¥å‘Š</h4>
                <div class="mb-3">
                    <span class="badge bg-primary me-2">${reportData.provider || 'AI'}</span>
                    <span class="badge bg-secondary me-2">${reportData.analysis_date}</span>
                    <span class="badge bg-info">${reportData.metadata?.model || 'AIæ¨¡å‹'}</span>
                </div>
            </div>
            <div class="analysis-content">
                <div class="analysis-preview mb-3">
                    <h6>åˆ†æå†…å®¹é¢„è§ˆï¼š</h6>
                    <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        ${formatAnalysisContent(reportData.content)}
                    </div>
                </div>
                <div class="analysis-actions">
                    <a href="/reports/${stockCode}" class="btn btn-primary me-2" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                    </a>
                    <button class="btn btn-outline-secondary me-2" onclick="downloadReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-download me-1"></i>ä¸‹è½½æŠ¥å‘Š
                    </button>
                    <button class="btn btn-outline-info" onclick="shareReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-share me-1"></i>åˆ†äº«æŠ¥å‘Š
                    </button>
                </div>
            </div>
        `;
        
        $('#analysisResultContent').html(content);
        
        const modal = new bootstrap.Modal(document.getElementById('analysisResultModal'));
        modal.show();
    }
    
    function formatAnalysisContent(content) {
        // ç®€å•çš„Markdownæ ¼å¼åŒ–
        return content
            .replace(/#{1,6}\s+(.+)/g, '<strong>$1</strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }
    
    function downloadReport(stockCode, stockName) {
        // ä¸‹è½½æŠ¥å‘ŠåŠŸèƒ½
        const link = document.createElement('a');
        link.href = `/api/analysis/reports/${stockCode}/download`;
        link.download = `${stockCode}_${stockName}_åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function shareReport(stockCode, stockName) {
        // åˆ†äº«æŠ¥å‘ŠåŠŸèƒ½
        const url = `${window.location.origin}/reports/${stockCode}`;
        if (navigator.share) {
            navigator.share({
                title: `${stockName} (${stockCode}) åˆ†ææŠ¥å‘Š`,
                text: `æŸ¥çœ‹ ${stockName} çš„AIåˆ†ææŠ¥å‘Š`,
                url: url
            });
        } else {
            // å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
            navigator.clipboard.writeText(url).then(function() {
                showToast('success', 'æŠ¥å‘Šé“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }
    }
    
    function getAnalysisTypeName(type) {
        const types = {
            'fundamental': 'åŸºæœ¬é¢åˆ†æ',
            'technical': 'æŠ€æœ¯é¢åˆ†æ'
        };
        return types[type] || 'ç»¼åˆåˆ†æ';
    }
    
    // æ˜¾ç¤ºToastæ¶ˆæ¯
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
