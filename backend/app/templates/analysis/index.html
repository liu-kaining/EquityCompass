{% extends "base.html" %}

{% block title %}AI分析 - 智策股析{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-robot me-2"></i>AI智能分析
            </h1>
            <p class="text-muted mb-4">使用先进的大语言模型为您提供专业的股票分析报告</p>
        </div>
    </div>

    <!-- 使用量显示 -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card border-0 shadow-sm" id="usageCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-chart-bar me-2"></i>今日分析次数
                            </h6>
                            <span class="h5 mb-0" id="usageDisplay">加载中...</span>
                        </div>
                        <div class="text-end">
                            <div class="progress" style="width: 120px; height: 8px;">
                                <div class="progress-bar" id="usageProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block" id="usageHint">每日限额：10次</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析选项 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs me-2"></i>分析设置
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="analysisType" class="form-label">
                                    <i class="fas fa-chart-line me-2"></i>分析类型
                                </label>
                                <select class="form-select" id="analysisType">
                                    <option value="fundamental">📊 基本面分析</option>
                                    <option value="technical">📈 技术面分析</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label for="aiProvider" class="form-label">
                                    <i class="fas fa-robot me-2"></i>AI模型
                                </label>
                                <div class="custom-select-wrapper">
                                    <select class="form-select custom-select" id="aiProvider">
                                        <option value="gemini" data-icon="🤖">
                                            <i class="fas fa-robot"></i> Gemini (推荐)
                                        </option>
                                        <option value="qwen" data-icon="🌟">
                                            <i class="fas fa-star"></i> Qwen
                                        </option>
                                        <option value="deepseek" data-icon="🚀">
                                            <i class="fas fa-rocket"></i> DeepSeek
                                        </option>
                                    </select>
                                    <div class="select-arrow">
                                        <i class="fas fa-chevron-down"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class="form-label">快速操作</label>
                                <div class="d-grid gap-2">
                                    <button id="batchAnalyzeBtn" class="btn btn-primary">
                                        <i class="fas fa-magic me-2"></i>批量分析所有
                                    </button>
                                    <a href="{{ url_for('analysis.tasks') }}" class="btn btn-outline-info">
                                        <i class="fas fa-tasks me-2"></i>查看任务
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 关注列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>关注股票列表
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="watchlistCount">{{ watchlist|length }}</span>
                        <span class="text-muted ms-2">支股票</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if watchlist %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>股票代码</th>
                                        <th>公司名称</th>
                                        <th>市场</th>
                                        <th>行业</th>
                                        <th>关注时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist %}
                                    <tr>
                                        <td>
                                            <code class="text-primary">{{ item.stock.code }}</code>
                                        </td>
                                        <td>{{ item.stock.name }}</td>
                                        <td>
                                            {% if item.stock.market == 'US' %}
                                                <span class="badge bg-primary">美股</span>
                                            {% else %}
                                                <span class="badge bg-success">港股</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.stock.industry or '未知' }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.added_at }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary analyze-btn" 
                                                        data-stock-code="{{ item.stock.code }}"
                                                        data-stock-name="{{ item.stock.name }}">
                                                    <i class="fas fa-chart-line me-1"></i>分析
                                                </button>
                                                <a href="{{ url_for('reports.index') }}?stock={{ item.stock.code }}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-file-alt me-1"></i>报告
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 操作说明 -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>操作说明</h6>
                                <ul class="mb-0">
                                    <li><strong>单股分析：</strong>点击每行右侧的"分析"按钮，对单个股票进行AI分析</li>
                                    <li><strong>批量分析：</strong>点击上方的"批量分析所有"按钮，一次性分析所有关注的股票</li>
                                    <li><strong>查看报告：</strong>点击"报告"按钮查看该股票的历史分析报告</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">您还没有关注任何股票</h5>
                            <p class="text-muted">请先添加股票到关注列表，然后进行AI分析</p>
                            <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>添加股票
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析进度 -->
<div id="analysisProgress" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>分析进度
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center">准备开始分析...</div>
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- 分析结果模态框 -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>分析结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" id="viewFullReport" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>查看完整报告
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 确认分析弹窗 -->
<div class="modal fade" id="confirmAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>确认分析
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h6 id="confirmStockInfo">确认分析 AAPL - 苹果公司？</h6>
                    <p class="text-muted">分析一次将消耗您今日的1次分析额度</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>剩余次数：</strong><span id="confirmRemaining">9次</span>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmAnalysisBtn">
                    <i class="fas fa-check me-2"></i>确认分析
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务完成弹窗 -->
<div class="modal fade" id="taskCompletedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-check-circle text-success me-2"></i>任务提交成功
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                    <h6 class="text-success">批量分析任务已成功提交！</h6>
                    <p class="text-muted">您的分析任务正在后台运行，完成后会通过邮件通知您。</p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>提示：</strong>您可以随时在"分析报告"页面查看进度和结果。
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>继续分析
                </button>
                <a href="/reports/" class="btn btn-primary">
                    <i class="fas fa-chart-line me-2"></i>查看报告
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.progress {
    height: 25px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 15px;
}

.progress-bar {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 15px;
}

.analysis-result-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.analysis-result-success {
    background: rgba(40, 167, 69, 0.1);
    border-left-color: #28a745;
}

.analysis-result-error {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
}

.analysis-result-pending {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    let analysisQueue = [];
    let currentAnalysisIndex = 0;
    let analysisResults = [];
    let currentUsageData = null;
    let pendingAnalysis = null;
    
    // 页面加载时获取使用量
    loadUsageData();
    
    // 获取使用量数据
    function loadUsageData() {
        $.ajax({
            url: '/api/analysis/usage',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    currentUsageData = response.usage;
                    updateUsageDisplay(currentUsageData);
                }
            },
            error: function(xhr, status, error) {
                console.error('获取使用量失败:', error);
                $('#usageDisplay').text('获取失败');
            }
        });
    }
    
    // 更新使用量显示
    function updateUsageDisplay(usage) {
        const current = usage.current_count;
        const limit = usage.daily_limit;
        const remaining = usage.remaining;
        const percentage = (current / limit) * 100;
        
        $('#usageDisplay').text(`${current}/${limit}`);
        $('#usageProgress').css('width', `${Math.min(percentage, 100)}%`);
        
        if (usage.is_admin) {
            $('#usageHint').text('管理员无限制');
            $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
        } else {
            $('#usageHint').text(`每日限额：${limit}次`);
            
            if (percentage >= 100) {
                $('#usageProgress').removeClass('bg-success bg-warning').addClass('bg-danger');
            } else if (percentage >= 80) {
                $('#usageProgress').removeClass('bg-success bg-danger').addClass('bg-warning');
            } else {
                $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
            }
        }
    }
    
    // 单个股票分析
    $('.analyze-btn').click(function() {
        console.log('分析按钮被点击');
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const stockName = btn.data('stock-name');
        
        // 检查使用量限制
        if (currentUsageData && !currentUsageData.is_admin && !currentUsageData.can_analyze) {
            showToast('error', `今日分析次数已达上限（${currentUsageData.daily_limit}次），请明天再试`);
            return;
        }
        
        // 显示确认弹窗
        showConfirmAnalysis(stockCode, stockName, btn);
    });
    
    // 显示确认分析弹窗
    function showConfirmAnalysis(stockCode, stockName, btn) {
        pendingAnalysis = { stockCode, stockName, btn };
        
        $('#confirmStockInfo').text(`确认分析 ${stockCode} - ${stockName}？`);
        
        if (currentUsageData && currentUsageData.is_admin) {
            $('#confirmRemaining').text('无限制');
        } else if (currentUsageData) {
            $('#confirmRemaining').text(`${currentUsageData.remaining}次`);
        } else {
            $('#confirmRemaining').text('加载中...');
        }
        
        $('#confirmAnalysisModal').modal('show');
    }
    
    // 确认分析按钮点击
    $('#confirmAnalysisBtn').click(function() {
        if (!pendingAnalysis) return;
        
        $('#confirmAnalysisModal').modal('hide');
        executeAnalysis(pendingAnalysis.stockCode, pendingAnalysis.stockName, pendingAnalysis.btn);
        pendingAnalysis = null;
    });
    
    // 执行分析（异步任务）
    function executeAnalysis(stockCode, stockName, btn) {
        const analysisType = $('#analysisType').val();
        const aiProvider = $('#aiProvider').val();
        
        console.log('股票代码:', stockCode);
        console.log('股票名称:', stockName);
        console.log('分析类型:', analysisType);
        console.log('AI模型:', aiProvider);
        
        // 禁用按钮
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>提交中...');
        
        console.log('发送分析请求到:', '/api/analysis/analyze');
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stockCode,
                analysis_type: analysisType,
                ai_provider: aiProvider
            }),
            success: function(response) {
                console.log('分析请求成功:', response);
                if (response.success) {
                    showToast('success', `${stockCode} 分析任务已提交！请稍后查看结果。`);
                    
                    // 更新使用量
                    loadUsageData();
                    
                    // 显示任务提交成功提示
                    showTaskSubmittedModal(stockCode, response.data.task_id);
                } else {
                    showToast('error', `${stockCode} 分析失败: ${response.message}`);
                }
            },
            error: function(xhr, status, error) {
                console.error('分析请求失败:', xhr, status, error);
                const response = xhr.responseJSON;
                
                if (response && response.error === 'DAILY_LIMIT_REACHED') {
                    showToast('error', `今日分析次数已达上限（${response.data?.daily_limit || 10}次），请明天再试`);
                    // 更新使用量显示
                    if (response.data) {
                        updateUsageDisplay(response.data);
                    }
                } else {
                    showToast('error', `${stockCode} 分析失败: ${response?.message || '网络错误'}`);
                }
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-chart-line me-1"></i>分析');
            }
        });
    }
    
    // 显示任务提交成功弹窗
    function showTaskSubmittedModal(stockCode, taskId) {
        const modal = `
            <div class="modal fade" id="singleTaskSubmittedModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content glass-effect">
                        <div class="modal-header border-0 text-center">
                            <h5 class="modal-title w-100">
                                <i class="fas fa-check-circle text-success me-2"></i>任务提交成功
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                <h6 class="text-success">${stockCode} 分析任务已成功提交！</h6>
                                <p class="text-muted">您的分析任务正在后台运行，完成后可以在"分析报告"页面查看结果。</p>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>任务ID：</strong>${taskId}
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>继续分析
                            </button>
                            <a href="/reports/" class="btn btn-primary">
                                <i class="fas fa-chart-line me-2"></i>查看报告
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除之前的模态框（如果存在）
        $('#singleTaskSubmittedModal').remove();
        
        // 添加新的模态框到页面
        $('body').append(modal);
        
        // 显示模态框
        const taskModal = new bootstrap.Modal(document.getElementById('singleTaskSubmittedModal'));
        taskModal.show();
        
        // 模态框关闭后清理
        $('#singleTaskSubmittedModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }
    
    // 批量分析
    $('#batchAnalyzeBtn').click(function() {
        const btn = $(this);
        const analysisType = $('#analysisType').val();
        
        if ($('.analyze-btn').length === 0) {
            showToast('error', '请先添加股票到关注列表');
            return;
        }
        
        // 收集要分析的股票信息
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // 构建美观的确认信息
        const stockList = stocksToAnalyze.map(stock => `• ${stock.code} (${stock.name})`).join('\n');
        const estimatedTime = Math.ceil(stocksToAnalyze.length * 0.5); // 每只股票约30秒
        const analysisTypeName = getAnalysisTypeName(analysisType);
        
        const confirmMessage = `🎯 批量分析任务确认

📊 分析类型：${analysisTypeName}
⏱️ 预计时间：约 ${estimatedTime} 分钟
🤖 AI模型：${$('#aiProvider option:selected').text()}

📋 待分析股票 (${stocksToAnalyze.length} 只)：
${stockList}

💡 提示：分析将在后台异步进行，您可以离开页面做其他事情。分析完成后会通过邮件通知您，您也可以在"分析报告"页面查看结果。`;
        
        if (confirmAction) {
            confirmAction(
                '🚀 批量分析确认',
                confirmMessage,
                function() {
                    startBatchAnalysis(analysisType);
                }
            );
        } else {
            if (confirm(confirmMessage)) {
                startBatchAnalysis(analysisType);
            }
        }
    });
    
    function startBatchAnalysis(analysisType) {
        const btn = $('#batchAnalyzeBtn');
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>提交任务中...');
        
        // 收集要分析的股票信息
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // 发送异步批量分析请求
        $.ajax({
            url: '/api/analysis/batch-analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stocks: stocksToAnalyze,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val()
            }),
            success: function(response) {
                if (response.success) {
                    showToast('success', `批量分析任务已提交！任务ID: ${response.task_id}\n分析完成后会通过邮件通知您。`);
                    
                    // 恢复按钮状态
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
                    
                    // 可以选择跳转到报告页面
                    setTimeout(function() {
                        // 显示美观的任务完成弹窗
                        const taskCompletedModal = new bootstrap.Modal(document.getElementById('taskCompletedModal'));
                        taskCompletedModal.show();
                    }, 1000);
                } else {
                    showToast('error', response.message || '提交批量分析任务失败');
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || '网络错误，请稍后重试');
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
            }
        });
    }
    
    function processNextAnalysis(analysisType) {
        if (currentAnalysisIndex >= analysisQueue.length) {
            // 分析完成
            completeBatchAnalysis();
            return;
        }
        
        const stock = analysisQueue[currentAnalysisIndex];
        updateProgressText(`正在分析 ${stock.code} (${stock.name})...`);
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stock.code,
                analysis_type: analysisType
            }),
            success: function(response) {
                const result = {
                    stock: stock,
                    success: response.success,
                    data: response.data,
                    error: response.message
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                const result = {
                    stock: stock,
                    success: false,
                    error: response?.message || '网络错误'
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            }
        });
    }
    
    function updateProgress() {
        const progress = (currentAnalysisIndex / analysisQueue.length) * 100;
        $('#progressBar').css('width', progress + '%');
        $('#progressBar').text(Math.round(progress) + '%');
    }
    
    function updateProgressText(text) {
        $('#progressText').text(text);
        updateProgress();
    }
    
    function updateAnalysisResults() {
        const resultsContainer = $('#analysisResults');
        resultsContainer.empty();
        
        analysisResults.forEach(function(result, index) {
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            const statusText = result.success ? '成功' : '失败';
            
            const resultHtml = `
                <div class="analysis-result-item analysis-result-${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${statusIcon} me-2"></i>
                            <strong>${result.stock.code}</strong> - ${result.stock.name}
                        </div>
                        <span class="badge bg-${result.success ? 'success' : 'danger'}">${statusText}</span>
                    </div>
                    ${result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                </div>
            `;
            resultsContainer.append(resultHtml);
        });
    }
    
    function completeBatchAnalysis() {
        const successCount = analysisResults.filter(r => r.success).length;
        const totalCount = analysisResults.length;
        
        updateProgressText(`分析完成！成功 ${successCount}/${totalCount}`);
        $('#progressBar').removeClass('progress-bar-animated');
        
        // 重新启用按钮
        $('#batchAnalyzeBtn').prop('disabled', false);
        $('#batchAnalyzeBtn').html('<i class="fas fa-magic me-2"></i>批量分析所有');
        
        // 显示完成消息
        showToast('success', `批量分析完成！成功 ${successCount}/${totalCount} 支股票`);
        
        // 3秒后隐藏进度
        setTimeout(function() {
            $('#analysisProgress').fadeOut();
        }, 3000);
    }
    
    function showAnalysisResult(stockCode, stockName, reportData) {
        // 显示分析结果模态框
        const content = `
            <div class="analysis-result-header mb-3">
                <h4 class="mb-2">${stockName} (${stockCode}) 分析报告</h4>
                <div class="mb-3">
                    <span class="badge bg-primary me-2">${reportData.provider || 'AI'}</span>
                    <span class="badge bg-secondary me-2">${reportData.analysis_date}</span>
                    <span class="badge bg-info">${reportData.metadata?.model || 'AI模型'}</span>
                </div>
            </div>
            <div class="analysis-content">
                <div class="analysis-preview mb-3">
                    <h6>分析内容预览：</h6>
                    <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        ${formatAnalysisContent(reportData.content)}
                    </div>
                </div>
                <div class="analysis-actions">
                    <a href="/reports/${stockCode}" class="btn btn-primary me-2" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>查看完整报告
                    </a>
                    <button class="btn btn-outline-secondary me-2" onclick="downloadReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-download me-1"></i>下载报告
                    </button>
                    <button class="btn btn-outline-info" onclick="shareReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-share me-1"></i>分享报告
                    </button>
                </div>
            </div>
        `;
        
        $('#analysisResultContent').html(content);
        
        const modal = new bootstrap.Modal(document.getElementById('analysisResultModal'));
        modal.show();
    }
    
    function formatAnalysisContent(content) {
        // 简单的Markdown格式化
        return content
            .replace(/#{1,6}\s+(.+)/g, '<strong>$1</strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }
    
    function downloadReport(stockCode, stockName) {
        // 下载报告功能
        const link = document.createElement('a');
        link.href = `/api/analysis/reports/${stockCode}/download`;
        link.download = `${stockCode}_${stockName}_分析报告_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function shareReport(stockCode, stockName) {
        // 分享报告功能
        const url = `${window.location.origin}/reports/${stockCode}`;
        if (navigator.share) {
            navigator.share({
                title: `${stockName} (${stockCode}) 分析报告`,
                text: `查看 ${stockName} 的AI分析报告`,
                url: url
            });
        } else {
            // 复制链接到剪贴板
            navigator.clipboard.writeText(url).then(function() {
                showToast('success', '报告链接已复制到剪贴板');
            });
        }
    }
    
    function getAnalysisTypeName(type) {
        const types = {
            'fundamental': '基本面分析',
            'technical': '技术面分析'
        };
        return types[type] || '综合分析';
    }
    
    // 显示Toast消息
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // 自动消失
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
