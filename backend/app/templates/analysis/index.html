{% extends "base.html" %}

{% block title %}AI分析 - 智策股析{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-robot me-2"></i>AI智能分析
            </h1>
            <p class="text-muted mb-4">使用先进的大语言模型为您提供专业的股票分析报告</p>
        </div>
    </div>

    <!-- 使用量和金币显示 -->
    <div class="row mb-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm" id="usageCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-chart-bar me-2"></i>今日分析次数
                            </h6>
                            <span class="h5 mb-0" id="usageDisplay">加载中...</span>
                        </div>
                        <div class="text-end">
                            <div class="progress" style="width: 120px; height: 8px;">
                                <div class="progress-bar" id="usageProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block" id="usageHint">每日限额：10次</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm" id="coinCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-coins me-2"></i>金币余额
                            </h6>
                            <span class="h5 mb-0" id="coinDisplay">加载中...</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted mt-1 d-block">每次分析消耗10金币</small>
                            <a href="{{ url_for('coin.coin_center') }}" class="btn btn-sm btn-outline-primary mt-1">
                                <i class="fas fa-plus me-1"></i>充值
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 分析设置 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-header border-0 text-white" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-cogs me-2"></i>分析设置
                        <small class="ms-2 opacity-75">配置您的AI分析参数</small>
                    </h5>
                </div>
                <div class="card-body text-white" style="background: rgba(255,255,255,0.05);">
                    <div class="row g-4">
                        <!-- 分析类型 -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span class="fw-bold">分析类型</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="analysisType" onchange="loadPrompts()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;">
                                        <option value="">请选择分析类型</option>
                                        <option value="fundamental">📊 基本面分析</option>
                                        <option value="technical">📈 技术面分析</option>
                                    </select>
                                    <small class="text-white-50 mt-2 d-block">选择分析的角度和方法</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 提示词版本 -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-comment-dots me-2"></i>
                                    <span class="fw-bold">提示词版本</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="promptSelect" onchange="onPromptChange()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;" disabled>
                                        <option value="">请先选择分析类型</option>
                                    </select>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small class="text-white-50">选择分析提示词版本</small>
                                        <button type="button" class="btn btn-sm btn-light" id="previewPromptBtn" 
                                                onclick="previewSelectedPrompt()" disabled style="border-radius: 8px;">
                                            <i class="fas fa-eye me-1"></i>预览
                                        </button>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <!-- AI模型 -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-robot me-2"></i>
                                    <span class="fw-bold">AI模型</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="aiProvider" onchange="loadModels()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;">
                                        <option value="">请选择AI提供商</option>
                                        <option value="qwen">🌟 通义千问 (Qwen)</option>
                                        <option value="deepseek">🚀 DeepSeek</option>
                                    </select>
                                    <div class="mt-2">
                                        <select class="form-select" id="aiModel" onchange="onModelChange()" 
                                                style="background: rgba(255,255,255,0.9); border: none; border-radius: 8px;" disabled>
                                            <option value="">请先选择AI提供商</option>
                                        </select>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-white-50" id="modelInfo">选择具体的AI模型</small>
                                            <button type="button" class="btn btn-sm btn-light" id="previewModelBtn" 
                                                    onclick="previewSelectedModel()" disabled style="border-radius: 8px;">
                                                <i class="fas fa-eye me-1"></i>预览
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 快速操作 -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-bolt me-2"></i>
                                    <span class="fw-bold">快速操作</span>
                                </div>
                                <div class="setting-content">
                                    <div class="d-grid gap-2">
                                        <button id="batchAnalyzeBtn" class="btn btn-light btn-lg" 
                                                style="border-radius: 12px; font-weight: 600;">
                                        <i class="fas fa-magic me-2"></i>批量分析所有
                                    </button>
                                        <a href="{{ url_for('analysis.tasks') }}" class="btn btn-outline-light" 
                                           style="border-radius: 12px;">
                                        <i class="fas fa-tasks me-2"></i>查看任务
                                    </a>
                                    </div>
                                    <small class="text-white-50 mt-2 d-block">一键分析所有关注股票</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 关注列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>关注股票列表
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="watchlistCount">{{ watchlist|length }}</span>
                        <span class="text-muted ms-2">支股票</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if watchlist %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>股票代码</th>
                                        <th>公司名称</th>
                                        <th>市场</th>
                                        <th>行业</th>
                                        <th>关注时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist %}
                                    <tr>
                                        <td>
                                            <code class="text-primary">{{ item.stock.code }}</code>
                                        </td>
                                        <td>{{ item.stock.name }}</td>
                                        <td>
                                            {% if item.stock.market == 'US' %}
                                                <span class="badge bg-primary">美股</span>
                                            {% else %}
                                                <span class="badge bg-success">港股</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.stock.industry or '未知' }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.added_at }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary analyze-btn" 
                                                        data-stock-code="{{ item.stock.code }}"
                                                        data-stock-name="{{ item.stock.name }}">
                                                    <i class="fas fa-chart-line me-1"></i>分析
                                                </button>
                                                <a href="{{ url_for('reports.index') }}?stock={{ item.stock.code }}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-file-alt me-1"></i>报告
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- 操作说明 -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>操作说明</h6>
                                <ul class="mb-0">
                                    <li><strong>单股分析：</strong>点击每行右侧的"分析"按钮，对单个股票进行AI分析</li>
                                    <li><strong>批量分析：</strong>点击上方的"批量分析所有"按钮，一次性分析所有关注的股票</li>
                                    <li><strong>查看报告：</strong>点击"报告"按钮查看该股票的历史分析报告</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">您还没有关注任何股票</h5>
                            <p class="text-muted">请先添加股票到关注列表，然后进行AI分析</p>
                            <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>添加股票
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 分析进度 -->
<div id="analysisProgress" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>分析进度
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center">准备开始分析...</div>
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- 分析结果模态框 -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>分析结果
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <a href="#" id="viewFullReport" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>查看完整报告
                </a>
            </div>
        </div>
    </div>
</div>

<!-- 确认分析弹窗 -->
<div class="modal fade" id="confirmAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>确认分析
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h6 id="confirmStockInfo">确认分析 AAPL - 苹果公司？</h6>
                    <p class="text-muted">分析一次将消耗您今日的1次分析额度</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>剩余次数：</strong><span id="confirmRemaining">9次</span>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-coins me-2"></i>
                    <strong>金币消耗：</strong><span id="confirmCoinCost">10金币</span>
                    <br>
                    <small class="text-muted">每次分析将消耗10金币，请确保您的金币余额充足</small>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>取消
                </button>
                <button type="button" class="btn btn-primary" id="confirmAnalysisBtn">
                    <i class="fas fa-check me-2"></i>确认分析
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 任务完成弹窗 -->
<div class="modal fade" id="taskCompletedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-check-circle text-success me-2"></i>任务提交成功
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                    <h6 class="text-success">批量分析任务已成功提交！</h6>
                    <p class="text-muted">您的分析任务正在后台运行，完成后会通过邮件通知您。</p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>提示：</strong>您可以随时在"分析报告"页面查看进度和结果。
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>继续分析
                </button>
                <a href="/reports/" class="btn btn-primary">
                    <i class="fas fa-chart-line me-2"></i>查看报告
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.progress {
    height: 25px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 15px;
}

.progress-bar {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 15px;
}

.analysis-result-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.analysis-result-success {
    background: rgba(40, 167, 69, 0.1);
    border-left-color: #28a745;
}

.analysis-result-error {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
}

.analysis-result-pending {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<style>
.setting-card {
    background: rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s ease;
    height: 100%;
}

.setting-card:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.setting-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: 16px;
    color: white;
}

.setting-content {
    color: white;
}

.form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
}

.btn-light:hover {
    background-color: rgba(255,255,255,0.9);
    border-color: rgba(255,255,255,0.9);
    transform: translateY(-1px);
}

.btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

@media (max-width: 768px) {
    .setting-card {
        margin-bottom: 20px;
    }
}
</style>

<script>
// 全局变量
    let analysisQueue = [];
    let currentAnalysisIndex = 0;
    let analysisResults = [];
    let currentUsageData = null;
    let pendingAnalysis = null;
    
// 加载提示词列表 - 全局函数
function loadPrompts() {
    console.log('=== loadPrompts 函数被调用 ===');
    const analysisType = $('#analysisType').val();
    console.log('当前选择的分析类型:', analysisType);
    console.log('analysisType 元素:', $('#analysisType'));
    
    if (!analysisType) {
        console.log('没有选择分析类型，禁用提示词下拉框');
        $('#promptSelect').html('<option value="">请先选择分析类型</option>').prop('disabled', true);
        $('#previewPromptBtn').prop('disabled', true);
        return;
    }
    
    console.log('开始加载提示词，分析类型:', analysisType);
    $('#promptSelect').html('<option value="">加载中...</option>');
    $('#previewPromptBtn').prop('disabled', true);
    
    const apiUrl = `/api/prompt/prompts/type/${analysisType}`;
    console.log('API请求URL:', apiUrl);
    
    $.ajax({
        url: apiUrl,
        method: 'GET',
        success: function(response) {
            console.log('API请求成功，响应:', response);
            if (response.success) {
                console.log('开始更新提示词下拉框，提示词数量:', response.data.prompts.length);
                updatePromptSelect(response.data.prompts);
            } else {
                console.error('API返回失败:', response.message);
                $('#promptSelect').html('<option value="">获取失败</option>').prop('disabled', true);
                $('#previewPromptBtn').prop('disabled', true);
            }
        },
        error: function(xhr, status, error) {
            console.error('API请求失败:', error);
            console.error('状态码:', xhr.status);
            console.error('响应文本:', xhr.responseText);
            $('#promptSelect').html('<option value="">获取失败</option>').prop('disabled', true);
            $('#previewPromptBtn').prop('disabled', true);
        }
    });
}

// 更新提示词选择框 - 全局函数
function updatePromptSelect(prompts) {
    console.log('=== updatePromptSelect 函数被调用 ===');
    console.log('接收到的提示词数据:', prompts);
    console.log('提示词数量:', prompts.length);
    
    const select = $('#promptSelect');
    console.log('找到的select元素:', select);
    console.log('select元素长度:', select.length);
    
    select.empty();
    console.log('已清空下拉框');
    
    if (prompts.length === 0) {
        console.log('没有可用提示词，显示空状态');
        select.append('<option value="">暂无可用提示词</option>');
        select.prop('disabled', true);
        $('#previewPromptBtn').prop('disabled', true);
        return;
    }
    
    // 添加默认选项
    console.log('添加默认选项');
    select.append('<option value="">使用默认提示词</option>');
    
    // 添加提示词选项
    console.log('开始添加提示词选项');
    prompts.forEach((prompt, index) => {
        const isDefault = prompt.is_default ? ' (默认)' : '';
        const version = `v${prompt.version}`;
        const usage = prompt.usage_count > 0 ? ` (使用${prompt.usage_count}次)` : '';
        const optionText = `${prompt.name} ${version}${isDefault}${usage}`;
        
        console.log(`添加第${index + 1}个选项:`, optionText);
        console.log('提示词ID:', prompt.id);
        
        // 安全地序列化提示词数据，避免JSON解析错误
        const safePromptData = {
            id: prompt.id,
            name: prompt.name,
            version: prompt.version,
            prompt_type: prompt.prompt_type,
            description: prompt.description,
            content: prompt.content,
            is_active: prompt.is_active,
            is_default: prompt.is_default,
            usage_count: prompt.usage_count,
            created_at: prompt.created_at,
            updated_at: prompt.updated_at,
            last_used_at: prompt.last_used_at
        };
        
        const optionHtml = `<option value="${prompt.id}" data-prompt='${JSON.stringify(safePromptData).replace(/'/g, '&#39;')}'>${optionText}</option>`;
        select.append(optionHtml);
        console.log('已添加选项HTML:', optionHtml);
    });
    
    // 启用下拉框和预览按钮
    console.log('启用下拉框和预览按钮');
    select.prop('disabled', false);
    $('#previewPromptBtn').prop('disabled', false);
    
    console.log('下拉框当前HTML内容:', select.html());
    console.log('下拉框是否禁用:', select.prop('disabled'));
    console.log('=== updatePromptSelect 函数执行完成 ===');
}

// 提示词选择变化时的处理 - 全局函数
function onPromptChange() {
    const selectedPromptId = $('#promptSelect').val();
    if (selectedPromptId) {
        $('#previewPromptBtn').prop('disabled', false);
    } else {
        $('#previewPromptBtn').prop('disabled', true);
    }
}

// 预览选中的提示词 - 全局函数
function previewSelectedPrompt() {
    const selectedPromptId = $('#promptSelect').val();
    if (!selectedPromptId) {
        showAlert('请先选择一个提示词', 'warning');
        return;
    }
    
    const selectedOption = $('#promptSelect option:selected');
    const promptDataString = selectedOption.attr('data-prompt');
    
    if (!promptDataString) {
        showAlert('无法获取提示词详情', 'error');
        return;
    }
    
    try {
        // 安全地解析JSON，处理HTML实体
        const cleanPromptDataString = promptDataString.replace(/&#39;/g, "'");
        const promptData = JSON.parse(cleanPromptDataString);
        
        if (promptData) {
            showPromptPreview(promptData);
        } else {
            showAlert('无法获取提示词详情', 'error');
        }
    } catch (error) {
        console.error('JSON解析错误:', error);
        showAlert('提示词数据格式错误', 'error');
    }
}

// 获取使用量数据 - 全局函数
    function loadUsageData() {
        $.ajax({
            url: '/api/analysis/usage',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    currentUsageData = response.usage;
                    updateUsageDisplay(currentUsageData);
                }
            },
            error: function(xhr, status, error) {
                console.error('获取使用量失败:', error);
                $('#usageDisplay').text('获取失败');
            }
        });
    }
    
    // 获取用户金币信息
    function loadUserCoinInfo() {
        $.ajax({
            url: '/api/coin/info',
            method: 'GET',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: false,
            success: function(response) {
                if (response.success) {
                    const coinInfo = response.data;
                    const availableCoins = coinInfo.available_coins || 0;
                    const coinCost = 10;
                    
                    // 更新页面金币显示
                    $('#coinDisplay').text(`${availableCoins}金币`);
                    if (availableCoins < coinCost) {
                        $('#coinDisplay').addClass('text-danger');
                    } else {
                        $('#coinDisplay').removeClass('text-danger');
                    }
                    
                    // 更新确认弹窗中的金币消耗显示
                    if (availableCoins >= coinCost) {
                        $('#confirmCoinCost').html(`<span class="text-success">10金币</span><br><small class="text-muted">当前余额：${availableCoins}金币</small>`);
                    } else {
                        $('#confirmCoinCost').html(`<span class="text-danger">10金币</span><br><small class="text-danger">余额不足！当前余额：${availableCoins}金币</small>`);
                    }
                } else {
                    console.error('获取金币信息失败:', response.message);
                    $('#coinDisplay').text('获取失败');
                    $('#confirmCoinCost').text('10金币（无法获取余额）');
                }
            },
            error: function(xhr, status, error) {
                console.error('获取金币信息失败:', error);
                $('#coinDisplay').text('获取失败');
                $('#confirmCoinCost').text('10金币（无法获取余额）');
            }
        });
    }
    
// 更新使用量显示 - 全局函数
    function updateUsageDisplay(usage) {
        const current = usage.current_count;
        const limit = usage.daily_limit;
        const remaining = usage.remaining;
        const percentage = (current / limit) * 100;
        
        $('#usageDisplay').text(`${current}/${limit}`);
        $('#usageProgress').css('width', `${Math.min(percentage, 100)}%`);
        
        if (usage.is_admin) {
            $('#usageHint').text('管理员无限制');
            $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
        } else {
            $('#usageHint').text(`每日限额：${limit}次`);
            
            if (percentage >= 100) {
                $('#usageProgress').removeClass('bg-success bg-warning').addClass('bg-danger');
            } else if (percentage >= 80) {
                $('#usageProgress').removeClass('bg-success bg-danger').addClass('bg-warning');
            } else {
                $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
            }
        }
    }

$(document).ready(function() {
    // 页面加载时获取使用量和金币信息
    loadUsageData();
    loadUserCoinInfo();
    
    
    // 单个股票分析
    $('.analyze-btn').click(function() {
        console.log('分析按钮被点击');
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const stockName = btn.data('stock-name');
        
        // 检查使用量限制
        if (currentUsageData && !currentUsageData.is_admin && !currentUsageData.can_analyze) {
            showToast('error', `今日分析次数已达上限（${currentUsageData.daily_limit}次），请明天再试`);
            return;
        }
        
        // 显示确认弹窗
        showConfirmAnalysis(stockCode, stockName, btn);
    });
    
    // 显示确认分析弹窗
    function showConfirmAnalysis(stockCode, stockName, btn) {
        pendingAnalysis = { stockCode, stockName, btn };
        
        $('#confirmStockInfo').text(`确认分析 ${stockCode} - ${stockName}？`);
        
        if (currentUsageData && currentUsageData.is_admin) {
            $('#confirmRemaining').text('无限制');
            $('#confirmCoinCost').text('免费（管理员）');
        } else if (currentUsageData) {
            $('#confirmRemaining').text(`${currentUsageData.remaining}次`);
            $('#confirmCoinCost').text('10金币');
        } else {
            $('#confirmRemaining').text('加载中...');
            $('#confirmCoinCost').text('10金币');
        }
        
        // 获取用户金币余额
        loadUserCoinInfo();
        
        $('#confirmAnalysisModal').modal('show');
    }
    
    // 确认分析按钮点击
    $('#confirmAnalysisBtn').click(function() {
        if (!pendingAnalysis) return;
        
        $('#confirmAnalysisModal').modal('hide');
        executeAnalysis(pendingAnalysis.stockCode, pendingAnalysis.stockName, pendingAnalysis.btn);
        pendingAnalysis = null;
    });
    
    // 执行分析（异步任务）
    function executeAnalysis(stockCode, stockName, btn) {
        const analysisType = $('#analysisType').val();
        const aiProvider = $('#aiProvider').val();
        const aiModel = $('#aiModel').val();
        
        console.log('股票代码:', stockCode);
        console.log('股票名称:', stockName);
        console.log('分析类型:', analysisType);
        console.log('AI提供商:', aiProvider);
        console.log('AI模型:', aiModel);
        
        // 禁用按钮
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>提交中...');
        
        console.log('发送分析请求到:', '/api/analysis/analyze');
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stockCode,
                analysis_type: analysisType,
                ai_provider: aiProvider,
                ai_model: aiModel,
                prompt_id: $('#promptSelect').val() || null
            }),
            success: function(response) {
                console.log('分析请求成功:', response);
                if (response.success) {
                    showToast('success', `${stockCode} 分析任务已提交！消耗10金币，请稍后查看结果。`);
                    
                    // 更新使用量
                    loadUsageData();
                    
                    // 显示任务提交成功提示
                    showTaskSubmittedModal(stockCode, response.data.task_id);
                } else {
                    // 检查是否是金币不足错误
                    if (response.message && response.message.includes('金币不足')) {
                        showToast('error', `分析失败: ${response.message}，请前往金币中心充值。`);
                    } else {
                        showToast('error', `${stockCode} 分析失败: ${response.message}`);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('分析请求失败:', xhr, status, error);
                const response = xhr.responseJSON;
                
                if (response && response.error === 'DAILY_LIMIT_REACHED') {
                    showToast('error', `今日分析次数已达上限（${response.data?.daily_limit || 10}次），请明天再试`);
                    // 更新使用量显示
                    if (response.data) {
                        updateUsageDisplay(response.data);
                    }
                } else {
                    showToast('error', `${stockCode} 分析失败: ${response?.message || '网络错误'}`);
                }
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-chart-line me-1"></i>分析');
            }
        });
    }
    
    // 显示任务提交成功弹窗
    function showTaskSubmittedModal(stockCode, taskId) {
        const modal = `
            <div class="modal fade" id="singleTaskSubmittedModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content glass-effect">
                        <div class="modal-header border-0 text-center">
                            <h5 class="modal-title w-100">
                                <i class="fas fa-check-circle text-success me-2"></i>任务提交成功
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                <h6 class="text-success">${stockCode} 分析任务已成功提交！</h6>
                                <p class="text-muted">您的分析任务正在后台运行，完成后可以在"分析报告"页面查看结果。</p>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>任务ID：</strong>${taskId}
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>继续分析
                            </button>
                            <a href="/reports/" class="btn btn-primary">
                                <i class="fas fa-chart-line me-2"></i>查看报告
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除之前的模态框（如果存在）
        $('#singleTaskSubmittedModal').remove();
        
        // 添加新的模态框到页面
        $('body').append(modal);
        
        // 显示模态框
        const taskModal = new bootstrap.Modal(document.getElementById('singleTaskSubmittedModal'));
        taskModal.show();
        
        // 模态框关闭后清理
        $('#singleTaskSubmittedModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }
    
    // 批量分析
    $('#batchAnalyzeBtn').click(function() {
        const btn = $(this);
        const analysisType = $('#analysisType').val();
        
        if ($('.analyze-btn').length === 0) {
            showToast('error', '请先添加股票到关注列表');
            return;
        }
        
        // 收集要分析的股票信息
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // 构建美观的确认信息
        const stockList = stocksToAnalyze.map(stock => `• ${stock.code} (${stock.name})`).join('\n');
        const estimatedTime = Math.ceil(stocksToAnalyze.length * 0.5); // 每只股票约30秒
        const analysisTypeName = getAnalysisTypeName(analysisType);
        
        const confirmMessage = `🎯 批量分析任务确认

📊 分析类型：${analysisTypeName}
⏱️ 预计时间：约 ${estimatedTime} 分钟
🤖 AI模型：${$('#aiProvider option:selected').text()}

📋 待分析股票 (${stocksToAnalyze.length} 只)：
${stockList}

💡 提示：分析将在后台异步进行，您可以离开页面做其他事情。分析完成后会通过邮件通知您，您也可以在"分析报告"页面查看结果。`;
        
        if (confirmAction) {
            confirmAction(
                '🚀 批量分析确认',
                confirmMessage,
                function() {
                    startBatchAnalysis(analysisType);
                }
            );
        } else {
            showConfirmModal(
                '确认批量分析',
                confirmMessage,
                function() {
                startBatchAnalysis(analysisType);
            }
            );
        }
    });
    
    function startBatchAnalysis(analysisType) {
        const btn = $('#batchAnalyzeBtn');
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>提交任务中...');
        
        // 收集要分析的股票信息
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // 发送异步批量分析请求
        $.ajax({
            url: '/api/analysis/batch-analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stocks: stocksToAnalyze,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val(),
                ai_model: $('#aiModel').val()
            }),
            success: function(response) {
                if (response.success) {
                    showToast('success', `批量分析任务已提交！任务ID: ${response.task_id}\n分析完成后会通过邮件通知您。`);
                    
                    // 恢复按钮状态
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
                    
                    // 可以选择跳转到报告页面
                    setTimeout(function() {
                        // 显示美观的任务完成弹窗
                        const taskCompletedModal = new bootstrap.Modal(document.getElementById('taskCompletedModal'));
                        taskCompletedModal.show();
                    }, 1000);
                } else {
                    showToast('error', response.message || '提交批量分析任务失败');
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || '网络错误，请稍后重试');
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-magic me-2"></i>批量分析所有');
            }
        });
    }
    
    function processNextAnalysis(analysisType) {
        if (currentAnalysisIndex >= analysisQueue.length) {
            // 分析完成
            completeBatchAnalysis();
            return;
        }
        
        const stock = analysisQueue[currentAnalysisIndex];
        updateProgressText(`正在分析 ${stock.code} (${stock.name})...`);
        
        // 发送分析请求
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stock.code,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val(),
                ai_model: $('#aiModel').val(),
                prompt_id: $('#promptSelect').val() || null
            }),
            success: function(response) {
                const result = {
                    stock: stock,
                    success: response.success,
                    data: response.data,
                    error: response.message
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                const result = {
                    stock: stock,
                    success: false,
                    error: response?.message || '网络错误'
                };
                analysisResults.push(result);
                
                // 更新结果显示
                updateAnalysisResults();
                
                // 继续下一个
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            }
        });
    }
    
    function updateProgress() {
        const progress = (currentAnalysisIndex / analysisQueue.length) * 100;
        $('#progressBar').css('width', progress + '%');
        $('#progressBar').text(Math.round(progress) + '%');
    }
    
    function updateProgressText(text) {
        $('#progressText').text(text);
        updateProgress();
    }
    
    function updateAnalysisResults() {
        const resultsContainer = $('#analysisResults');
        resultsContainer.empty();
        
        analysisResults.forEach(function(result, index) {
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            const statusText = result.success ? '成功' : '失败';
            
            const resultHtml = `
                <div class="analysis-result-item analysis-result-${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${statusIcon} me-2"></i>
                            <strong>${result.stock.code}</strong> - ${result.stock.name}
                        </div>
                        <span class="badge bg-${result.success ? 'success' : 'danger'}">${statusText}</span>
                    </div>
                    ${result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                </div>
            `;
            resultsContainer.append(resultHtml);
        });
    }
    
    function completeBatchAnalysis() {
        const successCount = analysisResults.filter(r => r.success).length;
        const totalCount = analysisResults.length;
        
        updateProgressText(`分析完成！成功 ${successCount}/${totalCount}`);
        $('#progressBar').removeClass('progress-bar-animated');
        
        // 重新启用按钮
        $('#batchAnalyzeBtn').prop('disabled', false);
        $('#batchAnalyzeBtn').html('<i class="fas fa-magic me-2"></i>批量分析所有');
        
        // 显示完成消息
        showToast('success', `批量分析完成！成功 ${successCount}/${totalCount} 支股票`);
        
        // 3秒后隐藏进度
        setTimeout(function() {
            $('#analysisProgress').fadeOut();
        }, 3000);
    }
    
    function showAnalysisResult(stockCode, stockName, reportData) {
        // 显示分析结果模态框
        const content = `
            <div class="analysis-result-header mb-3">
                <h4 class="mb-2">${stockName} (${stockCode}) 分析报告</h4>
                <div class="mb-3">
                    <span class="badge bg-primary me-2">${reportData.provider || 'AI'}</span>
                    <span class="badge bg-secondary me-2">${reportData.analysis_date}</span>
                    <span class="badge bg-info">${reportData.metadata?.model || 'AI模型'}</span>
                </div>
            </div>
            <div class="analysis-content">
                <div class="analysis-preview mb-3">
                    <h6>分析内容预览：</h6>
                    <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        ${formatAnalysisContent(reportData.content)}
                    </div>
                </div>
                <div class="analysis-actions">
                    <a href="/reports/${stockCode}" class="btn btn-primary me-2" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>查看完整报告
                    </a>
                    <button class="btn btn-outline-secondary me-2" onclick="downloadReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-download me-1"></i>下载报告
                    </button>
                </div>
            </div>
        `;
        
        $('#analysisResultContent').html(content);
        
        const modal = new bootstrap.Modal(document.getElementById('analysisResultModal'));
        modal.show();
    }
    
    function formatAnalysisContent(content) {
        // 简单的Markdown格式化
        return content
            .replace(/#{1,6}\s+(.+)/g, '<strong>$1</strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }
    
    function downloadReport(stockCode, stockName) {
        // 下载报告功能
        const link = document.createElement('a');
        link.href = `/api/analysis/reports/${stockCode}/download`;
        link.download = `${stockCode}_${stockName}_分析报告_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    
    function getAnalysisTypeName(type) {
        const types = {
            'fundamental': '基本面分析',
            'technical': '技术面分析'
        };
        return types[type] || '综合分析';
    }
    
    // 显示Toast消息
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // 自动消失
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
    
});

// 显示提示词预览弹窗 - 全局函数
function showPromptPreview(promptData) {
        const modalHtml = `
            <div class="modal fade" id="promptPreviewModal" tabindex="-1" aria-labelledby="promptPreviewModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient-primary text-white">
                            <h5 class="modal-title" id="promptPreviewModalLabel">
                                <i class="fas fa-eye me-2"></i>提示词预览
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0">
                            <!-- 基本信息卡片 -->
                            <div class="p-3 border-bottom">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-tag text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">名称</small>
                                                <strong>${promptData.name}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-code-branch text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">版本</small>
                                                <strong>v${promptData.version}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-layer-group text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">类型</small>
                                                <span class="badge bg-info">${promptData.prompt_type === 'fundamental' ? '基础分析' : '技术分析'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">使用次数</small>
                                                <strong>${promptData.usage_count}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${promptData.description ? `
                                <!-- 描述信息 -->
                                <div class="p-3 border-bottom">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-comment me-2"></i>描述
                                    </h6>
                                    <p class="mb-0 text-muted">${promptData.description}</p>
                                </div>
                            ` : ''}
                            
                            <!-- 提示词内容 -->
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-primary mb-0">
                                        <i class="fas fa-code me-2"></i>提示词内容
                                    </h6>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="copyPromptContent()">
                                            <i class="fas fa-copy me-1"></i>复制
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePromptView()">
                                            <i class="fas fa-expand me-1"></i>全屏
                                        </button>
                                    </div>
                                </div>
                                <div class="border rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                                    <pre id="promptContent" class="mb-0 p-3" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">${promptData.content}</pre>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>字符数: ${promptData.content.length}
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>关闭
                            </button>
                            <button type="button" class="btn btn-primary" onclick="useThisPrompt('${promptData.id}')">
                                <i class="fas fa-check me-2"></i>使用此提示词
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // 移除已存在的弹窗
        $('#promptPreviewModal').remove();
        
        // 添加新弹窗
        $('body').append(modalHtml);
        
        // 显示弹窗
        const modal = new bootstrap.Modal(document.getElementById('promptPreviewModal'));
        modal.show();
    }

// 复制提示词内容 - 全局函数
function copyPromptContent() {
    const content = document.getElementById('promptContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        showAlert('提示词内容已复制到剪贴板', 'success');
    }).catch(() => {
        showAlert('复制失败，请手动选择复制', 'warning');
    });
}

// 切换全屏视图 - 全局函数
function togglePromptView() {
    const modal = document.getElementById('promptPreviewModal');
    const modalDialog = modal.querySelector('.modal-dialog');
    
    if (modalDialog.classList.contains('modal-fullscreen')) {
        modalDialog.classList.remove('modal-fullscreen');
    } else {
        modalDialog.classList.add('modal-fullscreen');
    }
}

// 使用选中的提示词 - 全局函数
function useThisPrompt(promptId) {
    $('#promptSelect').val(promptId);
    $('#promptPreviewModal').modal('hide');
    showAlert('已选择该提示词', 'success');
}

// 加载模型列表
function loadModels() {
    const provider = $('#aiProvider').val();
    console.log('loadModels called, provider:', provider);
    
    if (!provider) {
        $('#aiModel').html('<option value="">请先选择AI提供商</option>').prop('disabled', true);
        $('#previewModelBtn').prop('disabled', true);
        $('#modelInfo').text('选择具体的AI模型');
        return;
    }
    
    $('#aiModel').html('<option value="">加载中...</option>').prop('disabled', true);
    $('#previewModelBtn').prop('disabled', true);
    $('#modelInfo').text('正在加载模型列表...');
    
    $.ajax({
        url: `/api/models/${provider}`,
        method: 'GET',
        success: function(response) {
            console.log('Models API response:', response);
            if (response.success) {
                const models = response.data;
                let options = '<option value="">请选择AI模型</option>';
                
                Object.keys(models).forEach(modelKey => {
                    const model = models[modelKey];
                    const costIcon = getCostIcon(model.cost_level);
                    const timeIcon = getTimeIcon(model.response_time);
                    const warningText = model.warning ? ` ⚠️` : '';
                    
                    options += `<option value="${modelKey}" data-model='${JSON.stringify(model)}'>
                        ${costIcon} ${timeIcon} ${model.name}${warningText}
                    </option>`;
                });
                
                $('#aiModel').html(options).prop('disabled', false);
                $('#modelInfo').text('选择具体的AI模型');
            } else {
                $('#aiModel').html('<option value="">加载失败</option>');
                $('#modelInfo').text('加载模型列表失败');
                showAlert('加载模型列表失败: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading models:', error);
            $('#aiModel').html('<option value="">加载失败</option>');
            $('#modelInfo').text('加载模型列表失败');
            showAlert('加载模型列表失败', 'error');
        }
    });
}

// 模型选择变化处理
function onModelChange() {
    const modelKey = $('#aiModel').val();
    const modelData = $('#aiModel option:selected').data('model');
    
    if (!modelKey || !modelData) {
        $('#previewModelBtn').prop('disabled', true);
        $('#modelInfo').text('选择具体的AI模型');
        return;
    }
    
    $('#previewModelBtn').prop('disabled', false);
    
    // 更新模型信息显示
    let infoText = `${modelData.description}`;
    if (modelData.warning) {
        infoText += ` | ⚠️ ${modelData.warning}`;
    }
    $('#modelInfo').text(infoText);
}

// 预览选中的模型
function previewSelectedModel() {
    const modelKey = $('#aiModel').val();
    const modelData = $('#aiModel option:selected').data('model');
    
    if (!modelKey || !modelData) {
        showAlert('请先选择一个模型', 'warning');
        return;
    }
    
    // 创建模型预览弹窗
    const modalHtml = `
        <div class="modal fade" id="modelPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-robot me-2"></i>模型详情
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>基本信息</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>模型名称:</strong></td><td>${modelData.name}</td></tr>
                                    <tr><td><strong>模型ID:</strong></td><td>${modelKey}</td></tr>
                                    <tr><td><strong>最大Token:</strong></td><td>${modelData.max_tokens.toLocaleString()}</td></tr>
                                    <tr><td><strong>成本等级:</strong></td><td>${getCostText(modelData.cost_level)}</td></tr>
                                    <tr><td><strong>响应时间:</strong></td><td>${getTimeText(modelData.response_time)}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-star me-2"></i>功能特性</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    ${modelData.features.map(feature => 
                                        `<span class="badge bg-primary">${feature}</span>`
                                    ).join('')}
                                </div>
                                
                                ${modelData.warning ? `
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>注意事项:</strong> ${modelData.warning}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-align-left me-2"></i>模型描述</h6>
                            <p class="text-muted">${modelData.description}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>关闭
                        </button>
                        <button type="button" class="btn btn-primary" onclick="useThisModel('${modelKey}')">
                            <i class="fas fa-check me-2"></i>使用此模型
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // 移除已存在的弹窗
    $('#modelPreviewModal').remove();
    
    // 添加新弹窗
    $('body').append(modalHtml);
    
    // 显示弹窗
    const modal = new bootstrap.Modal(document.getElementById('modelPreviewModal'));
    modal.show();
}

// 使用选中的模型
function useThisModel(modelKey) {
    $('#aiModel').val(modelKey);
    $('#modelPreviewModal').modal('hide');
    onModelChange(); // 更新显示信息
    showAlert('已选择该模型', 'success');
}

// 获取成本图标
function getCostIcon(costLevel) {
    const icons = {
        'low': '💰',
        'medium': '💸',
        'high': '💎',
        'very_high': '💎💎'
    };
    return icons[costLevel] || '💰';
}

// 获取时间图标
function getTimeIcon(timeLevel) {
    const icons = {
        'fast': '⚡',
        'medium': '🕐',
        'slow': '🐌',
        'very_slow': '🐌🐌'
    };
    return icons[timeLevel] || '🕐';
}

// 获取成本文本
function getCostText(costLevel) {
    const texts = {
        'low': '低',
        'medium': '中等',
        'high': '高',
        'very_high': '很高'
    };
    return texts[costLevel] || '未知';
}

// 获取时间文本
function getTimeText(timeLevel) {
    const texts = {
        'fast': '快速',
        'medium': '中等',
        'slow': '较慢',
        'very_slow': '很慢'
    };
    return texts[timeLevel] || '未知';
}

</script>
{% endblock %}
