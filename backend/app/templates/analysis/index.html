{% extends "base.html" %}

{% block title %}AIåˆ†æ - æ™ºç­–è‚¡æ{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-robot me-2"></i>AIæ™ºèƒ½åˆ†æ
            </h1>
            <p class="text-muted mb-4">ä½¿ç”¨å…ˆè¿›çš„å¤§è¯­è¨€æ¨¡å‹ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„è‚¡ç¥¨åˆ†ææŠ¥å‘Š</p>
        </div>
    </div>

    <!-- ä½¿ç”¨é‡å’Œé‡‘å¸æ˜¾ç¤º -->
    <div class="row mb-3">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm" id="usageCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-chart-bar me-2"></i>ä»Šæ—¥åˆ†ææ¬¡æ•°
                            </h6>
                            <span class="h5 mb-0" id="usageDisplay">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="text-end">
                            <div class="progress" style="width: 120px; height: 8px;">
                                <div class="progress-bar" id="usageProgress" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="text-muted mt-1 d-block" id="usageHint">æ¯æ—¥é™é¢ï¼š10æ¬¡</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm" id="coinCard">
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 text-muted">
                                <i class="fas fa-coins me-2"></i>é‡‘å¸ä½™é¢
                            </h6>
                            <span class="h5 mb-0" id="coinDisplay">åŠ è½½ä¸­...</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted mt-1 d-block">æ¯æ¬¡åˆ†ææ¶ˆè€—10é‡‘å¸</small>
                            <a href="{{ url_for('coin.coin_center') }}" class="btn btn-sm btn-outline-primary mt-1">
                                <i class="fas fa-plus me-1"></i>å……å€¼
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ†æè®¾ç½® -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-lg" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                <div class="card-header border-0 text-white" style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);">
                    <h5 class="mb-0 text-white">
                        <i class="fas fa-cogs me-2"></i>åˆ†æè®¾ç½®
                        <small class="ms-2 opacity-75">é…ç½®æ‚¨çš„AIåˆ†æå‚æ•°</small>
                    </h5>
                </div>
                <div class="card-body text-white" style="background: rgba(255,255,255,0.05);">
                    <div class="row g-4">
                        <!-- åˆ†æç±»å‹ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-chart-line me-2"></i>
                                    <span class="fw-bold">åˆ†æç±»å‹</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="analysisType" onchange="loadPrompts()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;">
                                        <option value="">è¯·é€‰æ‹©åˆ†æç±»å‹</option>
                                        <option value="fundamental">ğŸ“Š åŸºæœ¬é¢åˆ†æ</option>
                                        <option value="technical">ğŸ“ˆ æŠ€æœ¯é¢åˆ†æ</option>
                                    </select>
                                    <small class="text-white-50 mt-2 d-block">é€‰æ‹©åˆ†æçš„è§’åº¦å’Œæ–¹æ³•</small>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æç¤ºè¯ç‰ˆæœ¬ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-comment-dots me-2"></i>
                                    <span class="fw-bold">æç¤ºè¯ç‰ˆæœ¬</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="promptSelect" onchange="onPromptChange()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;" disabled>
                                        <option value="">è¯·å…ˆé€‰æ‹©åˆ†æç±»å‹</option>
                                    </select>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <small class="text-white-50">é€‰æ‹©åˆ†ææç¤ºè¯ç‰ˆæœ¬</small>
                                        <button type="button" class="btn btn-sm btn-light" id="previewPromptBtn" 
                                                onclick="previewSelectedPrompt()" disabled style="border-radius: 8px;">
                                            <i class="fas fa-eye me-1"></i>é¢„è§ˆ
                                        </button>
                                </div>
                            </div>
                        </div>
                        </div>
                        
                        <!-- AIæ¨¡å‹ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-robot me-2"></i>
                                    <span class="fw-bold">AIæ¨¡å‹</span>
                                </div>
                                <div class="setting-content">
                                    <select class="form-select form-select-lg" id="aiProvider" onchange="loadModels()" 
                                            style="background: rgba(255,255,255,0.9); border: none; border-radius: 12px;">
                                        <option value="">è¯·é€‰æ‹©AIæä¾›å•†</option>
                                        <option value="qwen">ğŸŒŸ é€šä¹‰åƒé—® (Qwen)</option>
                                        <option value="deepseek">ğŸš€ DeepSeek</option>
                                    </select>
                                    <div class="mt-2">
                                        <select class="form-select" id="aiModel" onchange="onModelChange()" 
                                                style="background: rgba(255,255,255,0.9); border: none; border-radius: 8px;" disabled>
                                            <option value="">è¯·å…ˆé€‰æ‹©AIæä¾›å•†</option>
                                        </select>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <small class="text-white-50" id="modelInfo">é€‰æ‹©å…·ä½“çš„AIæ¨¡å‹</small>
                                            <button type="button" class="btn btn-sm btn-light" id="previewModelBtn" 
                                                    onclick="previewSelectedModel()" disabled style="border-radius: 8px;">
                                                <i class="fas fa-eye me-1"></i>é¢„è§ˆ
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- å¿«é€Ÿæ“ä½œ -->
                        <div class="col-lg-3 col-md-6">
                            <div class="setting-card">
                                <div class="setting-header">
                                    <i class="fas fa-bolt me-2"></i>
                                    <span class="fw-bold">å¿«é€Ÿæ“ä½œ</span>
                                </div>
                                <div class="setting-content">
                                    <div class="d-grid gap-2">
                                        <button id="batchAnalyzeBtn" class="btn btn-light btn-lg" 
                                                style="border-radius: 12px; font-weight: 600;">
                                        <i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰
                                    </button>
                                        <a href="{{ url_for('analysis.tasks') }}" class="btn btn-outline-light" 
                                           style="border-radius: 12px;">
                                        <i class="fas fa-tasks me-2"></i>æŸ¥çœ‹ä»»åŠ¡
                                    </a>
                                    </div>
                                    <small class="text-white-50 mt-2 d-block">ä¸€é”®åˆ†ææ‰€æœ‰å…³æ³¨è‚¡ç¥¨</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- å…³æ³¨åˆ—è¡¨ -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-bookmark me-2"></i>å…³æ³¨è‚¡ç¥¨åˆ—è¡¨
                    </h5>
                    <div>
                        <span class="badge bg-primary" id="watchlistCount">{{ watchlist|length }}</span>
                        <span class="text-muted ms-2">æ”¯è‚¡ç¥¨</span>
                    </div>
                </div>
                <div class="card-body">
                    {% if watchlist %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>è‚¡ç¥¨ä»£ç </th>
                                        <th>å…¬å¸åç§°</th>
                                        <th>å¸‚åœº</th>
                                        <th>è¡Œä¸š</th>
                                        <th>å…³æ³¨æ—¶é—´</th>
                                        <th>æ“ä½œ</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in watchlist %}
                                    <tr>
                                        <td>
                                            <code class="text-primary">{{ item.stock.code }}</code>
                                        </td>
                                        <td>{{ item.stock.name }}</td>
                                        <td>
                                            {% if item.stock.market == 'US' %}
                                                <span class="badge bg-primary">ç¾è‚¡</span>
                                            {% else %}
                                                <span class="badge bg-success">æ¸¯è‚¡</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.stock.industry or 'æœªçŸ¥' }}</small>
                                        </td>
                                        <td>
                                            <small class="text-muted">{{ item.added_at }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group" role="group">
                                                <button class="btn btn-sm btn-outline-primary analyze-btn" 
                                                        data-stock-code="{{ item.stock.code }}"
                                                        data-stock-name="{{ item.stock.name }}">
                                                    <i class="fas fa-chart-line me-1"></i>åˆ†æ
                                                </button>
                                                <a href="{{ url_for('reports.index') }}?stock={{ item.stock.code }}" 
                                                   class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-file-alt me-1"></i>æŠ¥å‘Š
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- æ“ä½œè¯´æ˜ -->
                        <div class="mt-4">
                            <div class="alert alert-info">
                                <h6><i class="fas fa-info-circle me-2"></i>æ“ä½œè¯´æ˜</h6>
                                <ul class="mb-0">
                                    <li><strong>å•è‚¡åˆ†æï¼š</strong>ç‚¹å‡»æ¯è¡Œå³ä¾§çš„"åˆ†æ"æŒ‰é’®ï¼Œå¯¹å•ä¸ªè‚¡ç¥¨è¿›è¡ŒAIåˆ†æ</li>
                                    <li><strong>æ‰¹é‡åˆ†æï¼š</strong>ç‚¹å‡»ä¸Šæ–¹çš„"æ‰¹é‡åˆ†ææ‰€æœ‰"æŒ‰é’®ï¼Œä¸€æ¬¡æ€§åˆ†ææ‰€æœ‰å…³æ³¨çš„è‚¡ç¥¨</li>
                                    <li><strong>æŸ¥çœ‹æŠ¥å‘Šï¼š</strong>ç‚¹å‡»"æŠ¥å‘Š"æŒ‰é’®æŸ¥çœ‹è¯¥è‚¡ç¥¨çš„å†å²åˆ†ææŠ¥å‘Š</li>
                                </ul>
                            </div>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-bookmark fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">æ‚¨è¿˜æ²¡æœ‰å…³æ³¨ä»»ä½•è‚¡ç¥¨</h5>
                            <p class="text-muted">è¯·å…ˆæ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨ï¼Œç„¶åè¿›è¡ŒAIåˆ†æ</p>
                            <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>æ·»åŠ è‚¡ç¥¨
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æè¿›åº¦ -->
<div id="analysisProgress" class="row mb-4" style="display: none;">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-spinner fa-spin me-2"></i>åˆ†æè¿›åº¦
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressText" class="text-center">å‡†å¤‡å¼€å§‹åˆ†æ...</div>
                <div id="analysisResults" class="mt-3"></div>
            </div>
        </div>
    </div>
</div>

<!-- åˆ†æç»“æœæ¨¡æ€æ¡† -->
<div class="modal fade" id="analysisResultModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-chart-line me-2"></i>åˆ†æç»“æœ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysisResultContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <a href="#" id="viewFullReport" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ç¡®è®¤åˆ†æå¼¹çª— -->
<div class="modal fade" id="confirmAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>ç¡®è®¤åˆ†æ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-chart-line fa-3x text-primary mb-3"></i>
                    <h6 id="confirmStockInfo">ç¡®è®¤åˆ†æ AAPL - è‹¹æœå…¬å¸ï¼Ÿ</h6>
                    <p class="text-muted">åˆ†æä¸€æ¬¡å°†æ¶ˆè€—æ‚¨ä»Šæ—¥çš„1æ¬¡åˆ†æé¢åº¦</p>
                </div>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>å‰©ä½™æ¬¡æ•°ï¼š</strong><span id="confirmRemaining">9æ¬¡</span>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-coins me-2"></i>
                    <strong>é‡‘å¸æ¶ˆè€—ï¼š</strong><span id="confirmCoinCost">10é‡‘å¸</span>
                    <br>
                    <small class="text-muted">æ¯æ¬¡åˆ†æå°†æ¶ˆè€—10é‡‘å¸ï¼Œè¯·ç¡®ä¿æ‚¨çš„é‡‘å¸ä½™é¢å……è¶³</small>
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>å–æ¶ˆ
                </button>
                <button type="button" class="btn btn-primary" id="confirmAnalysisBtn">
                    <i class="fas fa-check me-2"></i>ç¡®è®¤åˆ†æ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ä»»åŠ¡å®Œæˆå¼¹çª— -->
<div class="modal fade" id="taskCompletedModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0 text-center">
                <h5 class="modal-title w-100">
                    <i class="fas fa-check-circle text-success me-2"></i>ä»»åŠ¡æäº¤æˆåŠŸ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                    <h6 class="text-success">æ‰¹é‡åˆ†æä»»åŠ¡å·²æˆåŠŸæäº¤ï¼</h6>
                    <p class="text-muted">æ‚¨çš„åˆ†æä»»åŠ¡æ­£åœ¨åå°è¿è¡Œï¼Œå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ã€‚</p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>æç¤ºï¼š</strong>æ‚¨å¯ä»¥éšæ—¶åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹è¿›åº¦å’Œç»“æœã€‚
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ç»§ç»­åˆ†æ
                </button>
                <a href="/reports/" class="btn btn-primary">
                    <i class="fas fa-chart-line me-2"></i>æŸ¥çœ‹æŠ¥å‘Š
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
.progress {
    height: 25px;
    background: rgba(102, 126, 234, 0.1);
    border-radius: 15px;
}

.progress-bar {
    background: linear-gradient(45deg, #667eea, #764ba2);
    border-radius: 15px;
}

.analysis-result-item {
    padding: 10px;
    margin: 5px 0;
    border-radius: 8px;
    border-left: 4px solid;
}

.analysis-result-success {
    background: rgba(40, 167, 69, 0.1);
    border-left-color: #28a745;
}

.analysis-result-error {
    background: rgba(220, 53, 69, 0.1);
    border-left-color: #dc3545;
}

.analysis-result-pending {
    background: rgba(255, 193, 7, 0.1);
    border-left-color: #ffc107;
}
</style>
{% endblock %}

{% block extra_js %}
<style>
.setting-card {
    background: rgba(255,255,255,0.1);
    border-radius: 16px;
    padding: 20px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
    transition: all 0.3s ease;
    height: 100%;
}

.setting-card:hover {
    background: rgba(255,255,255,0.15);
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.setting-header {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    font-size: 16px;
    color: white;
}

.setting-content {
    color: white;
}

.form-select:focus {
    box-shadow: 0 0 0 0.2rem rgba(255,255,255,0.25);
    border-color: rgba(255,255,255,0.5);
}

.btn-light:hover {
    background-color: rgba(255,255,255,0.9);
    border-color: rgba(255,255,255,0.9);
    transform: translateY(-1px);
}

.btn-outline-light:hover {
    background-color: rgba(255,255,255,0.1);
    border-color: rgba(255,255,255,0.5);
    color: white;
}

.gradient-text {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

@media (max-width: 768px) {
    .setting-card {
        margin-bottom: 20px;
    }
}
</style>

<script>
// å…¨å±€å˜é‡
    let analysisQueue = [];
    let currentAnalysisIndex = 0;
    let analysisResults = [];
    let currentUsageData = null;
    let pendingAnalysis = null;
    
// åŠ è½½æç¤ºè¯åˆ—è¡¨ - å…¨å±€å‡½æ•°
function loadPrompts() {
    console.log('=== loadPrompts å‡½æ•°è¢«è°ƒç”¨ ===');
    const analysisType = $('#analysisType').val();
    console.log('å½“å‰é€‰æ‹©çš„åˆ†æç±»å‹:', analysisType);
    console.log('analysisType å…ƒç´ :', $('#analysisType'));
    
    if (!analysisType) {
        console.log('æ²¡æœ‰é€‰æ‹©åˆ†æç±»å‹ï¼Œç¦ç”¨æç¤ºè¯ä¸‹æ‹‰æ¡†');
        $('#promptSelect').html('<option value="">è¯·å…ˆé€‰æ‹©åˆ†æç±»å‹</option>').prop('disabled', true);
        $('#previewPromptBtn').prop('disabled', true);
        return;
    }
    
    console.log('å¼€å§‹åŠ è½½æç¤ºè¯ï¼Œåˆ†æç±»å‹:', analysisType);
    $('#promptSelect').html('<option value="">åŠ è½½ä¸­...</option>');
    $('#previewPromptBtn').prop('disabled', true);
    
    const apiUrl = `/api/prompt/prompts/type/${analysisType}`;
    console.log('APIè¯·æ±‚URL:', apiUrl);
    
    $.ajax({
        url: apiUrl,
        method: 'GET',
        success: function(response) {
            console.log('APIè¯·æ±‚æˆåŠŸï¼Œå“åº”:', response);
            if (response.success) {
                console.log('å¼€å§‹æ›´æ–°æç¤ºè¯ä¸‹æ‹‰æ¡†ï¼Œæç¤ºè¯æ•°é‡:', response.data.prompts.length);
                updatePromptSelect(response.data.prompts);
            } else {
                console.error('APIè¿”å›å¤±è´¥:', response.message);
                $('#promptSelect').html('<option value="">è·å–å¤±è´¥</option>').prop('disabled', true);
                $('#previewPromptBtn').prop('disabled', true);
            }
        },
        error: function(xhr, status, error) {
            console.error('APIè¯·æ±‚å¤±è´¥:', error);
            console.error('çŠ¶æ€ç :', xhr.status);
            console.error('å“åº”æ–‡æœ¬:', xhr.responseText);
            $('#promptSelect').html('<option value="">è·å–å¤±è´¥</option>').prop('disabled', true);
            $('#previewPromptBtn').prop('disabled', true);
        }
    });
}

// æ›´æ–°æç¤ºè¯é€‰æ‹©æ¡† - å…¨å±€å‡½æ•°
function updatePromptSelect(prompts) {
    console.log('=== updatePromptSelect å‡½æ•°è¢«è°ƒç”¨ ===');
    console.log('æ¥æ”¶åˆ°çš„æç¤ºè¯æ•°æ®:', prompts);
    console.log('æç¤ºè¯æ•°é‡:', prompts.length);
    
    const select = $('#promptSelect');
    console.log('æ‰¾åˆ°çš„selectå…ƒç´ :', select);
    console.log('selectå…ƒç´ é•¿åº¦:', select.length);
    
    select.empty();
    console.log('å·²æ¸…ç©ºä¸‹æ‹‰æ¡†');
    
    if (prompts.length === 0) {
        console.log('æ²¡æœ‰å¯ç”¨æç¤ºè¯ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€');
        select.append('<option value="">æš‚æ— å¯ç”¨æç¤ºè¯</option>');
        select.prop('disabled', true);
        $('#previewPromptBtn').prop('disabled', true);
        return;
    }
    
    // æ·»åŠ é»˜è®¤é€‰é¡¹
    console.log('æ·»åŠ é»˜è®¤é€‰é¡¹');
    select.append('<option value="">ä½¿ç”¨é»˜è®¤æç¤ºè¯</option>');
    
    // æ·»åŠ æç¤ºè¯é€‰é¡¹
    console.log('å¼€å§‹æ·»åŠ æç¤ºè¯é€‰é¡¹');
    prompts.forEach((prompt, index) => {
        const isDefault = prompt.is_default ? ' (é»˜è®¤)' : '';
        const version = `v${prompt.version}`;
        const usage = prompt.usage_count > 0 ? ` (ä½¿ç”¨${prompt.usage_count}æ¬¡)` : '';
        const optionText = `${prompt.name} ${version}${isDefault}${usage}`;
        
        console.log(`æ·»åŠ ç¬¬${index + 1}ä¸ªé€‰é¡¹:`, optionText);
        console.log('æç¤ºè¯ID:', prompt.id);
        
        // å®‰å…¨åœ°åºåˆ—åŒ–æç¤ºè¯æ•°æ®ï¼Œé¿å…JSONè§£æé”™è¯¯
        const safePromptData = {
            id: prompt.id,
            name: prompt.name,
            version: prompt.version,
            prompt_type: prompt.prompt_type,
            description: prompt.description,
            content: prompt.content,
            is_active: prompt.is_active,
            is_default: prompt.is_default,
            usage_count: prompt.usage_count,
            created_at: prompt.created_at,
            updated_at: prompt.updated_at,
            last_used_at: prompt.last_used_at
        };
        
        const optionHtml = `<option value="${prompt.id}" data-prompt='${JSON.stringify(safePromptData).replace(/'/g, '&#39;')}'>${optionText}</option>`;
        select.append(optionHtml);
        console.log('å·²æ·»åŠ é€‰é¡¹HTML:', optionHtml);
    });
    
    // å¯ç”¨ä¸‹æ‹‰æ¡†å’Œé¢„è§ˆæŒ‰é’®
    console.log('å¯ç”¨ä¸‹æ‹‰æ¡†å’Œé¢„è§ˆæŒ‰é’®');
    select.prop('disabled', false);
    $('#previewPromptBtn').prop('disabled', false);
    
    console.log('ä¸‹æ‹‰æ¡†å½“å‰HTMLå†…å®¹:', select.html());
    console.log('ä¸‹æ‹‰æ¡†æ˜¯å¦ç¦ç”¨:', select.prop('disabled'));
    console.log('=== updatePromptSelect å‡½æ•°æ‰§è¡Œå®Œæˆ ===');
}

// æç¤ºè¯é€‰æ‹©å˜åŒ–æ—¶çš„å¤„ç† - å…¨å±€å‡½æ•°
function onPromptChange() {
    const selectedPromptId = $('#promptSelect').val();
    if (selectedPromptId) {
        $('#previewPromptBtn').prop('disabled', false);
    } else {
        $('#previewPromptBtn').prop('disabled', true);
    }
}

// é¢„è§ˆé€‰ä¸­çš„æç¤ºè¯ - å…¨å±€å‡½æ•°
function previewSelectedPrompt() {
    const selectedPromptId = $('#promptSelect').val();
    if (!selectedPromptId) {
        showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæç¤ºè¯', 'warning');
        return;
    }
    
    const selectedOption = $('#promptSelect option:selected');
    const promptDataString = selectedOption.attr('data-prompt');
    
    if (!promptDataString) {
        showAlert('æ— æ³•è·å–æç¤ºè¯è¯¦æƒ…', 'error');
        return;
    }
    
    try {
        // å®‰å…¨åœ°è§£æJSONï¼Œå¤„ç†HTMLå®ä½“
        const cleanPromptDataString = promptDataString.replace(/&#39;/g, "'");
        const promptData = JSON.parse(cleanPromptDataString);
        
        if (promptData) {
            showPromptPreview(promptData);
        } else {
            showAlert('æ— æ³•è·å–æç¤ºè¯è¯¦æƒ…', 'error');
        }
    } catch (error) {
        console.error('JSONè§£æé”™è¯¯:', error);
        showAlert('æç¤ºè¯æ•°æ®æ ¼å¼é”™è¯¯', 'error');
    }
}

// è·å–ä½¿ç”¨é‡æ•°æ® - å…¨å±€å‡½æ•°
    function loadUsageData() {
        $.ajax({
            url: '/api/analysis/usage',
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    currentUsageData = response.usage;
                    updateUsageDisplay(currentUsageData);
                }
            },
            error: function(xhr, status, error) {
                console.error('è·å–ä½¿ç”¨é‡å¤±è´¥:', error);
                $('#usageDisplay').text('è·å–å¤±è´¥');
            }
        });
    }
    
    // è·å–ç”¨æˆ·é‡‘å¸ä¿¡æ¯
    function loadUserCoinInfo() {
        $.ajax({
            url: '/api/coin/info',
            method: 'GET',
            xhrFields: {
                withCredentials: true
            },
            crossDomain: false,
            success: function(response) {
                if (response.success) {
                    const coinInfo = response.data;
                    const availableCoins = coinInfo.available_coins || 0;
                    const coinCost = 10;
                    
                    // æ›´æ–°é¡µé¢é‡‘å¸æ˜¾ç¤º
                    $('#coinDisplay').text(`${availableCoins}é‡‘å¸`);
                    if (availableCoins < coinCost) {
                        $('#coinDisplay').addClass('text-danger');
                    } else {
                        $('#coinDisplay').removeClass('text-danger');
                    }
                    
                    // æ›´æ–°ç¡®è®¤å¼¹çª—ä¸­çš„é‡‘å¸æ¶ˆè€—æ˜¾ç¤º
                    if (availableCoins >= coinCost) {
                        $('#confirmCoinCost').html(`<span class="text-success">10é‡‘å¸</span><br><small class="text-muted">å½“å‰ä½™é¢ï¼š${availableCoins}é‡‘å¸</small>`);
                    } else {
                        $('#confirmCoinCost').html(`<span class="text-danger">10é‡‘å¸</span><br><small class="text-danger">ä½™é¢ä¸è¶³ï¼å½“å‰ä½™é¢ï¼š${availableCoins}é‡‘å¸</small>`);
                    }
                } else {
                    console.error('è·å–é‡‘å¸ä¿¡æ¯å¤±è´¥:', response.message);
                    $('#coinDisplay').text('è·å–å¤±è´¥');
                    $('#confirmCoinCost').text('10é‡‘å¸ï¼ˆæ— æ³•è·å–ä½™é¢ï¼‰');
                }
            },
            error: function(xhr, status, error) {
                console.error('è·å–é‡‘å¸ä¿¡æ¯å¤±è´¥:', error);
                $('#coinDisplay').text('è·å–å¤±è´¥');
                $('#confirmCoinCost').text('10é‡‘å¸ï¼ˆæ— æ³•è·å–ä½™é¢ï¼‰');
            }
        });
    }
    
// æ›´æ–°ä½¿ç”¨é‡æ˜¾ç¤º - å…¨å±€å‡½æ•°
    function updateUsageDisplay(usage) {
        const current = usage.current_count;
        const limit = usage.daily_limit;
        const remaining = usage.remaining;
        const percentage = (current / limit) * 100;
        
        $('#usageDisplay').text(`${current}/${limit}`);
        $('#usageProgress').css('width', `${Math.min(percentage, 100)}%`);
        
        if (usage.is_admin) {
            $('#usageHint').text('ç®¡ç†å‘˜æ— é™åˆ¶');
            $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
        } else {
            $('#usageHint').text(`æ¯æ—¥é™é¢ï¼š${limit}æ¬¡`);
            
            if (percentage >= 100) {
                $('#usageProgress').removeClass('bg-success bg-warning').addClass('bg-danger');
            } else if (percentage >= 80) {
                $('#usageProgress').removeClass('bg-success bg-danger').addClass('bg-warning');
            } else {
                $('#usageProgress').removeClass('bg-warning bg-danger').addClass('bg-success');
            }
        }
    }

$(document).ready(function() {
    // é¡µé¢åŠ è½½æ—¶è·å–ä½¿ç”¨é‡å’Œé‡‘å¸ä¿¡æ¯
    loadUsageData();
    loadUserCoinInfo();
    
    
    // å•ä¸ªè‚¡ç¥¨åˆ†æ
    $('.analyze-btn').click(function() {
        console.log('åˆ†ææŒ‰é’®è¢«ç‚¹å‡»');
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const stockName = btn.data('stock-name');
        
        // æ£€æŸ¥ä½¿ç”¨é‡é™åˆ¶
        if (currentUsageData && !currentUsageData.is_admin && !currentUsageData.can_analyze) {
            showToast('error', `ä»Šæ—¥åˆ†ææ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${currentUsageData.daily_limit}æ¬¡ï¼‰ï¼Œè¯·æ˜å¤©å†è¯•`);
            return;
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¼¹çª—
        showConfirmAnalysis(stockCode, stockName, btn);
    });
    
    // æ˜¾ç¤ºç¡®è®¤åˆ†æå¼¹çª—
    function showConfirmAnalysis(stockCode, stockName, btn) {
        pendingAnalysis = { stockCode, stockName, btn };
        
        $('#confirmStockInfo').text(`ç¡®è®¤åˆ†æ ${stockCode} - ${stockName}ï¼Ÿ`);
        
        if (currentUsageData && currentUsageData.is_admin) {
            $('#confirmRemaining').text('æ— é™åˆ¶');
            $('#confirmCoinCost').text('å…è´¹ï¼ˆç®¡ç†å‘˜ï¼‰');
        } else if (currentUsageData) {
            $('#confirmRemaining').text(`${currentUsageData.remaining}æ¬¡`);
            $('#confirmCoinCost').text('10é‡‘å¸');
        } else {
            $('#confirmRemaining').text('åŠ è½½ä¸­...');
            $('#confirmCoinCost').text('10é‡‘å¸');
        }
        
        // è·å–ç”¨æˆ·é‡‘å¸ä½™é¢
        loadUserCoinInfo();
        
        $('#confirmAnalysisModal').modal('show');
    }
    
    // ç¡®è®¤åˆ†ææŒ‰é’®ç‚¹å‡»
    $('#confirmAnalysisBtn').click(function() {
        if (!pendingAnalysis) return;
        
        $('#confirmAnalysisModal').modal('hide');
        executeAnalysis(pendingAnalysis.stockCode, pendingAnalysis.stockName, pendingAnalysis.btn);
        pendingAnalysis = null;
    });
    
    // æ‰§è¡Œåˆ†æï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰
    function executeAnalysis(stockCode, stockName, btn) {
        const analysisType = $('#analysisType').val();
        const aiProvider = $('#aiProvider').val();
        const aiModel = $('#aiModel').val();
        
        console.log('è‚¡ç¥¨ä»£ç :', stockCode);
        console.log('è‚¡ç¥¨åç§°:', stockName);
        console.log('åˆ†æç±»å‹:', analysisType);
        console.log('AIæä¾›å•†:', aiProvider);
        console.log('AIæ¨¡å‹:', aiModel);
        
        // ç¦ç”¨æŒ‰é’®
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>æäº¤ä¸­...');
        
        console.log('å‘é€åˆ†æè¯·æ±‚åˆ°:', '/api/analysis/analyze');
        
        // å‘é€åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stockCode,
                analysis_type: analysisType,
                ai_provider: aiProvider,
                ai_model: aiModel,
                prompt_id: $('#promptSelect').val() || null
            }),
            success: function(response) {
                console.log('åˆ†æè¯·æ±‚æˆåŠŸ:', response);
                if (response.success) {
                    showToast('success', `${stockCode} åˆ†æä»»åŠ¡å·²æäº¤ï¼æ¶ˆè€—10é‡‘å¸ï¼Œè¯·ç¨åæŸ¥çœ‹ç»“æœã€‚`);
                    
                    // æ›´æ–°ä½¿ç”¨é‡
                    loadUsageData();
                    
                    // æ˜¾ç¤ºä»»åŠ¡æäº¤æˆåŠŸæç¤º
                    showTaskSubmittedModal(stockCode, response.data.task_id);
                } else {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯é‡‘å¸ä¸è¶³é”™è¯¯
                    if (response.message && response.message.includes('é‡‘å¸ä¸è¶³')) {
                        showToast('error', `åˆ†æå¤±è´¥: ${response.message}ï¼Œè¯·å‰å¾€é‡‘å¸ä¸­å¿ƒå……å€¼ã€‚`);
                    } else {
                        showToast('error', `${stockCode} åˆ†æå¤±è´¥: ${response.message}`);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('åˆ†æè¯·æ±‚å¤±è´¥:', xhr, status, error);
                const response = xhr.responseJSON;
                
                if (response && response.error === 'DAILY_LIMIT_REACHED') {
                    showToast('error', `ä»Šæ—¥åˆ†ææ¬¡æ•°å·²è¾¾ä¸Šé™ï¼ˆ${response.data?.daily_limit || 10}æ¬¡ï¼‰ï¼Œè¯·æ˜å¤©å†è¯•`);
                    // æ›´æ–°ä½¿ç”¨é‡æ˜¾ç¤º
                    if (response.data) {
                        updateUsageDisplay(response.data);
                    }
                } else {
                    showToast('error', `${stockCode} åˆ†æå¤±è´¥: ${response?.message || 'ç½‘ç»œé”™è¯¯'}`);
                }
            },
            complete: function() {
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-chart-line me-1"></i>åˆ†æ');
            }
        });
    }
    
    // æ˜¾ç¤ºä»»åŠ¡æäº¤æˆåŠŸå¼¹çª—
    function showTaskSubmittedModal(stockCode, taskId) {
        const modal = `
            <div class="modal fade" id="singleTaskSubmittedModal" tabindex="-1">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content glass-effect">
                        <div class="modal-header border-0 text-center">
                            <h5 class="modal-title w-100">
                                <i class="fas fa-check-circle text-success me-2"></i>ä»»åŠ¡æäº¤æˆåŠŸ
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-4">
                                <i class="fas fa-rocket fa-3x text-primary mb-3"></i>
                                <h6 class="text-success">${stockCode} åˆ†æä»»åŠ¡å·²æˆåŠŸæäº¤ï¼</h6>
                                <p class="text-muted">æ‚¨çš„åˆ†æä»»åŠ¡æ­£åœ¨åå°è¿è¡Œï¼Œå®Œæˆåå¯ä»¥åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹ç»“æœã€‚</p>
                            </div>
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>ä»»åŠ¡IDï¼š</strong>${taskId}
                            </div>
                        </div>
                        <div class="modal-footer border-0 justify-content-center">
                            <button type="button" class="btn btn-outline-secondary me-3" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>ç»§ç»­åˆ†æ
                            </button>
                            <a href="/reports/" class="btn btn-primary">
                                <i class="fas fa-chart-line me-2"></i>æŸ¥çœ‹æŠ¥å‘Š
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤ä¹‹å‰çš„æ¨¡æ€æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        $('#singleTaskSubmittedModal').remove();
        
        // æ·»åŠ æ–°çš„æ¨¡æ€æ¡†åˆ°é¡µé¢
        $('body').append(modal);
        
        // æ˜¾ç¤ºæ¨¡æ€æ¡†
        const taskModal = new bootstrap.Modal(document.getElementById('singleTaskSubmittedModal'));
        taskModal.show();
        
        // æ¨¡æ€æ¡†å…³é—­åæ¸…ç†
        $('#singleTaskSubmittedModal').on('hidden.bs.modal', function() {
            $(this).remove();
        });
    }
    
    // æ‰¹é‡åˆ†æ
    $('#batchAnalyzeBtn').click(function() {
        const btn = $(this);
        const analysisType = $('#analysisType').val();
        
        if ($('.analyze-btn').length === 0) {
            showToast('error', 'è¯·å…ˆæ·»åŠ è‚¡ç¥¨åˆ°å…³æ³¨åˆ—è¡¨');
            return;
        }
        
        // æ”¶é›†è¦åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // æ„å»ºç¾è§‚çš„ç¡®è®¤ä¿¡æ¯
        const stockList = stocksToAnalyze.map(stock => `â€¢ ${stock.code} (${stock.name})`).join('\n');
        const estimatedTime = Math.ceil(stocksToAnalyze.length * 0.5); // æ¯åªè‚¡ç¥¨çº¦30ç§’
        const analysisTypeName = getAnalysisTypeName(analysisType);
        
        const confirmMessage = `ğŸ¯ æ‰¹é‡åˆ†æä»»åŠ¡ç¡®è®¤

ğŸ“Š åˆ†æç±»å‹ï¼š${analysisTypeName}
â±ï¸ é¢„è®¡æ—¶é—´ï¼šçº¦ ${estimatedTime} åˆ†é’Ÿ
ğŸ¤– AIæ¨¡å‹ï¼š${$('#aiProvider option:selected').text()}

ğŸ“‹ å¾…åˆ†æè‚¡ç¥¨ (${stocksToAnalyze.length} åª)ï¼š
${stockList}

ğŸ’¡ æç¤ºï¼šåˆ†æå°†åœ¨åå°å¼‚æ­¥è¿›è¡Œï¼Œæ‚¨å¯ä»¥ç¦»å¼€é¡µé¢åšå…¶ä»–äº‹æƒ…ã€‚åˆ†æå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ï¼Œæ‚¨ä¹Ÿå¯ä»¥åœ¨"åˆ†ææŠ¥å‘Š"é¡µé¢æŸ¥çœ‹ç»“æœã€‚`;
        
        if (confirmAction) {
            confirmAction(
                'ğŸš€ æ‰¹é‡åˆ†æç¡®è®¤',
                confirmMessage,
                function() {
                    startBatchAnalysis(analysisType);
                }
            );
        } else {
            showConfirmModal(
                'ç¡®è®¤æ‰¹é‡åˆ†æ',
                confirmMessage,
                function() {
                startBatchAnalysis(analysisType);
            }
            );
        }
    });
    
    function startBatchAnalysis(analysisType) {
        const btn = $('#batchAnalyzeBtn');
        btn.prop('disabled', true);
        btn.html('<i class="fas fa-spinner fa-spin me-2"></i>æäº¤ä»»åŠ¡ä¸­...');
        
        // æ”¶é›†è¦åˆ†æçš„è‚¡ç¥¨ä¿¡æ¯
        const stocksToAnalyze = [];
        $('.analyze-btn').each(function() {
            stocksToAnalyze.push({
                code: $(this).data('stock-code'),
                name: $(this).data('stock-name')
            });
        });
        
        // å‘é€å¼‚æ­¥æ‰¹é‡åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/batch-analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                stocks: stocksToAnalyze,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val(),
                ai_model: $('#aiModel').val()
            }),
            success: function(response) {
                if (response.success) {
                    showToast('success', `æ‰¹é‡åˆ†æä»»åŠ¡å·²æäº¤ï¼ä»»åŠ¡ID: ${response.task_id}\nåˆ†æå®Œæˆåä¼šé€šè¿‡é‚®ä»¶é€šçŸ¥æ‚¨ã€‚`);
                    
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
                    
                    // å¯ä»¥é€‰æ‹©è·³è½¬åˆ°æŠ¥å‘Šé¡µé¢
                    setTimeout(function() {
                        // æ˜¾ç¤ºç¾è§‚çš„ä»»åŠ¡å®Œæˆå¼¹çª—
                        const taskCompletedModal = new bootstrap.Modal(document.getElementById('taskCompletedModal'));
                        taskCompletedModal.show();
                    }, 1000);
                } else {
                    showToast('error', response.message || 'æäº¤æ‰¹é‡åˆ†æä»»åŠ¡å¤±è´¥');
                    btn.prop('disabled', false);
                    btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
                btn.prop('disabled', false);
                btn.html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
            }
        });
    }
    
    function processNextAnalysis(analysisType) {
        if (currentAnalysisIndex >= analysisQueue.length) {
            // åˆ†æå®Œæˆ
            completeBatchAnalysis();
            return;
        }
        
        const stock = analysisQueue[currentAnalysisIndex];
        updateProgressText(`æ­£åœ¨åˆ†æ ${stock.code} (${stock.name})...`);
        
        // å‘é€åˆ†æè¯·æ±‚
        $.ajax({
            url: '/api/analysis/analyze',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ 
                stock_code: stock.code,
                analysis_type: analysisType,
                ai_provider: $('#aiProvider').val(),
                ai_model: $('#aiModel').val(),
                prompt_id: $('#promptSelect').val() || null
            }),
            success: function(response) {
                const result = {
                    stock: stock,
                    success: response.success,
                    data: response.data,
                    error: response.message
                };
                analysisResults.push(result);
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                updateAnalysisResults();
                
                // ç»§ç»­ä¸‹ä¸€ä¸ª
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                const result = {
                    stock: stock,
                    success: false,
                    error: response?.message || 'ç½‘ç»œé”™è¯¯'
                };
                analysisResults.push(result);
                
                // æ›´æ–°ç»“æœæ˜¾ç¤º
                updateAnalysisResults();
                
                // ç»§ç»­ä¸‹ä¸€ä¸ª
                currentAnalysisIndex++;
                processNextAnalysis(analysisType);
            }
        });
    }
    
    function updateProgress() {
        const progress = (currentAnalysisIndex / analysisQueue.length) * 100;
        $('#progressBar').css('width', progress + '%');
        $('#progressBar').text(Math.round(progress) + '%');
    }
    
    function updateProgressText(text) {
        $('#progressText').text(text);
        updateProgress();
    }
    
    function updateAnalysisResults() {
        const resultsContainer = $('#analysisResults');
        resultsContainer.empty();
        
        analysisResults.forEach(function(result, index) {
            const statusClass = result.success ? 'success' : 'error';
            const statusIcon = result.success ? 'fa-check-circle' : 'fa-exclamation-circle';
            const statusText = result.success ? 'æˆåŠŸ' : 'å¤±è´¥';
            
            const resultHtml = `
                <div class="analysis-result-item analysis-result-${statusClass}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas ${statusIcon} me-2"></i>
                            <strong>${result.stock.code}</strong> - ${result.stock.name}
                        </div>
                        <span class="badge bg-${result.success ? 'success' : 'danger'}">${statusText}</span>
                    </div>
                    ${result.error ? `<small class="text-muted">${result.error}</small>` : ''}
                </div>
            `;
            resultsContainer.append(resultHtml);
        });
    }
    
    function completeBatchAnalysis() {
        const successCount = analysisResults.filter(r => r.success).length;
        const totalCount = analysisResults.length;
        
        updateProgressText(`åˆ†æå®Œæˆï¼æˆåŠŸ ${successCount}/${totalCount}`);
        $('#progressBar').removeClass('progress-bar-animated');
        
        // é‡æ–°å¯ç”¨æŒ‰é’®
        $('#batchAnalyzeBtn').prop('disabled', false);
        $('#batchAnalyzeBtn').html('<i class="fas fa-magic me-2"></i>æ‰¹é‡åˆ†ææ‰€æœ‰');
        
        // æ˜¾ç¤ºå®Œæˆæ¶ˆæ¯
        showToast('success', `æ‰¹é‡åˆ†æå®Œæˆï¼æˆåŠŸ ${successCount}/${totalCount} æ”¯è‚¡ç¥¨`);
        
        // 3ç§’åéšè—è¿›åº¦
        setTimeout(function() {
            $('#analysisProgress').fadeOut();
        }, 3000);
    }
    
    function showAnalysisResult(stockCode, stockName, reportData) {
        // æ˜¾ç¤ºåˆ†æç»“æœæ¨¡æ€æ¡†
        const content = `
            <div class="analysis-result-header mb-3">
                <h4 class="mb-2">${stockName} (${stockCode}) åˆ†ææŠ¥å‘Š</h4>
                <div class="mb-3">
                    <span class="badge bg-primary me-2">${reportData.provider || 'AI'}</span>
                    <span class="badge bg-secondary me-2">${reportData.analysis_date}</span>
                    <span class="badge bg-info">${reportData.metadata?.model || 'AIæ¨¡å‹'}</span>
                </div>
            </div>
            <div class="analysis-content">
                <div class="analysis-preview mb-3">
                    <h6>åˆ†æå†…å®¹é¢„è§ˆï¼š</h6>
                    <div class="border rounded p-3 bg-light" style="max-height: 300px; overflow-y: auto;">
                        ${formatAnalysisContent(reportData.content)}
                    </div>
                </div>
                <div class="analysis-actions">
                    <a href="/reports/${stockCode}" class="btn btn-primary me-2" target="_blank">
                        <i class="fas fa-external-link-alt me-1"></i>æŸ¥çœ‹å®Œæ•´æŠ¥å‘Š
                    </a>
                    <button class="btn btn-outline-secondary me-2" onclick="downloadReport('${stockCode}', '${stockName}')">
                        <i class="fas fa-download me-1"></i>ä¸‹è½½æŠ¥å‘Š
                    </button>
                </div>
            </div>
        `;
        
        $('#analysisResultContent').html(content);
        
        const modal = new bootstrap.Modal(document.getElementById('analysisResultModal'));
        modal.show();
    }
    
    function formatAnalysisContent(content) {
        // ç®€å•çš„Markdownæ ¼å¼åŒ–
        return content
            .replace(/#{1,6}\s+(.+)/g, '<strong>$1</strong>')
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*/g, '<em>$1</em>')
            .replace(/\n/g, '<br>');
    }
    
    function downloadReport(stockCode, stockName) {
        // ä¸‹è½½æŠ¥å‘ŠåŠŸèƒ½
        const link = document.createElement('a');
        link.href = `/api/analysis/reports/${stockCode}/download`;
        link.download = `${stockCode}_${stockName}_åˆ†ææŠ¥å‘Š_${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    
    function getAnalysisTypeName(type) {
        const types = {
            'fundamental': 'åŸºæœ¬é¢åˆ†æ',
            'technical': 'æŠ€æœ¯é¢åˆ†æ'
        };
        return types[type] || 'ç»¼åˆåˆ†æ';
    }
    
    // æ˜¾ç¤ºToastæ¶ˆæ¯
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
    
});

// æ˜¾ç¤ºæç¤ºè¯é¢„è§ˆå¼¹çª— - å…¨å±€å‡½æ•°
function showPromptPreview(promptData) {
        const modalHtml = `
            <div class="modal fade" id="promptPreviewModal" tabindex="-1" aria-labelledby="promptPreviewModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header bg-gradient-primary text-white">
                            <h5 class="modal-title" id="promptPreviewModalLabel">
                                <i class="fas fa-eye me-2"></i>æç¤ºè¯é¢„è§ˆ
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body p-0">
                            <!-- åŸºæœ¬ä¿¡æ¯å¡ç‰‡ -->
                            <div class="p-3 border-bottom">
                                <div class="row g-3">
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-tag text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">åç§°</small>
                                                <strong>${promptData.name}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-code-branch text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">ç‰ˆæœ¬</small>
                                                <strong>v${promptData.version}</strong>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-layer-group text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">ç±»å‹</small>
                                                <span class="badge bg-info">${promptData.prompt_type === 'fundamental' ? 'åŸºç¡€åˆ†æ' : 'æŠ€æœ¯åˆ†æ'}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-chart-line text-primary me-2"></i>
                                            <div>
                                                <small class="text-muted d-block">ä½¿ç”¨æ¬¡æ•°</small>
                                                <strong>${promptData.usage_count}</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            ${promptData.description ? `
                                <!-- æè¿°ä¿¡æ¯ -->
                                <div class="p-3 border-bottom">
                                    <h6 class="text-primary mb-2">
                                        <i class="fas fa-comment me-2"></i>æè¿°
                                    </h6>
                                    <p class="mb-0 text-muted">${promptData.description}</p>
                                </div>
                            ` : ''}
                            
                            <!-- æç¤ºè¯å†…å®¹ -->
                            <div class="p-3">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h6 class="text-primary mb-0">
                                        <i class="fas fa-code me-2"></i>æç¤ºè¯å†…å®¹
                                    </h6>
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-secondary" onclick="copyPromptContent()">
                                            <i class="fas fa-copy me-1"></i>å¤åˆ¶
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="togglePromptView()">
                                            <i class="fas fa-expand me-1"></i>å…¨å±
                                        </button>
                                    </div>
                                </div>
                                <div class="border rounded bg-light" style="max-height: 300px; overflow-y: auto;">
                                    <pre id="promptContent" class="mb-0 p-3" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">${promptData.content}</pre>
                                </div>
                                <small class="text-muted mt-2 d-block">
                                    <i class="fas fa-info-circle me-1"></i>å­—ç¬¦æ•°: ${promptData.content.length}
                                </small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-2"></i>å…³é—­
                            </button>
                            <button type="button" class="btn btn-primary" onclick="useThisPrompt('${promptData.id}')">
                                <i class="fas fa-check me-2"></i>ä½¿ç”¨æ­¤æç¤ºè¯
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // ç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
        $('#promptPreviewModal').remove();
        
        // æ·»åŠ æ–°å¼¹çª—
        $('body').append(modalHtml);
        
        // æ˜¾ç¤ºå¼¹çª—
        const modal = new bootstrap.Modal(document.getElementById('promptPreviewModal'));
        modal.show();
    }

// å¤åˆ¶æç¤ºè¯å†…å®¹ - å…¨å±€å‡½æ•°
function copyPromptContent() {
    const content = document.getElementById('promptContent').textContent;
    navigator.clipboard.writeText(content).then(() => {
        showAlert('æç¤ºè¯å†…å®¹å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
    }).catch(() => {
        showAlert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', 'warning');
    });
}

// åˆ‡æ¢å…¨å±è§†å›¾ - å…¨å±€å‡½æ•°
function togglePromptView() {
    const modal = document.getElementById('promptPreviewModal');
    const modalDialog = modal.querySelector('.modal-dialog');
    
    if (modalDialog.classList.contains('modal-fullscreen')) {
        modalDialog.classList.remove('modal-fullscreen');
    } else {
        modalDialog.classList.add('modal-fullscreen');
    }
}

// ä½¿ç”¨é€‰ä¸­çš„æç¤ºè¯ - å…¨å±€å‡½æ•°
function useThisPrompt(promptId) {
    $('#promptSelect').val(promptId);
    $('#promptPreviewModal').modal('hide');
    showAlert('å·²é€‰æ‹©è¯¥æç¤ºè¯', 'success');
}

// åŠ è½½æ¨¡å‹åˆ—è¡¨
function loadModels() {
    const provider = $('#aiProvider').val();
    console.log('loadModels called, provider:', provider);
    
    if (!provider) {
        $('#aiModel').html('<option value="">è¯·å…ˆé€‰æ‹©AIæä¾›å•†</option>').prop('disabled', true);
        $('#previewModelBtn').prop('disabled', true);
        $('#modelInfo').text('é€‰æ‹©å…·ä½“çš„AIæ¨¡å‹');
        return;
    }
    
    $('#aiModel').html('<option value="">åŠ è½½ä¸­...</option>').prop('disabled', true);
    $('#previewModelBtn').prop('disabled', true);
    $('#modelInfo').text('æ­£åœ¨åŠ è½½æ¨¡å‹åˆ—è¡¨...');
    
    $.ajax({
        url: `/api/models/${provider}`,
        method: 'GET',
        success: function(response) {
            console.log('Models API response:', response);
            if (response.success) {
                const models = response.data;
                let options = '<option value="">è¯·é€‰æ‹©AIæ¨¡å‹</option>';
                
                Object.keys(models).forEach(modelKey => {
                    const model = models[modelKey];
                    const costIcon = getCostIcon(model.cost_level);
                    const timeIcon = getTimeIcon(model.response_time);
                    const warningText = model.warning ? ` âš ï¸` : '';
                    
                    options += `<option value="${modelKey}" data-model='${JSON.stringify(model)}'>
                        ${costIcon} ${timeIcon} ${model.name}${warningText}
                    </option>`;
                });
                
                $('#aiModel').html(options).prop('disabled', false);
                $('#modelInfo').text('é€‰æ‹©å…·ä½“çš„AIæ¨¡å‹');
            } else {
                $('#aiModel').html('<option value="">åŠ è½½å¤±è´¥</option>');
                $('#modelInfo').text('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
                showAlert('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥: ' + response.message, 'error');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error loading models:', error);
            $('#aiModel').html('<option value="">åŠ è½½å¤±è´¥</option>');
            $('#modelInfo').text('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥');
            showAlert('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥', 'error');
        }
    });
}

// æ¨¡å‹é€‰æ‹©å˜åŒ–å¤„ç†
function onModelChange() {
    const modelKey = $('#aiModel').val();
    const modelData = $('#aiModel option:selected').data('model');
    
    if (!modelKey || !modelData) {
        $('#previewModelBtn').prop('disabled', true);
        $('#modelInfo').text('é€‰æ‹©å…·ä½“çš„AIæ¨¡å‹');
        return;
    }
    
    $('#previewModelBtn').prop('disabled', false);
    
    // æ›´æ–°æ¨¡å‹ä¿¡æ¯æ˜¾ç¤º
    let infoText = `${modelData.description}`;
    if (modelData.warning) {
        infoText += ` | âš ï¸ ${modelData.warning}`;
    }
    $('#modelInfo').text(infoText);
}

// é¢„è§ˆé€‰ä¸­çš„æ¨¡å‹
function previewSelectedModel() {
    const modelKey = $('#aiModel').val();
    const modelData = $('#aiModel option:selected').data('model');
    
    if (!modelKey || !modelData) {
        showAlert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªæ¨¡å‹', 'warning');
        return;
    }
    
    // åˆ›å»ºæ¨¡å‹é¢„è§ˆå¼¹çª—
    const modalHtml = `
        <div class="modal fade" id="modelPreviewModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">
                            <i class="fas fa-robot me-2"></i>æ¨¡å‹è¯¦æƒ…
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-info-circle me-2"></i>åŸºæœ¬ä¿¡æ¯</h6>
                                <table class="table table-sm">
                                    <tr><td><strong>æ¨¡å‹åç§°:</strong></td><td>${modelData.name}</td></tr>
                                    <tr><td><strong>æ¨¡å‹ID:</strong></td><td>${modelKey}</td></tr>
                                    <tr><td><strong>æœ€å¤§Token:</strong></td><td>${modelData.max_tokens.toLocaleString()}</td></tr>
                                    <tr><td><strong>æˆæœ¬ç­‰çº§:</strong></td><td>${getCostText(modelData.cost_level)}</td></tr>
                                    <tr><td><strong>å“åº”æ—¶é—´:</strong></td><td>${getTimeText(modelData.response_time)}</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-star me-2"></i>åŠŸèƒ½ç‰¹æ€§</h6>
                                <div class="d-flex flex-wrap gap-1">
                                    ${modelData.features.map(feature => 
                                        `<span class="badge bg-primary">${feature}</span>`
                                    ).join('')}
                                </div>
                                
                                ${modelData.warning ? `
                                    <div class="alert alert-warning mt-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>æ³¨æ„äº‹é¡¹:</strong> ${modelData.warning}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <h6><i class="fas fa-align-left me-2"></i>æ¨¡å‹æè¿°</h6>
                            <p class="text-muted">${modelData.description}</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>å…³é—­
                        </button>
                        <button type="button" class="btn btn-primary" onclick="useThisModel('${modelKey}')">
                            <i class="fas fa-check me-2"></i>ä½¿ç”¨æ­¤æ¨¡å‹
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // ç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
    $('#modelPreviewModal').remove();
    
    // æ·»åŠ æ–°å¼¹çª—
    $('body').append(modalHtml);
    
    // æ˜¾ç¤ºå¼¹çª—
    const modal = new bootstrap.Modal(document.getElementById('modelPreviewModal'));
    modal.show();
}

// ä½¿ç”¨é€‰ä¸­çš„æ¨¡å‹
function useThisModel(modelKey) {
    $('#aiModel').val(modelKey);
    $('#modelPreviewModal').modal('hide');
    onModelChange(); // æ›´æ–°æ˜¾ç¤ºä¿¡æ¯
    showAlert('å·²é€‰æ‹©è¯¥æ¨¡å‹', 'success');
}

// è·å–æˆæœ¬å›¾æ ‡
function getCostIcon(costLevel) {
    const icons = {
        'low': 'ğŸ’°',
        'medium': 'ğŸ’¸',
        'high': 'ğŸ’',
        'very_high': 'ğŸ’ğŸ’'
    };
    return icons[costLevel] || 'ğŸ’°';
}

// è·å–æ—¶é—´å›¾æ ‡
function getTimeIcon(timeLevel) {
    const icons = {
        'fast': 'âš¡',
        'medium': 'ğŸ•',
        'slow': 'ğŸŒ',
        'very_slow': 'ğŸŒğŸŒ'
    };
    return icons[timeLevel] || 'ğŸ•';
}

// è·å–æˆæœ¬æ–‡æœ¬
function getCostText(costLevel) {
    const texts = {
        'low': 'ä½',
        'medium': 'ä¸­ç­‰',
        'high': 'é«˜',
        'very_high': 'å¾ˆé«˜'
    };
    return texts[costLevel] || 'æœªçŸ¥';
}

// è·å–æ—¶é—´æ–‡æœ¬
function getTimeText(timeLevel) {
    const texts = {
        'fast': 'å¿«é€Ÿ',
        'medium': 'ä¸­ç­‰',
        'slow': 'è¾ƒæ…¢',
        'very_slow': 'å¾ˆæ…¢'
    };
    return texts[timeLevel] || 'æœªçŸ¥';
}

</script>
{% endblock %}
