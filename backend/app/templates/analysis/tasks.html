{% extends "base.html" %}

{% block title %}任务管理 - 智策股析{% endblock %}

{% block extra_css %}
<style>
/* 时间线样式 */
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #007bff, #28a745, #ffc107, #dc3545, #6c757d);
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #fff;
    box-shadow: 0 0 0 2px #dee2e6;
}

.timeline-content {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 15px;
    border-left: 3px solid #dee2e6;
    transition: all 0.3s ease;
}

.timeline-content:hover {
    background: #e9ecef;
    transform: translateX(5px);
}

.timeline-title {
    margin: 0 0 5px 0;
    font-size: 14px;
    font-weight: 600;
    color: #495057;
}

.timeline-text {
    margin: 0;
    font-size: 13px;
    line-height: 1.4;
}

/* 任务详情弹窗样式优化 */
#taskDetailModal .modal-dialog {
    max-width: 900px;
}

#taskDetailModal .modal-body {
    max-height: 70vh;
    overflow-y: auto;
}

/* 股票详情表格样式 */
.table-sm th,
.table-sm td {
    padding: 0.5rem;
    font-size: 0.875rem;
}

/* 响应式优化 */
@media (max-width: 768px) {
    .timeline {
        padding-left: 20px;
    }
    
    .timeline::before {
        left: 10px;
    }
    
    .timeline-marker {
        left: -17px;
        width: 10px;
        height: 10px;
    }
    
    .timeline-content {
        padding: 10px;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1 class="gradient-text mb-4">
                <i class="fas fa-tasks me-2"></i>任务管理
            </h1>
            <p class="text-muted mb-4">查看和管理您的批量分析任务</p>
        </div>
    </div>

    <!-- 任务列表 -->
    <div class="row">
        <div class="col-12">
            <div class="card glass-effect">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>任务列表
                    </h5>
                </div>
                <div class="card-body">
                    {% if tasks and tasks|length > 0 %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th style="min-width: 200px;">任务ID</th>
                                        {% if user_context and user_context.is_admin %}
                                        <th>创建用户</th>
                                        {% endif %}
                                        <th>分析类型</th>
                                        <th>股票数量</th>
                                        <th>状态</th>
                                        <th>进度</th>
                                        <th>重试次数</th>
                                        <th>创建时间</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for task in tasks %}
                                    <tr>
                                        <td>
                                            <code class="text-primary" 
                                                  title="{{ task.task_id }}" 
                                                  data-bs-toggle="tooltip" 
                                                  data-bs-placement="top">
                                                {{ task.task_id[:20] }}{% if task.task_id|length > 20 %}...{% endif %}
                                            </code>
                                        </td>
                                        {% if user_context and user_context.is_admin %}
                                        <td>
                                            {% if task.user_id %}
                                                <span class="badge bg-info">用户ID: {{ task.user_id }}</span>
                                                {% if task.user_email %}
                                                    <br><small class="text-muted">{{ task.user_email }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        {% endif %}
                                        <td>
                                            {% if task.analysis_type == 'fundamental' %}
                                                <span class="badge bg-info">基本面分析</span>
                                            {% elif task.analysis_type == 'technical' %}
                                                <span class="badge bg-warning">技术面分析</span>
                                            {% else %}
                                                <span class="badge bg-secondary">综合分析</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ task.total_count }} 支</td>
                                        <td>
                                            {% if task.status == 'pending' %}
                                                <span class="badge bg-secondary">等待中</span>
                                            {% elif task.status == 'running' %}
                                                <span class="badge bg-primary">进行中</span>
                                            {% elif task.status == 'paused' %}
                                                <span class="badge bg-warning">已暂停</span>
                                            {% elif task.status == 'stopped' %}
                                                <span class="badge bg-secondary">已停止</span>
                                            {% elif task.status == 'completed' %}
                                                <span class="badge bg-success">已完成</span>
                                            {% elif task.status == 'failed' %}
                                                <span class="badge bg-danger">失败</span>
                                            {% endif %}
                                            {% if task.get('retry_count') and task.get('retry_count') > 0 %}
                                                <br><small class="text-warning">重试 {{ task.get('retry_count') }} 次</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if task.status == 'running' %}
                                                <div class="progress" style="height: 20px;">
                                                    <div class="progress-bar" role="progressbar" 
                                                         style="width: {{ task.progress|default(0) }}%">
                                                        {{ task.progress|default(0)|round(1) }}%
                                                    </div>
                                                </div>
                                            {% elif task.status == 'completed' %}
                                                <span class="text-success">100%</span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if task.get('retry_count') and task.get('retry_count') > 0 %}
                                                <span class="badge bg-warning">{{ task.get('retry_count') }}</span>
                                            {% else %}
                                                <span class="text-muted">0</span>
                                            {% endif %}
                                        </td>
                                        <td><span class="task-time" data-time="{{ task.created_at }}"></span></td>
                                        <td>
                                            <div class="task-actions">
                                                <button class="btn btn-outline-info btn-sm view-task-btn" 
                                                        data-task-id="{{ task.task_id }}"
                                                        title="查看任务详情"
                                                        data-bs-toggle="tooltip">
                                                    <i class="fas fa-info-circle"></i>详情
                                                </button>
                                                {% if task.status == 'failed' %}
                                                    <button class="btn btn-outline-warning btn-sm retry-task-btn" 
                                                            data-task-id="{{ task.task_id }}">
                                                        <i class="fas fa-redo"></i>重试
                                                    </button>
                                                {% endif %}
                                                {% if task.status in ['pending', 'running'] %}
                                                    <button class="btn btn-outline-warning btn-sm pause-task-btn" 
                                                            data-task-id="{{ task.task_id }}"
                                                            data-task-name="{{ task.task_id[:20] }}{% if task.task_id|length > 20 %}...{% endif %}"
                                                            title="暂停任务"
                                                            data-bs-toggle="tooltip">
                                                        <i class="fas fa-pause"></i>暂停
                                                    </button>
                                                {% elif task.status == 'paused' %}
                                                    <button class="btn btn-outline-success btn-sm resume-task-btn" 
                                                            data-task-id="{{ task.task_id }}"
                                                            data-task-name="{{ task.task_id[:20] }}{% if task.task_id|length > 20 %}...{% endif %}"
                                                            title="恢复任务"
                                                            data-bs-toggle="tooltip">
                                                        <i class="fas fa-play"></i>恢复
                                                    </button>
                                                {% endif %}
                                                {% if task.status in ['completed', 'failed', 'paused'] %}
                                                    <button class="btn btn-outline-danger btn-sm delete-task-btn" 
                                                            data-task-id="{{ task.task_id }}"
                                                            data-task-name="{{ task.task_id[:20] }}{% if task.task_id|length > 20 %}...{% endif %}">
                                                        <i class="fas fa-trash"></i>删除
                                                    </button>
                                                {% endif %}
                                                {% if task.status == 'completed' %}
                                                    <a href="/reports/" class="btn btn-outline-success btn-sm">
                                                        <i class="fas fa-chart-line"></i>报告
                                                    </a>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">暂无任务</h5>
                            <p class="text-muted">您还没有创建任何批量分析任务</p>
                            <a href="/analysis/" class="btn btn-primary">
                                <i class="fas fa-plus me-2"></i>创建分析任务
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 任务详情模态框 -->
<div class="modal fade" id="taskDetailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-effect">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-info-circle me-2"></i>任务详情
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="taskDetailContent">
                <!-- 任务详情内容 -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<!-- 暂停任务确认弹窗 -->
<div class="modal fade" id="pauseTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0">
                <h5 class="modal-title text-warning">
                    <i class="fas fa-pause-circle me-2"></i>确认暂停任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                </div>
                <h6 class="mb-3">您确定要暂停此任务吗？</h6>
                <p class="text-muted mb-0">
                    任务ID: <code id="pauseTaskId" class="text-primary"></code>
                </p>
                <div class="alert alert-warning mt-3 mb-0" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    暂停后任务将停止执行，但不会删除相关数据
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-warning" id="confirmPauseTask">
                    <i class="fas fa-pause me-1"></i>确认暂停
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 删除任务确认弹窗 -->
<div class="modal fade" id="deleteTaskModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0">
                <h5 class="modal-title text-danger">
                    <i class="fas fa-trash-alt me-2"></i>确认删除任务
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-4">
                <div class="mb-3">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger"></i>
                </div>
                <h6 class="mb-3">您确定要删除此任务吗？</h6>
                <p class="text-muted mb-0">
                    任务ID: <code id="deleteTaskId" class="text-primary"></code>
                </p>
                <div class="alert alert-danger mt-3 mb-0" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>警告：</strong>删除后任务及相关数据将无法恢复！
                </div>
            </div>
            <div class="modal-footer border-0 justify-content-center">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>取消
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteTask">
                    <i class="fas fa-trash me-1"></i>确认删除
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// 确保jQuery加载完成后再执行
// 等待jQuery加载完成
function waitForJQuery() {
    if (typeof $ !== 'undefined' && $.fn && $.fn.jquery) {
        console.log('jQuery已加载，版本:', $.fn.jquery);
        initTaskManagement();
        initTooltips();
    } else {
        console.log('等待jQuery加载...');
        setTimeout(waitForJQuery, 100);
    }
}

// 页面加载完成后等待jQuery
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM加载完成，开始等待jQuery...');
    waitForJQuery();
});

function initTaskManagement() {
    console.log('页面加载完成');
    console.log('jQuery版本:', $.fn.jquery);
    console.log('找到的查看按钮数量:', $('.view-task-btn').length);
    
    // 格式化表格中的时间显示
    formatTableTimes();
    
    // 查看任务详情 - 使用事件委托
    $(document).on('click', '.view-task-btn', function() {
        console.log('查看按钮被点击');
        const taskId = $(this).data('task-id');
        console.log('任务ID:', taskId);
        loadTaskDetail(taskId);
    });
    
    // 重试任务 - 使用事件委托
    $(document).on('click', '.retry-task-btn', function() {
        console.log('重试按钮被点击');
        const taskId = $(this).data('task-id');
        console.log('重试任务ID:', taskId);
        
        showConfirmModal(
            '确认重试任务',
            '您确定要重试这个任务吗？\n\n任务ID: ' + taskId + '\n\n重试将重新执行所有失败的分析。',
            function() {
                retryTask(taskId);
            }
        );
    });
    
    // 暂停任务按钮点击事件
    $(document).on('click', '.pause-task-btn', function() {
        console.log('暂停按钮被点击');
        const taskId = $(this).data('task-id');
        const taskName = $(this).data('task-name');
        
        console.log('任务ID:', taskId);
        console.log('任务名称:', taskName);
        console.log('弹窗元素:', $('#pauseTaskModal'));
        
        currentPauseTaskId = taskId;
        $('#pauseTaskId').text(taskName);
        $('#pauseTaskModal').modal('show');
        
        console.log('弹窗已显示');
    });
    
    // 恢复任务按钮点击事件
    $(document).on('click', '.resume-task-btn', function() {
        console.log('恢复按钮被点击');
        const taskId = $(this).data('task-id');
        const taskName = $(this).data('task-name');
        
        showConfirmModal(
            '确认恢复任务',
            '您确定要恢复这个任务吗？\n\n任务ID: ' + taskName + '\n\n恢复后任务将从暂停点继续执行。',
            function() {
                resumeTask(taskId);
            }
        );
    });
    
    // 删除任务按钮点击事件
    $(document).on('click', '.delete-task-btn', function() {
        console.log('删除按钮被点击');
        const taskId = $(this).data('task-id');
        const taskName = $(this).data('task-name');
        
        currentDeleteTaskId = taskId;
        $('#deleteTaskId').text(taskName);
        $('#deleteTaskModal').modal('show');
    });
    
    // 测试按钮点击
    $('.view-task-btn').each(function() {
        console.log('按钮:', $(this).data('task-id'));
    });
    
    // 自动刷新进行中的任务
    setInterval(function() {
        refreshRunningTasks();
    }, 10000); // 每10秒刷新一次
    
    // 确认暂停任务
    $('#confirmPauseTask').click(function() {
        console.log('确认暂停按钮被点击');
        if (!currentPauseTaskId) {
            console.log('没有当前暂停任务ID');
            return;
        }
        
        const $btn = $(this);
        const originalText = $btn.html();
        
        console.log('开始暂停任务:', currentPauseTaskId);
        
        // 显示加载状态
        $btn.html('<i class="fas fa-spinner fa-spin me-1"></i>暂停中...');
        $btn.prop('disabled', true);
        
        // 发送暂停请求
        $.ajax({
            url: '/api/analysis/task-pause/' + currentPauseTaskId,
            type: 'POST',
            success: function(response) {
                console.log('暂停响应:', response);
                if (response.success) {
                    showToast('success', '任务已暂停');
                    $('#pauseTaskModal').modal('hide');
                    // 刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('error', response.message || '暂停任务失败');
                }
            },
            error: function(xhr, status, error) {
                console.error('暂停任务失败:', xhr, status, error);
                showToast('error', '暂停任务失败: ' + error);
            },
            complete: function() {
                // 恢复按钮状态
                $btn.html(originalText);
                $btn.prop('disabled', false);
                currentPauseTaskId = null;
            }
        });
    });
    
    // 确认删除任务
    $('#confirmDeleteTask').click(function() {
        console.log('确认删除按钮被点击');
        if (!currentDeleteTaskId) {
            console.log('没有当前删除任务ID');
            return;
        }
        
        const $btn = $(this);
        const originalText = $btn.html();
        
        console.log('开始删除任务:', currentDeleteTaskId);
        
        // 显示加载状态
        $btn.html('<i class="fas fa-spinner fa-spin me-1"></i>删除中...');
        $btn.prop('disabled', true);
        
        // 发送删除请求
        $.ajax({
            url: '/api/analysis/task-delete/' + currentDeleteTaskId,
            type: 'DELETE',
            success: function(response) {
                console.log('删除响应:', response);
                if (response.success) {
                    showToast('success', '任务已删除');
                    $('#deleteTaskModal').modal('hide');
                    // 刷新页面
                    setTimeout(function() {
                        location.reload();
                    }, 1000);
                } else {
                    showToast('error', response.message || '删除任务失败');
                }
            },
            error: function(xhr, status, error) {
                console.error('删除任务失败:', xhr, status, error);
                showToast('error', '删除任务失败: ' + error);
            },
            complete: function() {
                // 恢复按钮状态
                $btn.html(originalText);
                $btn.prop('disabled', false);
                currentDeleteTaskId = null;
            }
        });
    });
    
    // 弹窗关闭时重置变量
    $('#pauseTaskModal').on('hidden.bs.modal', function() {
        currentPauseTaskId = null;
    });
    
    $('#deleteTaskModal').on('hidden.bs.modal', function() {
        currentDeleteTaskId = null;
    });
}

function loadTaskDetail(taskId) {
    console.log('开始加载任务详情:', taskId);
    const url = '/api/analysis/task-status/' + taskId;
    console.log('请求URL:', url);
    
    $.get(url, function(response) {
        console.log('API响应:', response);
        if (response.success) {
            const task = response.task;
            let content = '<div class="row">';
            
            // 基本信息
            content += '<div class="col-md-6">';
            content += '<h6><i class="fas fa-info-circle me-2"></i>基本信息</h6>';
            content += '<ul class="list-unstyled">';
            content += '<li><strong>任务ID:</strong> <code class="text-primary">' + task.task_id + '</code></li>';
            content += '<li><strong>任务类型:</strong> ' + (task.task_id.startsWith('single_') ? '单个分析' : '批量分析') + '</li>';
            content += '<li><strong>分析类型:</strong> ' + getAnalysisTypeName(task.analysis_type) + '</li>';
            content += '<li><strong>AI模型:</strong> <span class="badge bg-info">' + task.ai_provider + '</span></li>';
            content += '<li><strong>状态:</strong> ' + getStatusBadge(task.status) + '</li>';
            if (task.retry_count) {
                content += '<li><strong>重试次数:</strong> <span class="badge bg-warning">' + task.retry_count + '</span></li>';
            }
            content += '</ul>';
            content += '</div>';
            
            // 金币消耗信息
            content += '<div class="col-md-6">';
            content += '<h6><i class="fas fa-coins me-2"></i>金币消耗</h6>';
            content += '<ul class="list-unstyled">';
            const coinCost = task.total_count * 10; // 每个股票消耗10金币
            content += '<li><strong>消耗金币:</strong> <span class="text-warning">' + coinCost + '金币</span></li>';
            content += '<li><strong>单价:</strong> 10金币/股票</li>';
            content += '<li><strong>说明:</strong> 每次分析消耗10金币</li>';
            content += '</ul>';
            content += '</div>';
            
            // 进度信息
            content += '<div class="col-md-6">';
            content += '<h6><i class="fas fa-chart-line me-2"></i>进度信息</h6>';
            content += '<ul class="list-unstyled">';
            content += '<li><strong>总股票数:</strong> ' + task.total_count + '</li>';
            content += '<li><strong>已完成:</strong> <span class="text-success">' + task.completed_count + '</span></li>';
            content += '<li><strong>失败:</strong> <span class="text-danger">' + task.failed_count + '</span></li>';
            content += '<li><strong>进度:</strong> ' + (task.progress ? task.progress.toFixed(1) + '%' : '-') + '</li>';
            content += '</ul>';
            content += '</div>';
            content += '</div>';
            
            // 时间线信息
            content += '<div class="row mt-4">';
            content += '<div class="col-12">';
            content += '<h6><i class="fas fa-clock me-2"></i>操作时间线</h6>';
            content += '<div class="timeline">';
            
            // 创建时间
            if (task.created_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-primary"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务创建</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.created_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            // 开始时间
            if (task.started_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-success"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">开始执行</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.started_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            // 暂停时间
            if (task.paused_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-warning"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务暂停</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.paused_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            // 恢复时间
            if (task.resumed_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-info"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务恢复</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.resumed_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            // 完成时间
            if (task.completed_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-success"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务完成</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.completed_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            // 失败时间
            if (task.failed_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-danger"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务失败</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.failed_at) + '</p>';
                if (task.error) {
                    content += '<p class="timeline-text text-danger"><small>' + task.error + '</small></p>';
                }
                content += '</div>';
                content += '</div>';
            }
            
            // 停止时间
            if (task.stopped_at) {
                content += '<div class="timeline-item">';
                content += '<div class="timeline-marker bg-secondary"></div>';
                content += '<div class="timeline-content">';
                content += '<h6 class="timeline-title">任务停止</h6>';
                content += '<p class="timeline-text text-muted">' + formatDateTime(task.stopped_at) + '</p>';
                content += '</div>';
                content += '</div>';
            }
            
            content += '</div>';
            content += '</div>';
            content += '</div>';
            
            // 股票详情（如果是批量任务）
            if (task.task_id.startsWith('batch_') && task.stocks && task.stocks.length > 0) {
                content += '<div class="row mt-4">';
                content += '<div class="col-12">';
                content += '<h6><i class="fas fa-list me-2"></i>股票详情</h6>';
                content += '<div class="table-responsive">';
                content += '<table class="table table-sm table-hover">';
                content += '<thead class="table-light">';
                content += '<tr><th>股票代码</th><th>股票名称</th><th>状态</th><th>重试次数</th><th>完成时间</th></tr>';
                content += '</thead>';
                content += '<tbody>';
                
                task.stocks.forEach(function(stock) {
                    const stockStatus = task.stock_status && task.stock_status[stock.code] ? task.stock_status[stock.code] : {};
                    content += '<tr>';
                    content += '<td><strong>' + stock.code + '</strong></td>';
                    content += '<td>' + (stock.name || '-') + '</td>';
                    content += '<td>' + getStatusBadge(stockStatus.status || 'pending') + '</td>';
                    content += '<td>' + (stockStatus.retry_count || 0) + '</td>';
                    content += '<td>' + (stockStatus.completed_at ? formatDateTime(stockStatus.completed_at) : '-') + '</td>';
                    content += '</tr>';
                });
                
                content += '</tbody>';
                content += '</table>';
                content += '</div>';
                content += '</div>';
                content += '</div>';
            }
            
            // 更新弹窗标题
            $('#taskDetailModal .modal-title').html('<i class="fas fa-info-circle me-2"></i>任务详情 - ' + task.task_id);
            
            $('#taskDetailContent').html(content);
            $('#taskDetailModal').modal('show');
        } else {
            console.error('API返回错误:', response.message);
            showToast('error', response.message || '获取任务详情失败');
        }
    }).fail(function(xhr, status, error) {
        console.error('API请求失败:', xhr, status, error);
        showToast('error', '获取任务详情失败: ' + error);
    });
}

function getAnalysisTypeName(type) {
    const types = {
        'default': '综合分析',
        'fundamental': '基本面分析',
        'technical': '技术面分析'
    };
    return types[type] || type;
}

function getStatusBadge(status) {
    const badges = {
        'pending': '<span class="badge bg-secondary">等待中</span>',
        'running': '<span class="badge bg-primary">进行中</span>',
        'paused': '<span class="badge bg-warning">已暂停</span>',
        'completed': '<span class="badge bg-success">已完成</span>',
        'failed': '<span class="badge bg-danger">失败</span>',
        'stopped': '<span class="badge bg-secondary">已停止</span>'
    };
    return badges[status] || status;
}

function formatDateTime(dateTimeStr) {
    if (!dateTimeStr) return '-';
    try {
        let date;
        
        // 检查时间字符串格式
        if (dateTimeStr.includes('Z')) {
            // UTC时间格式，直接解析
            date = new Date(dateTimeStr);
        } else if (dateTimeStr.includes('+') || dateTimeStr.includes('-', 10)) {
            // 已有时区信息，直接解析
            date = new Date(dateTimeStr);
        } else {
            // 没有时区信息的ISO格式，假设为UTC时间，添加Z后缀
            date = new Date(dateTimeStr + 'Z');
        }
        
        // 直接使用浏览器的本地时区格式化，不要手动添加时区偏移
        return date.toLocaleString('zh-CN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    } catch (e) {
        console.error('时间格式化错误:', e, '原始时间:', dateTimeStr);
        return dateTimeStr;
    }
}

// 格式化表格中的时间显示
function formatTableTimes() {
    $('.task-time').each(function() {
        const timeStr = $(this).data('time');
        if (timeStr) {
            const formatted = formatDateTime(timeStr);
            $(this).text(formatted);
        }
    });
}

function generateStockStatusRows(task) {
    let rows = '';
    
    // 单个分析任务
    if (task.task_id.startsWith('single_')) {
        const stockCode = task.stock_code || '未知';
        const stockName = task.stock_name || '';
        const status = task.status || 'pending';
        const retryCount = task.retry_count || 0;
        
        rows += '<tr class="table-info">';
        rows += '<td><strong>' + stockCode + '</strong></td>';
        rows += '<td>' + stockName + '</td>';
        rows += '<td>' + getStatusBadge(status) + '</td>';
        rows += '<td>' + (retryCount > 0 ? '<span class="badge bg-warning">' + retryCount + '</span>' : '0') + '</td>';
        rows += '</tr>';
    } 
    // 批量分析任务
    else if (task.stocks && task.stocks.length > 0) {
        task.stocks.forEach(function(stock) {
            rows += '<tr class="table-info">';
            rows += '<td><strong>' + stock.code + '</strong></td>';
            rows += '<td>' + stock.name + '</td>';
            rows += '<td>' + getStatusBadge('completed') + '</td>';
            rows += '<td>0</td>';
            rows += '</tr>';
        });
    }
    
    return rows;
}

function showToast(type, message) {
    // 简单的toast提示
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const toastHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    $('body').append(toastHtml);
    
    // 3秒后自动消失
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 3000);
}

function retryTask(taskId) {
    console.log('开始重试任务:', taskId);
    
    // 显示加载状态
    const retryBtn = $(`.retry-task-btn[data-task-id="${taskId}"]`);
    const originalText = retryBtn.html();
    retryBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>重试中...').prop('disabled', true);
    
    $.ajax({
        url: `/api/analysis/retry-task/${taskId}`,
        method: 'POST',
        success: function(response) {
            console.log('重试任务响应:', response);
            if (response.success) {
                showToast('success', '任务重试已启动');
                // 刷新页面以显示最新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            } else {
                showToast('error', response.message || '重试任务失败');
                retryBtn.html(originalText).prop('disabled', false);
            }
        },
        error: function(xhr, status, error) {
            console.error('重试任务请求失败:', xhr, status, error);
            showToast('error', '重试任务失败: ' + error);
            retryBtn.html(originalText).prop('disabled', false);
        }
    });
}

function resumeTask(taskId) {
    console.log('开始恢复任务:', taskId);
    
    // 显示加载状态
    const resumeBtn = $(`.resume-task-btn[data-task-id="${taskId}"]`);
    const originalText = resumeBtn.html();
    resumeBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>恢复中...').prop('disabled', true);
    
    $.ajax({
        url: `/api/analysis/task-resume/${taskId}`,
        method: 'POST',
        success: function(response) {
            console.log('恢复任务响应:', response);
            if (response.success) {
                showToast('success', '任务已恢复');
                // 刷新页面以显示最新状态
                setTimeout(function() {
                    location.reload();
                }, 2000);
            } else {
                showToast('error', response.message || '恢复任务失败');
                resumeBtn.html(originalText).prop('disabled', false);
            }
        },
        error: function(xhr, status, error) {
            console.error('恢复任务请求失败:', xhr, status, error);
            showToast('error', '恢复任务失败: ' + error);
            resumeBtn.html(originalText).prop('disabled', false);
        }
    });
}

function refreshRunningTasks() {
    // 刷新进行中的任务状态
    $('.view-task-btn').each(function() {
        const taskId = $(this).data('task-id');
        const row = $(this).closest('tr');
        const statusCell = row.find('td:nth-child(4)'); // 状态列
        const retryCell = row.find('td:nth-child(6)'); // 重试次数列
        
        $.get(`/api/analysis/task-status/${taskId}`, function(response) {
            if (response.success) {
                const task = response.task;
                statusCell.html(getStatusBadge(task.status));
                
                // 更新重试次数
                if (task.retry_count && task.retry_count > 0) {
                    retryCell.html('<span class="badge bg-warning">' + task.retry_count + '</span>');
                } else {
                    retryCell.html('<span class="text-muted">0</span>');
                }
                
                // 如果任务完成，更新进度
                if (task.status === 'completed') {
                    const progressCell = row.find('td:nth-child(5)'); // 进度列
                    progressCell.text('100%');
                }
                
                // 如果任务失败，显示重试按钮
                if (task.status === 'failed') {
                    const actionCell = row.find('td:nth-child(8)'); // 操作列
                    if (!actionCell.find('.retry-task-btn').length) {
                        actionCell.append(`
                            <button class="btn btn-sm btn-outline-warning retry-task-btn ms-1" 
                                    data-task-id="${taskId}">
                                <i class="fas fa-redo me-1"></i>重试
                            </button>
                        `);
                    }
                }
            }
        });
    });
}

// 暂停任务相关变量
let currentPauseTaskId = null;
let currentDeleteTaskId = null;

// 初始化Bootstrap tooltips - 移到waitForJQuery中
function initTooltips() {
    // 初始化所有tooltip
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
    
    // 当动态添加内容时，重新初始化tooltip
    $(document).on('DOMNodeInserted', function() {
        var newTooltips = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]:not([data-bs-original-title])'));
        newTooltips.forEach(function(tooltipEl) {
            new bootstrap.Tooltip(tooltipEl);
        });
    });
}

</script>
{% endblock %}
