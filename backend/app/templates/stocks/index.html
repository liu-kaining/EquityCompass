{% extends "base.html" %}

{% block title %}è‚¡ç¥¨æ±  - æ™ºç­–è‚¡æ{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="gradient-text mb-4">
            <i class="fas fa-chart-bar me-3"></i>è‚¡ç¥¨æ± 
        </h1>
        <p class="text-muted mb-4">æµè§ˆå’Œæœç´¢ç¾è‚¡ã€æ¸¯è‚¡æ± ä¸­çš„è‚¡ç¥¨</p>
    </div>
</div>

<!-- ç»Ÿè®¡ä¿¡æ¯ -->
{% if watchlist_summary %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-primary">{{ watchlist_summary.count }}</h4>
                        <small class="text-muted">å·²å…³æ³¨</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">{{ watchlist_summary.remaining_slots }}</h4>
                        <small class="text-muted">å‰©ä½™é¢åº¦</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">{{ watchlist_summary.max_count }}</h4>
                        <small class="text-muted">æœ€å¤§å…³æ³¨æ•°</small>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('stocks.watchlist') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-bookmark me-1"></i>æŸ¥çœ‹å…³æ³¨åˆ—è¡¨
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- æœç´¢æ¡† -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <form method="GET" action="{{ url_for('stocks.index') }}" id="searchForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" 
                                       placeholder="æœç´¢è‚¡ç¥¨ä»£ç æˆ–å…¬å¸åç§°..." 
                                       name="search" 
                                       value="{{ pagination.search or '' }}"
                                       id="stockSearch">
                                {% if pagination.search or pagination.market %}
                                <button type="button" class="btn btn-outline-secondary" id="clearSearchBtn" title="æ¸…ç©ºæœç´¢">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="custom-select market-select">
                                <select class="form-select" name="market" id="marketFilter">
                                    <option value="">å…¨éƒ¨å¸‚åœº</option>
                                    <option value="US" {% if pagination.market == 'US' %}selected{% endif %}>ğŸ‡ºğŸ‡¸ ç¾è‚¡</option>
                                    <option value="HK" {% if pagination.market == 'HK' %}selected{% endif %}>ğŸ‡­ğŸ‡° æ¸¯è‚¡</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>æœç´¢
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ“ä½œæŒ‰é’®å’Œåˆ†é¡µä¿¡æ¯ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('stocks.add_custom') }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>æ·»åŠ è‡ªå®šä¹‰è‚¡ç¥¨
                </a>
            </div>
            <div class="text-center">
                <div class="pagination-info">
                    <i class="fas fa-chart-line me-2"></i>
                    å…±æ‰¾åˆ° <strong>{{ pagination.total }}</strong> æ”¯è‚¡ç¥¨
                    {% if pagination.pages > 1 %}
                        Â· ç¬¬ <strong>{{ pagination.page }}</strong> é¡µï¼Œå…± <strong>{{ pagination.pages }}</strong> é¡µ
                    {% endif %}
                </div>
            </div>
            <div>
                <span class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    æ¯é¡µæ˜¾ç¤º {{ pagination.per_page }} æ”¯
                </span>
            </div>
        </div>
    </div>
</div>

<!-- è‚¡ç¥¨åˆ—è¡¨ -->
<div class="row">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                {% if stocks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>è‚¡ç¥¨ä»£ç </th>
                                    <th>å…¬å¸åç§°</th>
                                    <th>å¸‚åœº</th>
                                    <th>è¡Œä¸š</th>
                                    <th>ç±»å‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('stocks.detail', code=stock.code) }}" 
                                           class="text-decoration-none">
                                            <code class="text-primary">{{ stock.code }}</code>
                                        </a>
                                    </td>
                                    <td>{{ stock.name }}</td>
                                    <td>
                                        {% if stock.market == 'US' %}
                                            <span class="badge bg-primary">ç¾è‚¡</span>
                                        {% else %}
                                            <span class="badge bg-success">æ¸¯è‚¡</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ stock.industry or 'æœªçŸ¥' }}</small>
                                    </td>
                                    <td>
                                        {% if stock.stock_type == 'BUILT_IN' %}
                                            <span class="badge bg-info">å†…ç½®</span>
                                        {% else %}
                                            <span class="badge bg-warning">è‡ªå®šä¹‰</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if stock.is_watching %}
                                            <button class="btn btn-sm btn-outline-danger watch-btn" 
                                                    data-stock-code="{{ stock.code }}"
                                                    data-action="remove">
                                                <i class="fas fa-bookmark me-1"></i>å–æ¶ˆå…³æ³¨
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-success watch-btn" 
                                                    data-stock-code="{{ stock.code }}"
                                                    data-action="add">
                                                <i class="fas fa-bookmark me-1"></i>å…³æ³¨
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- åˆ†é¡µ -->
                    {% if pagination.pages > 1 %}
                    <nav aria-label="è‚¡ç¥¨åˆ—è¡¨åˆ†é¡µ" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- ä¸Šä¸€é¡µ -->
                            {% if pagination.page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.page-1, market=pagination.market, search=pagination.search) }}" title="ä¸Šä¸€é¡µ">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                </li>
                            {% endif %}
                            
                            <!-- é¡µç  -->
                            {% set start_page = [1, pagination.page - 2] | max %}
                            {% set end_page = [pagination.pages, pagination.page + 2] | min %}
                            
                            {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=1, market=pagination.market, search=pagination.search) }}">1</a>
                                </li>
                                {% if start_page > 2 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endif %}
                            
                            {% for p in range(start_page, end_page + 1) %}
                                {% if p == pagination.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ p }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('stocks.index', page=p, market=pagination.market, search=pagination.search) }}">{{ p }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if end_page < pagination.pages %}
                                {% if end_page < pagination.pages - 1 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.pages, market=pagination.market, search=pagination.search) }}">{{ pagination.pages }}</a>
                                </li>
                            {% endif %}
                            
                            <!-- ä¸‹ä¸€é¡µ -->
                            {% if pagination.page < pagination.pages %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.page+1, market=pagination.market, search=pagination.search) }}" title="ä¸‹ä¸€é¡µ">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„è‚¡ç¥¨</h5>
                        <p class="text-muted">è¯·å°è¯•ä½¿ç”¨ä¸åŒçš„æœç´¢å…³é”®è¯æˆ–å¸‚åœºç­›é€‰</p>
                        <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                            <i class="fas fa-undo me-2"></i>è¿”å›å…¨éƒ¨è‚¡ç¥¨
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // å…³æ³¨/å–æ¶ˆå…³æ³¨åŠŸèƒ½
    $('.watch-btn').click(function() {
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const action = btn.data('action');
        const isAdding = action === 'add';
        
        // å¦‚æœæ˜¯å–æ¶ˆå…³æ³¨ï¼Œéœ€è¦ç¡®è®¤
        if (!isAdding) {
            confirmAction(
                'å–æ¶ˆå…³æ³¨',
                `ç¡®å®šè¦å–æ¶ˆå…³æ³¨ ${stockCode} å—ï¼Ÿ`,
                function() {
                    performWatchAction(btn, stockCode, action);
                }
            );
        } else {
            performWatchAction(btn, stockCode, action);
        }
    });
    
    // æ‰§è¡Œå…³æ³¨/å–æ¶ˆå…³æ³¨æ“ä½œ
    function performWatchAction(btn, stockCode, action) {
        const isAdding = action === 'add';
        
        // ç¦ç”¨æŒ‰é’®é˜²æ­¢é‡å¤ç‚¹å‡»
        btn.prop('disabled', true);
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>å¤„ç†ä¸­...');
        
        // å‘é€APIè¯·æ±‚
        $.ajax({
            url: `/api/stocks/watchlist/${action}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stock_code: stockCode }),
            success: function(response) {
                if (response.success) {
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    if (isAdding) {
                        btn.removeClass('btn-outline-success').addClass('btn-outline-danger');
                        btn.data('action', 'remove');
                        btn.html('<i class="fas fa-bookmark me-1"></i>å–æ¶ˆå…³æ³¨');
                    } else {
                        btn.removeClass('btn-outline-danger').addClass('btn-outline-success');
                        btn.data('action', 'add');
                        btn.html('<i class="fas fa-bookmark me-1"></i>å…³æ³¨');
                    }
                    
                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    showToast('success', response.message);
                    
                    // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                    updateWatchlistSummary();
                } else {
                    showToast('error', response.message || 'æ“ä½œå¤±è´¥');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
            },
            complete: function() {
                btn.prop('disabled', false);
            }
        });
    }
    
    // æœç´¢è¡¨å•æäº¤
    $('#searchForm').submit(function(e) {
        const searchValue = $('#stockSearch').val().trim();
        const marketValue = $('#marketFilter').val();
        
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºä¸”æ²¡æœ‰é€‰æ‹©å¸‚åœºï¼Œæ¸…é™¤æ‰€æœ‰å‚æ•°å¹¶è·³è½¬åˆ°åŸºç¡€é¡µé¢
        if (!searchValue && !marketValue) {
            e.preventDefault();
            window.location.href = "{{ url_for('stocks.index') }}";
            return false;
        }
        
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºä½†é€‰æ‹©äº†å¸‚åœºï¼Œæ¸…é™¤æœç´¢å‚æ•°
        if (!searchValue && marketValue) {
            $('#stockSearch').val('');
        }
    });
    
    // æ·»åŠ æ¸…ç©ºæœç´¢çš„åŠŸèƒ½
    $('#stockSearch').on('input', function() {
        const searchValue = $(this).val().trim();
        const marketValue = $('#marketFilter').val();
        
        // å¦‚æœæœç´¢æ¡†è¢«æ¸…ç©ºä¸”æ²¡æœ‰é€‰æ‹©å¸‚åœºï¼Œè‡ªåŠ¨è·³è½¬åˆ°åŸºç¡€é¡µé¢
        if (!searchValue && !marketValue) {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œé¿å…ç”¨æˆ·æ­£åœ¨è¾“å…¥æ—¶è·³è½¬
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(function() {
                window.location.href = "{{ url_for('stocks.index') }}";
            }, 1000);
        }
    });
    
    // å¸‚åœºç­›é€‰å˜åŒ–æ—¶ä¹Ÿå¤„ç†æœç´¢æ¡†
    $('#marketFilter').on('change', function() {
        const searchValue = $('#stockSearch').val().trim();
        const marketValue = $(this).val();
        
        // å¦‚æœæœç´¢æ¡†ä¸ºç©ºä¸”æ²¡æœ‰é€‰æ‹©å¸‚åœºï¼Œè·³è½¬åˆ°åŸºç¡€é¡µé¢
        if (!searchValue && !marketValue) {
            window.location.href = "{{ url_for('stocks.index') }}";
        }
    });

    // æ¸…ç©ºæœç´¢æŒ‰é’®ç‚¹å‡»äº‹ä»¶
    $('#clearSearchBtn').click(function() {
        $('#stockSearch').val('').trigger('input'); // æ¸…ç©ºè¾“å…¥æ¡†å¹¶è§¦å‘inputäº‹ä»¶
        $('#marketFilter').val('').trigger('change'); // æ¸…ç©ºå¸‚åœºç­›é€‰å¹¶è§¦å‘changeäº‹ä»¶
        $('#searchForm').submit(); // æäº¤è¡¨å•
    });
    
    // æ›´æ–°å…³æ³¨åˆ—è¡¨ç»Ÿè®¡ä¿¡æ¯
    function updateWatchlistSummary() {
        $.get('/api/stocks/watchlist', function(response) {
            if (response.success) {
                // è¿™é‡Œå¯ä»¥æ›´æ–°é¡µé¢ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯
                // æš‚æ—¶ç®€å•åˆ·æ–°é¡µé¢
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        });
    }
    
    // æ˜¾ç¤ºæ¶ˆæ¯æç¤º
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // è‡ªåŠ¨æ¶ˆå¤±
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
