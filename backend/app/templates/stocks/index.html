{% extends "base.html" %}

{% block title %}ËÇ°Á•®Ê±† - Êô∫Á≠ñËÇ°Êûê{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="gradient-text mb-4">
            <i class="fas fa-chart-bar me-3"></i>ËÇ°Á•®Ê±†
        </h1>
        <p class="text-muted mb-4">ÊµèËßàÂíåÊêúÁ¥¢ÁæéËÇ°„ÄÅÊ∏ØËÇ°Ê±†‰∏≠ÁöÑËÇ°Á•®</p>
    </div>
</div>

<!-- ÁªüËÆ°‰ø°ÊÅØ -->
{% if watchlist_summary %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <h4 class="text-primary">{{ watchlist_summary.count }}</h4>
                        <small class="text-muted">Â∑≤ÂÖ≥Ê≥®</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-success">{{ watchlist_summary.remaining_slots }}</h4>
                        <small class="text-muted">Ââ©‰ΩôÈ¢ùÂ∫¶</small>
                    </div>
                    <div class="col-md-3">
                        <h4 class="text-info">{{ watchlist_summary.max_count }}</h4>
                        <small class="text-muted">ÊúÄÂ§ßÂÖ≥Ê≥®Êï∞</small>
                    </div>
                    <div class="col-md-3">
                        <a href="{{ url_for('stocks.watchlist') }}" class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-bookmark me-1"></i>Êü•ÁúãÂÖ≥Ê≥®ÂàóË°®
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- ÊêúÁ¥¢Ê°Ü -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                <form method="GET" action="{{ url_for('stocks.index') }}" id="searchForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="input-group">
                                <input type="text" class="form-control" 
                                       placeholder="ÊêúÁ¥¢ËÇ°Á•®‰ª£Á†ÅÊàñÂÖ¨Âè∏ÂêçÁß∞..." 
                                       name="search" 
                                       value="{{ pagination.search or '' }}"
                                       id="stockSearch">
                                {% if pagination.search or pagination.market %}
                                <button type="button" class="btn btn-outline-secondary" id="clearSearchBtn" title="Ê∏ÖÁ©∫ÊêúÁ¥¢">
                                    <i class="fas fa-times"></i>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="custom-select market-select">
                                <select class="form-select" name="market" id="marketFilter">
                                    <option value="">ÂÖ®ÈÉ®Â∏ÇÂú∫</option>
                                    <option value="US" {% if pagination.market == 'US' %}selected{% endif %}>üá∫üá∏ ÁæéËÇ°</option>
                                    <option value="HK" {% if pagination.market == 'HK' %}selected{% endif %}>üá≠üá∞ Ê∏ØËÇ°</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-2"></i>ÊêúÁ¥¢
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Êìç‰ΩúÊåâÈíÆÂíåÂàÜÈ°µ‰ø°ÊÅØ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('stocks.add_custom') }}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>Ê∑ªÂä†Ëá™ÂÆö‰πâËÇ°Á•®
                </a>
            </div>
            <div class="text-center">
                <div class="pagination-info">
                    <i class="fas fa-chart-line me-2"></i>
                    ÂÖ±ÊâæÂà∞ <strong>{{ pagination.total }}</strong> ÊîØËÇ°Á•®
                    {% if pagination.pages > 1 %}
                        ¬∑ Á¨¨ <strong>{{ pagination.page }}</strong> È°µÔºåÂÖ± <strong>{{ pagination.pages }}</strong> È°µ
                    {% endif %}
                </div>
            </div>
            <div>
                <span class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    ÊØèÈ°µÊòæÁ§∫ {{ pagination.per_page }} ÊîØ
                </span>
            </div>
        </div>
    </div>
</div>

<!-- ËÇ°Á•®ÂàóË°® -->
<div class="row">
    <div class="col-12">
        <div class="card glass-effect">
            <div class="card-body">
                {% if stocks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>ËÇ°Á•®‰ª£Á†Å</th>
                                    <th>ÂÖ¨Âè∏ÂêçÁß∞</th>
                                    <th>Â∏ÇÂú∫</th>
                                    <th>Ë°å‰∏ö</th>
                                    <th>Á±ªÂûã</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stock in stocks %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('stocks.detail', code=stock.code) }}" 
                                           class="text-decoration-none">
                                            <code class="text-primary">{{ stock.code }}</code>
                                        </a>
                                    </td>
                                    <td>{{ stock.name }}</td>
                                    <td>
                                        {% if stock.market == 'US' %}
                                            <span class="badge bg-primary">ÁæéËÇ°</span>
                                        {% else %}
                                            <span class="badge bg-success">Ê∏ØËÇ°</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small class="text-muted">{{ stock.industry or 'Êú™Áü•' }}</small>
                                    </td>
                                    <td>
                                        {% if stock.stock_type == 'BUILT_IN' %}
                                            <span class="badge bg-info">ÂÜÖÁΩÆ</span>
                                        {% else %}
                                            <span class="badge bg-warning">Ëá™ÂÆö‰πâ</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if stock.is_watching %}
                                            <button class="btn btn-sm btn-outline-danger watch-btn" 
                                                    data-stock-code="{{ stock.code }}"
                                                    data-action="remove">
                                                <i class="fas fa-bookmark me-1"></i>ÂèñÊ∂àÂÖ≥Ê≥®
                                            </button>
                                        {% else %}
                                            <button class="btn btn-sm btn-outline-success watch-btn" 
                                                    data-stock-code="{{ stock.code }}"
                                                    data-action="add">
                                                <i class="fas fa-bookmark me-1"></i>ÂÖ≥Ê≥®
                                            </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- ÂàÜÈ°µ -->
                    {% if pagination.pages > 1 %}
                    <nav aria-label="ËÇ°Á•®ÂàóË°®ÂàÜÈ°µ" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <!-- ‰∏ä‰∏ÄÈ°µ -->
                            {% if pagination.page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.page-1, market=pagination.market, search=pagination.search) }}" title="‰∏ä‰∏ÄÈ°µ">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-left"></i>
                                    </span>
                                </li>
                            {% endif %}
                            
                            <!-- È°µÁ†Å -->
                            {% set start_page = [1, pagination.page - 2] | max %}
                            {% set end_page = [pagination.pages, pagination.page + 2] | min %}
                            
                            {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=1, market=pagination.market, search=pagination.search) }}">1</a>
                                </li>
                                {% if start_page > 2 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                            {% endif %}
                            
                            {% for p in range(start_page, end_page + 1) %}
                                {% if p == pagination.page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ p }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('stocks.index', page=p, market=pagination.market, search=pagination.search) }}">{{ p }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            {% if end_page < pagination.pages %}
                                {% if end_page < pagination.pages - 1 %}
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.pages, market=pagination.market, search=pagination.search) }}">{{ pagination.pages }}</a>
                                </li>
                            {% endif %}
                            
                            <!-- ‰∏ã‰∏ÄÈ°µ -->
                            {% if pagination.page < pagination.pages %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('stocks.index', page=pagination.page+1, market=pagination.market, search=pagination.search) }}" title="‰∏ã‰∏ÄÈ°µ">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">
                                        <i class="fas fa-chevron-right"></i>
                                    </span>
                                </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-search fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑËÇ°Á•®</h5>
                        <p class="text-muted">ËØ∑Â∞ùËØï‰ΩøÁî®‰∏çÂêåÁöÑÊêúÁ¥¢ÂÖ≥ÈîÆËØçÊàñÂ∏ÇÂú∫Á≠õÈÄâ</p>
                        <a href="{{ url_for('stocks.index') }}" class="btn btn-primary">
                            <i class="fas fa-undo me-2"></i>ËøîÂõûÂÖ®ÈÉ®ËÇ°Á•®
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ÂÖ≥Ê≥®/ÂèñÊ∂àÂÖ≥Ê≥®ÂäüËÉΩ
    $('.watch-btn').click(function() {
        const btn = $(this);
        const stockCode = btn.data('stock-code');
        const action = btn.data('action');
        const isAdding = action === 'add';
        
        // Â¶ÇÊûúÊòØÂèñÊ∂àÂÖ≥Ê≥®ÔºåÈúÄË¶ÅÁ°ÆËÆ§
        if (!isAdding) {
            confirmAction(
                'ÂèñÊ∂àÂÖ≥Ê≥®',
                `Á°ÆÂÆöË¶ÅÂèñÊ∂àÂÖ≥Ê≥® ${stockCode} ÂêóÔºü`,
                function() {
                    performWatchAction(btn, stockCode, action);
                }
            );
        } else {
            performWatchAction(btn, stockCode, action);
        }
    });
    
    // ÊâßË°åÂÖ≥Ê≥®/ÂèñÊ∂àÂÖ≥Ê≥®Êìç‰Ωú
    function performWatchAction(btn, stockCode, action) {
        const isAdding = action === 'add';
        
        // Á¶ÅÁî®ÊåâÈíÆÈò≤Ê≠¢ÈáçÂ§çÁÇπÂáª
        btn.prop('disabled', true);
        
        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Â§ÑÁêÜ‰∏≠...');
        
        // ÂèëÈÄÅAPIËØ∑Ê±Ç
        $.ajax({
            url: `/api/stocks/watchlist/${action}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ stock_code: stockCode }),
            success: function(response) {
                if (response.success) {
                    // Êõ¥Êñ∞ÊåâÈíÆÁä∂ÊÄÅ
                    if (isAdding) {
                        btn.removeClass('btn-outline-success').addClass('btn-outline-danger');
                        btn.data('action', 'remove');
                        btn.html('<i class="fas fa-bookmark me-1"></i>ÂèñÊ∂àÂÖ≥Ê≥®');
                    } else {
                        btn.removeClass('btn-outline-danger').addClass('btn-outline-success');
                        btn.data('action', 'add');
                        btn.html('<i class="fas fa-bookmark me-1"></i>ÂÖ≥Ê≥®');
                    }
                    
                    // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                    showToast('success', response.message);
                    
                    // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
                    updateWatchlistSummary();
                } else {
                    showToast('error', response.message || 'Êìç‰ΩúÂ§±Ë¥•');
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showToast('error', response?.message || 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            },
            complete: function() {
                btn.prop('disabled', false);
            }
        });
    }
    
    // ÊêúÁ¥¢Ë°®ÂçïÊèê‰∫§
    $('#searchForm').submit(function(e) {
        const searchValue = $('#stockSearch').val().trim();
        const marketValue = $('#marketFilter').val();
        
        // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫‰∏îÊ≤°ÊúâÈÄâÊã©Â∏ÇÂú∫ÔºåÊ∏ÖÈô§ÊâÄÊúâÂèÇÊï∞Âπ∂Ë∑≥ËΩ¨Âà∞Âü∫Á°ÄÈ°µÈù¢
        if (!searchValue && !marketValue) {
            e.preventDefault();
            window.location.href = "{{ url_for('stocks.index') }}";
            return false;
        }
        
        // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫‰ΩÜÈÄâÊã©‰∫ÜÂ∏ÇÂú∫ÔºåÊ∏ÖÈô§ÊêúÁ¥¢ÂèÇÊï∞
        if (!searchValue && marketValue) {
            $('#stockSearch').val('');
        }
    });
    
    // Ê∑ªÂä†Ê∏ÖÁ©∫ÊêúÁ¥¢ÁöÑÂäüËÉΩ
    $('#stockSearch').on('input', function() {
        const searchValue = $(this).val().trim();
        const marketValue = $('#marketFilter').val();
        
        // Â¶ÇÊûúÊêúÁ¥¢Ê°ÜË¢´Ê∏ÖÁ©∫‰∏îÊ≤°ÊúâÈÄâÊã©Â∏ÇÂú∫ÔºåËá™Âä®Ë∑≥ËΩ¨Âà∞Âü∫Á°ÄÈ°µÈù¢
        if (!searchValue && !marketValue) {
            // Âª∂ËøüÊâßË°åÔºåÈÅøÂÖçÁî®Êà∑Ê≠£Âú®ËæìÂÖ•Êó∂Ë∑≥ËΩ¨
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(function() {
                window.location.href = "{{ url_for('stocks.index') }}";
            }, 1000);
        }
    });
    
    // Â∏ÇÂú∫Á≠õÈÄâÂèòÂåñÊó∂‰πüÂ§ÑÁêÜÊêúÁ¥¢Ê°Ü
    $('#marketFilter').on('change', function() {
        const searchValue = $('#stockSearch').val().trim();
        const marketValue = $(this).val();
        
        // Â¶ÇÊûúÊêúÁ¥¢Ê°Ü‰∏∫Á©∫‰∏îÊ≤°ÊúâÈÄâÊã©Â∏ÇÂú∫ÔºåË∑≥ËΩ¨Âà∞Âü∫Á°ÄÈ°µÈù¢
        if (!searchValue && !marketValue) {
            window.location.href = "{{ url_for('stocks.index') }}";
        }
    });

    // Ê∏ÖÁ©∫ÊêúÁ¥¢ÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
    $('#clearSearchBtn').click(function() {
        $('#stockSearch').val('').trigger('input'); // Ê∏ÖÁ©∫ËæìÂÖ•Ê°ÜÂπ∂Ëß¶Âèëinput‰∫ã‰ª∂
        $('#marketFilter').val('').trigger('change'); // Ê∏ÖÁ©∫Â∏ÇÂú∫Á≠õÈÄâÂπ∂Ëß¶Âèëchange‰∫ã‰ª∂
        $('#searchForm').submit(); // Êèê‰∫§Ë°®Âçï
    });
    
    // Êõ¥Êñ∞ÂÖ≥Ê≥®ÂàóË°®ÁªüËÆ°‰ø°ÊÅØ
    function updateWatchlistSummary() {
        $.get('/api/stocks/watchlist', function(response) {
            if (response.success) {
                // ËøôÈáåÂèØ‰ª•Êõ¥Êñ∞È°µÈù¢‰∏äÁöÑÁªüËÆ°‰ø°ÊÅØ
                // ÊöÇÊó∂ÁÆÄÂçïÂà∑Êñ∞È°µÈù¢
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        });
    }
    
    // ÊòæÁ§∫Ê∂àÊÅØÊèêÁ§∫
    function showToast(type, message) {
        const toastClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
        
        const toast = $(`
            <div class="alert ${toastClass} alert-dismissible fade show position-fixed" 
                 style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                <i class="fas ${icon} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        
        $('body').append(toast);
        
        // Ëá™Âä®Ê∂àÂ§±
        setTimeout(function() {
            toast.alert('close');
        }, 3000);
    }
});
</script>
{% endblock %}
