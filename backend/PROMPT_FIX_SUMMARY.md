# 提示词覆盖问题修复总结

## 🐛 问题描述

在LLM Provider的实现中，发现了一些Provider会硬编码固定的提示词，从而覆盖用户传入的提示词，这导致：

1. **用户无法控制分析内容**：用户精心设计的提示词被系统硬编码的提示词覆盖
2. **分析结果不符合预期**：系统总是按照固定的模板进行分析，而不是按照用户的需求
3. **灵活性降低**：无法支持不同类型的技术分析和基本面分析

## 🔍 发现的问题

### 1. QwenProvider - 深度研究模型
**位置**: `_handle_deep_research_model` 方法
**问题**: 硬编码了一个固定的研究提示词，完全覆盖了用户传入的提示词

**修复前**:
```python
# 构建研究提示词
research_prompt = f"""请对股票 {stock_info.get('name', '')} ({stock_info.get('code', '')}) 进行极其深入、详细、专业的投资分析。

研究目标：生成一份机构级别的专业投资分析报告，内容必须非常详细（至少3000-5000字），包含大量具体数据、专业术语和深度分析。

分析维度：
1. 公司概况与商业模式深度分析
2. 财务健康度与盈利能力量化评估
3. 行业地位与竞争优势分析
4. 技术面分析与市场情绪评估
5. 风险评估与不确定性分析
6. 投资建议与操作策略
7. 风险提示与免责声明

分析要求：
- 使用专业的金融分析框架和方法论
- 包含定量分析和定性分析
- 提供具体的投资建议和操作策略
- 使用大量专业术语和数据支撑
- 报告结构清晰，逻辑严密

请基于以下信息进行深入分析：
{formatted_prompt}

请在反问确认阶段就提供详细的分析框架和关键问题，然后在研究阶段生成极其详细、专业的投资分析报告。"""
```

**修复后**:
```python
# 直接使用用户传入的提示词，不进行任何修改
# 这样用户可以完全控制分析的内容和方向
logger.info(f"使用qwen-deep-research模型，直接使用用户提示词")

api_params = {
    'model': self.model,
    'messages': [{'role': 'user', 'content': formatted_prompt}],
    'stream': True,
    'parameters': {
        'max_tokens': 15000,
        'temperature': 0.7
    }
}
```

### 2. DeepSeekProvider - 系统消息覆盖
**位置**: `_make_api_request` 方法
**问题**: 硬编码了系统消息，覆盖了用户提示词的内容

**修复前**:
```python
data = {
    "model": self.model,
    "messages": [
        {"role": "system", "content": "你是一个专业的股票分析师，请根据提供的信息进行专业的股票分析。请深入思考，提供详细的分析和投资建议。"},
        {"role": "user", "content": formatted_prompt}
    ],
    "max_tokens": self.max_tokens,
    "temperature": self.temperature
}

# 如果启用深度思考，添加相关参数
if self.enable_deep_thinking:
    data["messages"][0]["content"] = "你是一个专业的股票分析师，请根据提供的信息进行专业的股票分析。请深入思考，进行多步推理，提供详细的分析和投资建议。"
```

**修复后**:
```python
# 基础请求数据 - 直接使用用户传入的提示词，不添加系统消息
# 这样用户可以完全控制分析的内容和方向
data = {
    "model": self.model,
    "messages": [
        {"role": "user", "content": formatted_prompt}
    ],
    "max_tokens": self.max_tokens,
    "temperature": self.temperature
}

# 如果启用深度思考，在用户消息前添加简短的提示
if self.enable_deep_thinking:
    # 只在用户消息前添加简短的深度思考提示，不覆盖用户内容
    data["messages"][0]["content"] = f"请深入思考，进行多步推理分析。\n\n{formatted_prompt}"
```

## ✅ 修复效果

### 1. 完全尊重用户提示词
- 所有Provider现在都直接使用用户传入的提示词
- 不再有硬编码的提示词覆盖用户内容
- 用户可以完全控制分析的方向和内容

### 2. 支持不同类型的分析
- **技术分析**: 用户可以使用技术分析的提示词
- **基本面分析**: 用户可以使用基本面分析的提示词
- **自定义分析**: 用户可以使用任何自定义的提示词

### 3. 保持功能完整性
- 深度思考功能仍然可用，但不会覆盖用户内容
- 全网搜索功能仍然可用
- 所有其他功能保持不变

## 🔧 技术实现

### 修复原则
1. **用户优先**: 用户传入的提示词具有最高优先级
2. **最小干预**: 只在必要时添加简短的提示，不覆盖用户内容
3. **功能保持**: 保持所有现有功能正常工作

### 具体修改
1. **QwenProvider深度研究模型**: 完全移除硬编码提示词，直接使用用户提示词
2. **DeepSeekProvider**: 移除系统消息，只在深度思考模式下在用户消息前添加简短提示
3. **GeminiProvider**: 原本就没有问题，保持不变
4. **QwenProvider标准模型**: 原本就没有问题，保持不变

## 🎯 使用示例

### 技术分析提示词
用户现在可以使用专门的技术分析提示词：
```
请对股票AAPL进行技术分析，重点关注：
1. 价格趋势和支撑阻力位
2. 技术指标分析（RSI、MACD、布林带）
3. 成交量分析
4. 短期和中期交易建议
```

### 基本面分析提示词
用户也可以使用基本面分析提示词：
```
请对股票AAPL进行基本面分析，重点关注：
1. 公司财务状况
2. 行业地位和竞争优势
3. 估值分析
4. 长期投资价值评估
```

## 📈 影响评估

### 正面影响
- ✅ 用户完全控制分析内容
- ✅ 支持多种分析类型
- ✅ 提高系统灵活性
- ✅ 保持所有现有功能

### 风险评估
- ⚠️ 用户需要提供完整的提示词
- ⚠️ 如果用户提示词不完整，可能影响分析质量

### 缓解措施
- 在文档中提供示例提示词
- 在UI中提供提示词模板选择
- 保持现有的提示词管理系统

## 🎉 总结

通过这次修复，我们解决了LLM Provider中提示词覆盖的问题，现在：

1. **用户提示词得到完全尊重**
2. **支持多种分析类型**
3. **保持所有现有功能**
4. **提高系统灵活性**

这为用户提供了更大的控制权，同时保持了系统的稳定性和功能完整性。
