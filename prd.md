
# **项目需求文档 (PRD): “智策股析” - 每日股价分析与决策平台**

**版本:** 1.1
**日期:** 2025年8月18日

## **修订历史**

  * **v1.0 (2025-08-18):** 初始版本创建。
  * **v1.1 (2025-08-18):**
      * **登录系统:** 修改为无密码的邮箱验证码登录。
      * **技术栈:** 明确后端使用 Flask 框架。
      * **商业模式:** 增加试用机制和付费订阅/按次付费模式的规划。
      * **性能与可靠性:** 明确引入异步任务队列（如 Celery）及失败重试机制。
      * **架构:** 强调并具体化了LLM模型的可扩展架构设计。
  * **v1.2 (2025-08-23):**
      * **股票列表功能:** 完成股票池管理、关注列表、自定义股票添加功能。
      * **用户交互优化:** 统一确认弹窗交互体验，美化UI界面。
      * **时区处理:** 修复关注时间显示时区问题，支持UTC+8本地时间。
      * **一键清空:** 实现关注列表一键清空功能。
      * **代码清理:** 移除不必要的测试文件和调试代码。

-----

## **1.0 项目概述**

### **1.1 项目简介**

“智策股析” 是一个面向个人投资者的多用户Web应用。它旨在通过集成先进的大语言模型（LLM）能力，为用户提供每日、深入、自动化的港股及美股分析报告。用户可以自定义关注的股票列表，系统将每日生成技术面与基本面分析，并通过网页、邮件等方式触达用户，辅助其投资决策。

### **1.2 项目目标**

  * **自动化分析:** 解放用户每日研究股票的时间，提供由AI生成的、高质量的分析报告。
  * **个性化服务:** 用户可自由选择和添加关注的股票，获得专属的分析内容。
  * **多模型支持:** 打造一个灵活的、可扩展的分析引擎，支持集成多种主流大语言模型。
  * **用户友好:** 提供美观、简洁、响应式的用户界面，优化在桌面和移动设备上的使用体验。
  * **社区与粘性:** 通过邮件订阅和便捷的报告管理，提升用户活跃度和产品粘性。

### **1.3 目标用户**

  * 关注港股、美股的个人投资者。
  * 希望利用AI工具提升投研效率的金融爱好者。
  * 时间有限，需要自动化工具来跟踪股票动态的上班族。

-----

## **2.0 系统核心功能需求 (Functional Requirements)**

### **2.1 用户系统 (无密码认证)**

  * **2.1.1 用户注册/登录流程:**
      * 系统不再设独立的注册和登录页面，统一为一个入口。
      * 用户在输入框中输入自己的电子邮箱地址，点击“登录/注册”。
      * **新用户:** 如果邮箱未在系统中注册，系统将自动为其创建账户。
      * **发送验证码:** 系统向该邮箱发送一封包含 **6位数字临时验证码** 的邮件，验证码有效期为10分钟。
      * **验证登录:** 用户在页面上输入收到的验证码，验证成功后，系统为其创建会话（Session），用户登录成功。
  * **2.1.2 用户资料:**
      * 用户首次登录后，可引导其设置一个昵称。
      * 用户的唯一标识是其电子邮箱地址。

### **2.2 股票池管理**

  * **2.2.1 内置股票池:**
      * 系统内置两个不可由普通用户修改的列表：
          * **美股市值TOP 100:** 包含公司名称、股票代码（如 `AAPL`）、所属交易所（如 `NASDAQ`）。
          * **港股市值TOP 100:** 包含公司名称、股票代码（如 `00700.HK`）、所属交易所（`HKEX`）。
      * 这两个列表应由管理员在后台进行维护和更新。
  * **2.2.2 用户自定义股票:**
      * 用户可以在自己的账户中添加新的股票。
      * 添加时需要提交三个字段：
        1.  **市场:** 下拉选择（美股 / 港股）。
        2.  **公司名称:** 文本输入（如 `苹果公司`）。
        3.  **股票代码:** 文本输入（如 `AAPL`）。
      * 系统应对用户添加的股票进行简单的去重校验。
  * **2.2.3 用户关注列表 (Watchlist):**
      * 每个注册用户拥有一个独立的关注列表。
      * 用户可以从 **“内置股票池”** 和 **“用户自定义股票池”** 的合集中，选择最多 **20** 支股票加入到自己的关注列表。
      * 用户可以随时在关注列表中添加或删除股票，但上限为20支。
      * 该列表是后续AI分析的目标集合。

### **2.3 AI分析引擎**

  * **2.3.1 每日定时任务:**
      * 系统需设定一个每日定时任务（如：每日凌晨4点，美股收盘后）。
      * 任务触发后，系统会遍历所有用户的关注列表，并获取当天需要分析的、唯一的股票清单。
  * **2.3.2 大模型调用:**
      * 对于清单中的每一支股票，系统自动调用一个或多个大语言模型（LLM）的API。
      * **可扩展模型架构:** 系统设计上应支持多种LLM，通过配置文件或后台设置进行切换和选择。初期支持 Gemini, Qwen, ChatGPT。
      * **Prompt (提示词) 管理:**
          * 管理员可以在后台维护多套不同的分析Prompt模板。
          * 例如，“技术分析模板”、“基本面分析模板”、“综合决策模板”等。
          * 每日任务可以配置使用哪一套Prompt。
          * Prompt中应支持变量替换，例如 `${股票代码}`, `${公司名称}`, `${近期新闻}` 等，以便动态生成请求。
  * **2.3.3 分析内容:**
      * LLM生成的分析报告应包含（但不限于）以下方面，具体内容由Prompt定义：
          * **技术分析:** 关键支撑位/阻力位、均线系统（MA）、MACD、RSI等指标解读、近期K线形态分析等。
          * **基本面分析:** 公司近期财报亮点、新闻舆情、行业动态、估值水平等。
      * 报告内容为 **Markdown** 格式。
  * **2.3.4 结果存储:**
      * **存储方式:** 使用 JSON 文本文件，暂时不使用数据库。
      * **文件结构 (建议):**
        ```
        /data/reports/
        ├── YYYY-MM-DD/
        │   ├── {stock_code_1}.json
        │   ├── {stock_code_2}.json
        │   └── ...
        └── YYYY-MM-DD_next/
            ├── ...
        ```
      * **JSON 文件内容结构 (示例):**
        ```json
        {
          "stockCode": "AAPL",
          "companyName": "Apple Inc.",
          "market": "US",
          "industry": "Technology",
          "analysisDate": "YYYY-MM-DD",
          "promptVersion": "v1.2",
          "llmModel": "gemini-pro",
          "reportContent": "# Apple Inc. (AAPL) 每日分析报告...",
          "reportSummary": "苹果股价今日小幅上涨，技术指标显示..."
        }
        ```
  * **2.3.5 异步任务队列与可靠性:**
      * **任务队列:** 所有调用大模型的分析任务都必须通过**异步任务队列**（如 Celery）进行处理。用户提交分析请求后，前端应立即收到“任务已提交，正在分析中”的响应，而不是等待分析完成。
      * **任务状态管理:** 系统需要维护每个分析任务的状态，至少包括：`等待中(Pending)`、`处理中(Processing)`、`成功(Success)`、`失败(Failed)`。用户可在前端看到自己关注股票的分析任务状态。
      * **失败与重试:** 如果某个股票的分析任务失败，系统应记录失败原因，并自动进行**重试**。建议采用指数退避策略，例如重试3次。若最终仍然失败，则将任务状态标记为`失败`，并可在后台日志中告警。
  * **2.3.6 可扩展的LLM集成架构:**
      * 系统后端应采用**策略模式 (Strategy Pattern)** 来设计LLM的调用逻辑。
      * **定义统一接口:** 创建一个所有LLM Provider都需要遵循的抽象基类或接口，例如 `BaseLLMProvider`，其中包含一个标准方法，如 `generate_analysis(prompt: str) -> str`。
      * **具体实现:** 为每一种大模型创建一个具体的实现类，如 `GeminiProvider`, `QwenProvider`, `OpenAIProvider`，它们都继承自 `BaseLLMProvider` 并实现 `generate_analysis` 方法。
      * **动态调用:** 在配置文件或管理员后台中，可以轻松指定当前要使用的LLM Provider。当需要新增模型时，只需添加一个新的实现类并在配置中注册即可。

### **2.4 报告查询与展示**

  * **2.4.1 报告列表页:**
      * 用户登录后，可以看到一个属于自己的报告中心。
      * 默认展示其关注列表内所有股票最新一天的分析报告。
  * **2.4.2 查询与筛选:**
      * 提供以下维度的查询和筛选功能：
          * **按日期:** 提供日期选择器，查看历史报告。
          * **按公司:** 直接搜索公司名称或股票代码。
          * **按行业:** 提供行业分类标签进行筛选。
  * **2.4.3 报告详情页:**
      * 点击任意报告条目，进入详情页。
      * 页面需能正确渲染 **Markdown** 格式的报告内容。

### **2.5 报告导出**

  * **2.5.1 单个导出:** 在报告详情页，提供“导出”按钮，可将当前报告导出为 `.md` 文件或 `.pdf` 文件。
  * **2.5.2 批量导出:** 在报告列表页，允许用户勾选多个报告，然后点击“批量导出”，将所有选中的报告打包成一个 `.zip` 文件下载。

### **2.6 邮件订阅服务**

  * **2.6.1 订阅开关:** 用户可以在个人设置中开启或关闭“每日分析报告邮件订阅”。
  * **2.6.2 邮件发送:**
      * 当每日分析任务完成后，系统向所有开启订阅的用户发送邮件。
      * **邮件内容:**
          * 标题: `【智策股析】您关注的股票本日分析报告已生成 (YYYY-MM-DD)`
          * 正文: 包含用户关注的每支股票的**报告摘要 (Summary)**。
          * 提供一个醒目的\*\*“查看完整报告”\*\*按钮或链接，引导用户回到网站对应的报告页面。

### **2.7 管理员后台功能**

  * **2.7.1 管理员登录:** 独立的管理员登录入口。
  * **2.7.2 用户管理:**
      * 查看所有注册用户列表。
      * 可以进行用户禁用/启用操作。
  * **2.7.3 内置股票管理:**
      * 可以更新（增、删、改）“美股市值TOP 100”和“港股市值TOP 100”的股票列表。
  * **2.7.4 Prompt (提示词) 管理:**
      * 提供一个文本编辑界面，可以创建、查看、编辑和删除不同的Prompt模板。
      * 可以设定一个“默认”或“当前使用”的Prompt，供每日任务调用。

### **2.8 订阅、付费与试用模式**

  * **2.8.1 用户计划 (User Plans):** 系统需定义多种用户计划。
      * **试用计划 (Trial):** 新用户在选定自己的股票关注列表后，将自动获得一次**免费生成完整报告**的机会（针对其选择的最多20支股票）。
      * **免费计划 (Free):** 试用结束后，用户自动转为免费计划。免费用户可能无法生成新的报告，或每天只能生成1支股票的报告。
      * **订阅计划 (Subscription):**
          * 提供按月或按年付费。
          * 订阅用户在有效期内，可以享受全部功能。
      * **按次付费计划 (Pay-per-use):**
          * 用户可以购买“分析次数包”，例如 50次/200次。
          * 每分析一支股票，消耗一次额度。
  * **2.8.2 功能限制 (Feature Gating):**
      * 系统的各项核心功能需与用户的当前计划进行绑定。
      * 在执行操作前，后端需校验用户的权限和额度。
  * **2.8.3 支付集成:**
      * 系统需集成第三方支付网关（如 Stripe, Paddle），处理订阅和购买流程。
      * 需要有清晰的定价页面和用户账单管理界面。

-----

## **3.0 非功能性需求 (Non-Functional Requirements)**

### **3.1 UI/UX 设计**

  * **3.1.1 视觉风格:** 整体风格追求**科技感、现代、简洁**。可考虑使用暗色主题 (Dark Mode) 为主，搭配清晰、专业的数据图表元素。
  * **3.1.2 响应式设计:** 网站必须是响应式的，能够在桌面浏览器、平板和主流手机上都有良好的浏览和操作体验。
  * **3.1.3 交互体验:** 页面加载速度要快，交互动画要流畅自然，避免用户长时间等待。

### **3.2 性能与可靠性**

  * **3.2.1 报告生成:** 所有耗时操作（LLM调用、数据获取）必须通过 **第2.3.5节** 中定义的异步任务队列来完成，保证前端请求的快速响应。
  * **3.2.2 页面响应:** 报告列表页和详情页的加载时间应在3秒以内。

### **3.3 安全需求**

  * **3.3.1 数据安全:** 确保验证码生成和验证过程的安全性，防止暴力破解。敏感的API Key等信息必须通过环境变量安全管理。
  * **3.3.2 访问控制:** 严格区分普通用户和管理员权限。用户只能访问自己的数据和报告。

### **3.4 扩展性与维护性**

  * **3.4.1 模块化设计:** 前后端代码应采用模块化设计，便于未来功能的扩展。
  * **3.4.2 LLM接口封装:** 严格遵循 **第2.3.6节** 中定义的可扩展架构。
  * **3.4.3 外部API:** 接入外部API（金融数据、邮件、支付）的逻辑应封装，便于替换。

-----

## **4.0 技术栈与环境建议**

  * **开发工具:** **Cursor**。
  * **后端:**
      * **框架:** **Flask**。建议使用Flask构建RESTful API，实现前后端分离。
      * **异步任务队列:** **Celery**。
      * **消息中间件 (Broker for Celery):** **Redis** 或 **RabbitMQ**。
  * **前端:**
      * **推荐方案 (前后端分离):** 使用现代JavaScript框架，如 **React (Next.js)** 或 **Vue (Nuxt.js)**。
      * **备选方案 (传统模式):** 使用 Flask 自带的 Jinja2 模板引擎。
  * **数据存储:**
      * **报告:** 文件系统 (JSON文件)。
      * **用户信息/订阅状态/任务状态:** 建议使用数据库。**SQLite** 适合初期开发，**PostgreSQL** 是生产环境的选择。
  * **邮件服务:** SendGrid, Mailgun, AWS SES 等。
  * **支付网关:** Stripe, Paddle 等。
  * **数据源 (金融):** Alpha Vantage, Finnhub, IEX Cloud 等。

-----

## **5.0 开发里程碑建议 (Milestones)**

1.  **第一阶段 (MVP - 核心功能验证):**

      * 完成**无密码邮箱验证码登录**系统。
      * 实现股票池和用户20支股票选择功能。
      * 实现**单次试用**逻辑：让新用户可以完整体验一次报告生成。
      * 后端集成Celery和Redis，实现**异步分析任务**，并能够将结果存为JSON。
      * 完成基本的报告渲染页面。
      * **目标:** 验证从用户登录到获得一次完整分析报告的核心流程，并搭建好健壮的异步架构基础。

2.  **第二阶段 (付费模式与后台完善):**

      * 集成支付网关，完成**订阅计划**和**按次付费**的后端逻辑。
      * 根据用户计划实现功能限制。
      * 完成完整的管理员后台，包括用户管理、股票池管理和 **Prompt管理**。
      * 实现任务队列的**状态跟踪和失败重试**机制。
      * **目标:** 让产品具备商业化能力，并为运营提供强大的后台支持。

3.  **第三阶段 (体验优化与功能扩展):**

      * 开发邮件订阅系统。
      * 实现报告的导出功能。
      * 按照 **2.3.6** 的设计，至少集成2种以上的大模型，并提供切换选项。
      * 重点进行UI/UX打磨，优化移动端体验。
      * **目标:** 提升产品竞争力和用户体验。

4.  **第四阶段 (部署与迭代):**

      * 进行线上部署、压力测试。
      * 根据用户反馈进行功能迭代和优化。